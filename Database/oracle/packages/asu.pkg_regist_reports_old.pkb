DROP PACKAGE BODY ASU.PKG_REGIST_REPORTS_OLD
/

--
-- PKG_REGIST_REPORTS_OLD  (Package Body) 
--
CREATE OR REPLACE PACKAGE BODY ASU."PKG_REGIST_REPORTS_OLD" IS
  FUNCTION RETURN_VALUE (nValue IN NUMBER) RETURN VARCHAR IS
    cValue VARCHAR(15);
  BEGIN
    if (nValue is NULL) or (nValue = 0) then cValue:='&nbsp;';
    else cValue:=TO_CHAR(nValue);
    end if;
    RETURN cValue;
  END;
  FUNCTION RETURN_VALUE (cValue IN VARCHAR) RETURN VARCHAR IS
  BEGIN
    if (cValue is NULL) or (cValue = '0')
    then
      RETURN '&nbsp;';
    else
      RETURN cValue;
    end if;
  END;
  PROCEDURE FILL_VID IS
  BEGIN
    FOR p IN cVid LOOP
      vids (cVid%ROWCOUNT)  := p;
    END LOOP;
  END;
  FUNCTION GET_COUNT_INCOME_PERIOD_SKK (pFD_DATA1 IN DATE, pFD_DATA2 IN DATE, pFL_SKK IN NUMBER)
    RETURN NUMBER IS
    CURSOR c IS
      SELECT/*+first_row*/
         COUNT (FK_ID)
        FROM TSROKY
       WHERE FK_PRYB = 2
         AND FD_DATA1 BETWEEN pFD_DATA1 AND pFD_DATA2+1-1/(24*60)
         AND GET_PAC_SKK (FK_PACID) = pFL_SKK;
    i NUMBER;
  BEGIN
    IF c%ISOPEN THEN
      CLOSE c;
    END IF;
    OPEN c;
    FETCH c INTO i;
    CLOSE c;
    RETURN i;
  END;
  FUNCTION GET_COUNT_INCOME_PERIOD_SEO (pFD_DATA1 IN DATE, pFD_DATA2 IN DATE, pFL_SEO IN NUMBER)
    RETURN NUMBER IS
    CURSOR c IS
      SELECT/*+first_row*/
         COUNT (FK_ID)
        FROM TSROKY
       WHERE FK_PRYB = 2
         AND FD_DATA1 BETWEEN pFD_DATA1 AND pFD_DATA2+1-1/(24*60)
         AND GET_PAC_SEO (FK_PACID) = pFL_SEO;
    i NUMBER;
  BEGIN
    IF c%ISOPEN THEN
      CLOSE c;
    END IF;
    OPEN c;
    FETCH c INTO i;
    CLOSE c;
    RETURN i;
  END;
  FUNCTION GET_COUNT_EARLY (pFD_DATA1 IN DATE, pFD_DATA2 IN DATE)
    RETURN NUMBER IS
    CURSOR c (pData1 DATE, pData2 DATE) IS
      SELECT COUNT (fk_id)
        FROM tsroky
       WHERE fk_pryb = 3
         AND fn_kol > 0
         AND fd_data1 BETWEEN pData1 AND pData2+1-1/(24*60);
    i NUMBER;
  BEGIN
    OPEN c (pFD_DATA1, pFD_DATA2);
    FETCH c INTO i;
    CLOSE c;
    RETURN i;
  END;
  FUNCTION GET_COUNT_VOZR (pFD_DATA1 IN DATE, pFD_DATA2 IN DATE, pFN_VOZR IN NUMBER, pFL_BIGGER IN NUMBER)
    RETURN NUMBER IS
    CURSOR c IS
      SELECT COUNT (FK_ID)
        FROM TSROKY
       WHERE FD_DATA1 BETWEEN pFD_DATA1 AND pFD_DATA2+1-1/(24*60)
         AND FK_PRYB = 2
         AND GET_PACVOZR (FK_PACID) >= pFN_VOZR;
    CURSOR c1 IS
      SELECT COUNT (FK_ID)
        FROM TSROKY
       WHERE FD_DATA1 BETWEEN pFD_DATA1 AND pFD_DATA2+1-1/(24*60)
         AND FK_PRYB = 2
         AND GET_PACVOZR (FK_PACID) < pFN_VOZR;
    i NUMBER;
  BEGIN
    IF pFL_BIGGER = 1 THEN
      OPEN c;
      FETCH C INTO i;
      CLOSE c;
    ELSE
      OPEN c1;
      FETCH C1 INTO i;
      CLOSE c1;
    END IF;
    RETURN i;
  END;
  FUNCTION GET_COUNT_VOZR (pFD_DATA1 IN DATE, pFD_DATA2 IN DATE, pFN_VOZR IN NUMBER, pFL_BIGGER IN NUMBER, pFL_SKK IN NUMBER)
    RETURN NUMBER IS
    CURSOR c IS
      SELECT COUNT (FK_ID)
        FROM TSROKY
       WHERE FD_DATA1 BETWEEN pFD_DATA1 AND pFD_DATA2+1-1/(24*60)
         AND FK_PRYB = 2
         AND GET_PACVOZR (FK_PACID) >= pFN_VOZR
         AND GET_PAC_SKK (FK_PACID) = pFL_SKK;
    CURSOR c1 IS
      SELECT COUNT (FK_ID)
        FROM TSROKY
       WHERE FD_DATA1 BETWEEN pFD_DATA1 AND pFD_DATA2+1-1/(24*60)
         AND FK_PRYB = 2
         AND GET_PACVOZR (FK_PACID) < pFN_VOZR
         AND GET_PAC_SKK (FK_PACID) = pFL_SKK;
    i NUMBER;
  BEGIN
    IF pFL_BIGGER = 1 THEN
      OPEN c;
      FETCH C INTO i;
      CLOSE c;
    ELSE
      OPEN c1;
      FETCH C1 INTO i;
      CLOSE c1;
    END IF;
    RETURN i;
  END;
  FUNCTION GET_COUNT_VOZR_SEO (pFD_DATA1 IN DATE, pFD_DATA2 IN DATE, pFN_VOZR IN NUMBER, pFL_BIGGER IN NUMBER, pFL_SEO IN NUMBER)
    RETURN NUMBER IS
    CURSOR c IS
      SELECT COUNT (FK_ID)
        FROM TSROKY
       WHERE FD_DATA1 BETWEEN pFD_DATA1 AND pFD_DATA2+1-1/(24*60)
         AND FK_PRYB = 2
         AND GET_PACVOZR (FK_PACID) >= pFN_VOZR
         AND GET_PAC_SEO (FK_PACID) = pFL_SEO;
    CURSOR c1 IS
      SELECT COUNT (FK_ID)
        FROM TSROKY
       WHERE FD_DATA1 BETWEEN pFD_DATA1 AND pFD_DATA2+1-1/(24*60)
         AND FK_PRYB = 2
         AND GET_PACVOZR (FK_PACID) < pFN_VOZR
         AND GET_PAC_SEO (FK_PACID) = pFL_SEO;
    i NUMBER;
  BEGIN
    IF pFL_BIGGER = 1 THEN
      OPEN c;
      FETCH C INTO i;
      CLOSE c;
    ELSE
      OPEN c1;
      FETCH C1 INTO i;
      CLOSE c1;
    END IF;
    RETURN i;
  END;
  FUNCTION GET_COUNT_PRODL (pFD_DATA1 IN DATE, pFD_DATA2 IN DATE)
    RETURN NUMBER IS
    CURSOR c (pData1 DATE, pData2 DATE) IS
      SELECT COUNT (distinct fk_pacid)
        FROM tsroky
       WHERE fd_data1 BETWEEN pData1 AND pData2+1-1/(24*60)
         AND fk_pryb IN (5, 6);
    i NUMBER;
  BEGIN
    OPEN c (pFD_DATA1, pFD_DATA2);
    FETCH c INTO i;
    CLOSE c;
    RETURN i;
  END;
  FUNCTION GET_COUNTV_PRODL (pFD_DATA1 IN DATE, pFD_DATA2 IN DATE)
    RETURN NUMBER IS
    CURSOR c (pData1 DATE, pData2 DATE) IS
      SELECT COUNT (distinct fk_pacid)
        FROM tsroky
       WHERE fd_data1 BETWEEN pData1 AND pData2+1-1/(24*60)
         AND GET_PACOUTCOME (FK_PACID) IS NOT NULL
         AND fk_pryb IN (5, 6);
    i NUMBER;
  BEGIN
    OPEN c (pFD_DATA1, pFD_DATA2);
    FETCH c INTO i;
    CLOSE c;
    RETURN i;
  END;
  FUNCTION GET_COUNT_PRODL (pFD_DATA1 IN DATE, pFD_DATA2 IN DATE, pFK_PRYB IN NUMBER)
    RETURN NUMBER IS
    CURSOR c (pData1 DATE, pData2 DATE) IS
      SELECT COUNT (distinct fk_pacid)
        FROM tsroky
       WHERE fd_data1 BETWEEN pData1 AND pData2+1-1/(24*60)
         AND fk_pryb = pFK_PRYB;
    i NUMBER;
  BEGIN
    OPEN c (pFD_DATA1, pFD_DATA2);
    FETCH c INTO i;
    CLOSE c;
    RETURN i;
  END;
  FUNCTION GET_COUNTV_PRODL (pFD_DATA1 IN DATE, pFD_DATA2 IN DATE, pFK_PRYB IN NUMBER)
    RETURN NUMBER IS
    CURSOR c (pData1 DATE, pData2 DATE) IS
      SELECT COUNT (distinct fk_pacid)
        FROM tsroky
       WHERE fd_data1 BETWEEN pData1 AND pData2+1-1/(24*60)
         AND GET_PACOUTCOME (FK_PACID) IS NOT NULL
         AND fk_pryb = pFK_PRYB;
    i NUMBER;
  BEGIN
    OPEN c (pFD_DATA1, pFD_DATA2);
    FETCH c INTO i;
    CLOSE c;
    RETURN i;
  END;
  FUNCTION GET_COUNT_OPOZD (pFD_DATA1 IN DATE, pFD_DATA2 IN DATE)
    RETURN NUMBER IS
    CURSOR c (pData1 DATE, pData2 DATE) IS
      SELECT/*+rule*/ COUNT (DISTINCT T2.FK_PACID)
        FROM TSROKY T1, TSROKY T2
       WHERE T1.FK_PACID = T2.FK_PACID
         AND T2.FD_DATA1 BETWEEN pData1 AND pData2+1-1/(24*60)
         AND T2.FK_PRYB = 2
         AND T1.FD_DATA1 < T2.FD_DATA1;
    i NUMBER;
  BEGIN
    OPEN c (pFD_DATA1, pFD_DATA2);
    FETCH c INTO i;
    CLOSE c;
    RETURN i;
  END;
  FUNCTION GET_COUNTV_OPOZD (pFD_DATA1 IN DATE, pFD_DATA2 IN DATE)
    RETURN NUMBER IS
    CURSOR c (pData1 DATE, pData2 DATE) IS
      SELECT/*+rule*/ COUNT (DISTINCT T2.FK_PACID)
        FROM TSROKY T1, TSROKY T2
       WHERE T1.FK_PACID = T2.FK_PACID
         AND T2.FD_DATA1 BETWEEN pData1 AND pData2+1-1/(24*60)
         AND T2.FK_PRYB = 2
         AND GET_PACOUTCOME (T2.FK_PACID) IS NOT NULL
         AND T1.FD_DATA1 < T2.FD_DATA1;
    i NUMBER;
  BEGIN
    OPEN c (pFD_DATA1, pFD_DATA2);
    FETCH c INTO i;
    CLOSE c;
    RETURN i;
  END;
  FUNCTION GET_KDNV_OPOZD (pFD_DATA1 IN DATE, pFD_DATA2 IN DATE)
    RETURN NUMBER IS
    CURSOR c (pData1 DATE, pData2 DATE) IS
      SELECT/*+rule*/ SUM (T1.FN_KOL - T2.FN_KOL)
        FROM TSROKY T1, TSROKY T2
       WHERE T1.FK_PACID = T2.FK_PACID
         AND T2.FD_DATA1 BETWEEN pData1 AND pData2+1-1/(24*60)
         AND T2.FK_PRYB = 2
         AND GET_PACOUTCOME (T2.FK_PACID) IS NOT NULL
         AND T1.FD_DATA1 < T2.FD_DATA1;
    i NUMBER;
  BEGIN
    OPEN c (pFD_DATA1, pFD_DATA2);
    FETCH c INTO i;
    CLOSE c;
    IF i IS NULL THEN
      i  := 0;
    END IF;
    RETURN i;
  END;
  FUNCTION GET_KDN_OPOZD (pFD_DATA1 IN DATE, pFD_DATA2 IN DATE)
    RETURN NUMBER IS
    CURSOR c (pData1 DATE, pData2 DATE) IS
      SELECT/*+rule*/ SUM (T2.FD_DATA1 - T1.FD_DATA1 + 1)
        FROM TSROKY T1, TSROKY T2
       WHERE T1.FK_PACID = T2.FK_PACID
         AND T2.FD_DATA1 BETWEEN pData1 AND pData2+1-1/(24*60)
         AND T2.FK_PRYB = 2
         AND T1.FD_DATA1 < T2.FD_DATA1;
    i NUMBER;
  BEGIN
    OPEN c (pFD_DATA1, pFD_DATA2);
    FETCH c INTO i;
    CLOSE c;
    IF i IS NULL THEN
      i  := 0;
    END IF;
    RETURN i;
  END;
  FUNCTION GET_KDN_PRODL (pFD_DATA1 IN DATE, pFD_DATA2 IN DATE)
    RETURN NUMBER IS
    CURSOR c (pData1 DATE, pData2 DATE) IS
      SELECT SUM (FN_KOL)
        FROM tsroky
       WHERE fd_data1 BETWEEN pData1 AND pData2+1-1/(24*60)
         AND fk_pryb IN (5, 6);
    i NUMBER;
  BEGIN
    OPEN c (pFD_DATA1, pFD_DATA2);
    FETCH c INTO i;
    CLOSE c;
    IF i IS NULL THEN
      i  := 0;
    END IF;
    RETURN i;
  END;
  FUNCTION GET_KDNV_PRODL (pFD_DATA1 IN DATE, pFD_DATA2 IN DATE)
    RETURN NUMBER IS
    CURSOR c (pData1 DATE, pData2 DATE) IS
      SELECT SUM (FN_KOL)
        FROM tsroky
       WHERE fd_data1 BETWEEN pData1 AND pData2+1-1/(24*60)
         AND GET_PACOUTCOME (FK_PACID) IS NOT NULL
         AND fk_pryb IN (5, 6);
    i NUMBER;
  BEGIN
    OPEN c (pFD_DATA1, pFD_DATA2);
    FETCH c INTO i;
    CLOSE c;
    IF i IS NULL THEN
      i  := 0;
    END IF;
    RETURN i;
  END;
  FUNCTION GET_KDN_PRODL (pFD_DATA1 IN DATE, pFD_DATA2 IN DATE, pFK_PRYB IN NUMBER)
    RETURN NUMBER IS
    CURSOR c (pData1 DATE, pData2 DATE) IS
      SELECT SUM (FN_KOL)
        FROM tsroky
       WHERE fd_data1 BETWEEN pData1 AND pData2+1-1/(24*60)
         AND fk_pryb = pFK_PRYB;
    i NUMBER;
  BEGIN
    OPEN c (pFD_DATA1, pFD_DATA2);
    FETCH c INTO i;
    CLOSE c;
    IF i IS NULL THEN
      i  := 0;
    END IF;
    RETURN i;
  END;
  FUNCTION GET_KDNV_PRODL (pFD_DATA1 IN DATE, pFD_DATA2 IN DATE, pFK_PRYB IN NUMBER)
    RETURN NUMBER IS
    CURSOR c (pData1 DATE, pData2 DATE) IS
      SELECT SUM (FN_KOL)
        FROM tsroky
       WHERE fd_data1 BETWEEN pData1 AND pData2+1-1/(24*60)
         AND GET_PACOUTCOME (FK_PACID) IS NOT NULL
         AND fk_pryb = pFK_PRYB;
    i NUMBER;
  BEGIN
    OPEN c (pFD_DATA1, pFD_DATA2);
    FETCH c INTO i;
    CLOSE c;
    IF i IS NULL THEN
      i  := 0;
    END IF;
    RETURN i;
  END;
  FUNCTION GET_KDN_EARLY (pFD_DATA1 IN DATE, pFD_DATA2 IN DATE)
    RETURN NUMBER IS
    CURSOR c (pData1 DATE, pData2 DATE) IS
      SELECT SUM (FN_KOL)
        FROM tsroky
       WHERE fk_pryb = 3
         AND fn_kol > 0
         AND fd_data1 BETWEEN pData1 AND pData2+1-1/(24*60);
    i NUMBER;
  BEGIN
    OPEN c (pFD_DATA1, pFD_DATA2);
    FETCH c INTO i;
    CLOSE c;
    IF i IS NULL THEN
      i  := 0;
    END IF;
    RETURN i;
  END;
  FUNCTION GET_COUNT_OPOZD_PRIZN (pFD_DATA1 IN DATE, pFD_DATA2 IN DATE, pFK_PRIZNID IN NUMBER)
    RETURN NUMBER IS
    CURSOR c (pData1 DATE, pData2 DATE, pPrizn NUMBER) IS
      SELECT/*+rule*/ COUNT (DISTINCT T2.FK_PACID)
        FROM TSROKY T1, TSROKY T2
       WHERE T1.FK_PACID = T2.FK_PACID
         AND T2.FD_DATA1 BETWEEN pData1 AND pData2+1-1/(24*60)
         AND T2.FK_PRYB = 2
         AND T1.FD_DATA1 < T2.FD_DATA1
         AND GET_PAC_PRIZN_KODE (T2.FK_PACID) = pPrizn;
    i NUMBER;
  BEGIN
    OPEN c (pFD_DATA1, pFD_DATA2, pFK_PRIZNID);
    FETCH c INTO i;
    CLOSE c;
    RETURN i;
  END;
  FUNCTION GET_COUNTV_OPOZD_PRIZN (pFD_DATA1 IN DATE, pFD_DATA2 IN DATE, pFK_PRIZNID IN NUMBER)
    RETURN NUMBER IS
    CURSOR c (pData1 DATE, pData2 DATE, pPrizn NUMBER) IS
      SELECT/*+rule*/ COUNT (DISTINCT T2.FK_PACID)
        FROM TSROKY T1, TSROKY T2
       WHERE T1.FK_PACID = T2.FK_PACID
         AND T2.FD_DATA1 BETWEEN pData1 AND pData2+1-1/(24*60)
         AND T2.FK_PRYB = 2
         AND GET_PACOUTCOME (T2.FK_PACID) IS NOT NULL
         AND T1.FD_DATA1 < T2.FD_DATA1
         AND GET_PAC_PRIZN_KODE (T2.FK_PACID) = pPrizn;
    i NUMBER;
  BEGIN
    OPEN c (pFD_DATA1, pFD_DATA2, pFK_PRIZNID);
    FETCH c INTO i;
    CLOSE c;
    RETURN i;
  END;
  FUNCTION GET_COUNT_PRODL_PRIZN (pFD_DATA1 IN DATE, pFD_DATA2 IN DATE, pFK_PRIZNID IN NUMBER)
    RETURN NUMBER IS
    CURSOR c (pData1 DATE, pData2 DATE, pPrizn NUMBER) IS
      SELECT COUNT (distinct fk_pacid)
        FROM tsroky
       WHERE fd_data1 BETWEEN pData1 AND pData2+1-1/(24*60)
         AND fk_pryb IN (5, 6)
         AND GET_PAC_PRIZN_KODE (FK_PACID) = pPrizn;
    i NUMBER;
  BEGIN
    OPEN c (pFD_DATA1, pFD_DATA2, pFK_PRIZNID);
    FETCH c INTO i;
    CLOSE c;
    RETURN i;
  END;
  FUNCTION GET_COUNTV_PRODL_PRIZN (pFD_DATA1 IN DATE, pFD_DATA2 IN DATE, pFK_PRIZNID IN NUMBER)
    RETURN NUMBER IS
    CURSOR c (pData1 DATE, pData2 DATE, pPrizn NUMBER) IS
      SELECT COUNT (distinct fk_pacid)
        FROM tsroky
       WHERE fd_data1 BETWEEN pData1 AND pData2+1-1/(24*60)
         AND fk_pryb IN (5, 6)
         AND GET_PACOUTCOME (FK_PACID) IS NOT NULL
         AND GET_PAC_PRIZN_KODE (FK_PACID) = pPrizn;
    i NUMBER;
  BEGIN
    OPEN c (pFD_DATA1, pFD_DATA2, pFK_PRIZNID);
    FETCH c INTO i;
    CLOSE c;
    RETURN i;
  END;
  FUNCTION GET_COUNTV_PRODL_PRIZN (pFD_DATA1 IN DATE, pFD_DATA2 IN DATE, pFK_PRIZNID IN NUMBER, pFK_PRYB IN NUMBER)
    RETURN NUMBER IS
    CURSOR c (pData1 DATE, pData2 DATE, pPrizn NUMBER) IS
      SELECT COUNT (distinct fk_pacid)
        FROM tsroky
       WHERE fd_data1 BETWEEN pData1 AND pData2+1-1/(24*60)
         AND fk_pryb = pFK_PRYB
         AND GET_PACOUTCOME (FK_PACID) IS NOT NULL
         AND GET_PAC_PRIZN_KODE (FK_PACID) = pPrizn;
    i NUMBER;
  BEGIN
    OPEN c (pFD_DATA1, pFD_DATA2, pFK_PRIZNID);
    FETCH c INTO i;
    CLOSE c;
    RETURN i;
  END;
  FUNCTION GET_COUNT_PRODL_PRIZN (pFD_DATA1 IN DATE, pFD_DATA2 IN DATE, pFK_PRIZNID IN NUMBER, pFK_PRYB IN NUMBER)
    RETURN NUMBER IS
    CURSOR c (pData1 DATE, pData2 DATE, pPrizn NUMBER) IS
      SELECT COUNT (distinct fk_pacid)
        FROM tsroky
       WHERE fd_data1 BETWEEN pData1 AND pData2+1-1/(24*60)
         AND fk_pryb = pFK_PRYB
         AND GET_PAC_PRIZN_KODE (FK_PACID) = pPrizn;
    i NUMBER;
  BEGIN
    OPEN c (pFD_DATA1, pFD_DATA2, pFK_PRIZNID);
    FETCH c INTO i;
    CLOSE c;
    RETURN i;
  END;
  FUNCTION GET_COUNT_EARLY_PRIZN (pFD_DATA1 IN DATE, pFD_DATA2 IN DATE, pFK_PRIZNID IN NUMBER)
    RETURN NUMBER IS
    CURSOR c (pData1 DATE, pData2 DATE, pPrizn NUMBER) IS
      SELECT COUNT (fk_id)
        FROM tsroky
       WHERE fk_pryb = 3
         AND fn_kol > 0
         AND fd_data1 BETWEEN pData1 AND pData2+1-1/(24*60)
         AND GET_PAC_PRIZN_KODE (FK_PACID) = pPrizn;
    i NUMBER;
  BEGIN
    OPEN c (pFD_DATA1, pFD_DATA2, pFK_PRIZNID);
    FETCH c INTO i;
    CLOSE c;
    RETURN i;
  END;
  FUNCTION GET_KDN_OPOZD_PRIZN (pFD_DATA1 IN DATE, pFD_DATA2 IN DATE, pFK_PRIZNID IN NUMBER)
    RETURN NUMBER IS
    CURSOR c (pData1 DATE, pData2 DATE, pPrizn NUMBER) IS
      SELECT/*+rule*/ SUM (T1.FN_KOL - T2.FN_KOL)
        FROM TSROKY T1, TSROKY T2
       WHERE T1.FK_PACID = T2.FK_PACID
         AND T2.FD_DATA1 BETWEEN pData1 AND pData2+1-1/(24*60)
         AND T2.FK_PRYB = 2
         AND T1.FD_DATA1 < T2.FD_DATA1
         AND GET_PAC_PRIZN_KODE (T2.FK_PACID) = pPrizn;
    i NUMBER;
  BEGIN
    OPEN c (pFD_DATA1, pFD_DATA2, pFK_PRIZNID);
    FETCH c INTO i;
    CLOSE c;
    IF i IS NULL THEN
      i  := 0;
    END IF;
    RETURN i;
  END;
  FUNCTION GET_KDNV_OPOZD_PRIZN (pFD_DATA1 IN DATE, pFD_DATA2 IN DATE, pFK_PRIZNID IN NUMBER)
    RETURN NUMBER IS
    CURSOR c (pData1 DATE, pData2 DATE, pPrizn NUMBER) IS
      SELECT/*+rule*/ SUM (T1.FN_KOL - T2.FN_KOL)
        FROM TSROKY T1, TSROKY T2
       WHERE T1.FK_PACID = T2.FK_PACID
         AND T2.FD_DATA1 BETWEEN pData1 AND pData2+1-1/(24*60)
         AND T2.FK_PRYB = 2
         AND GET_PACOUTCOME (T2.FK_PACID) IS NOT NULL
         AND T1.FD_DATA1 < T2.FD_DATA1
         AND GET_PAC_PRIZN_KODE (T2.FK_PACID) = pPrizn;
    i NUMBER;
  BEGIN
    OPEN c (pFD_DATA1, pFD_DATA2, pFK_PRIZNID);
    FETCH c INTO i;
    CLOSE c;
    IF i IS NULL THEN
      i  := 0;
    END IF;
    RETURN i;
  END;
  FUNCTION GET_KDN_PRODL_PRIZN (pFD_DATA1 IN DATE, pFD_DATA2 IN DATE, pFK_PRIZNID IN NUMBER)
    RETURN NUMBER IS
    CURSOR c (pData1 DATE, pData2 DATE, pPrizn NUMBER) IS
      SELECT SUM (FN_KOL)
        FROM tsroky
       WHERE fd_data1 BETWEEN pData1 AND pData2+1-1/(24*60)
         AND fk_pryb IN (5, 6)
         AND GET_PAC_PRIZN_KODE (FK_PACID) = pPrizn;
    i NUMBER;
  BEGIN
    OPEN c (pFD_DATA1, pFD_DATA2, pFK_PRIZNID);
    FETCH c INTO i;
    CLOSE c;
    IF i IS NULL THEN
      i  := 0;
    END IF;
    RETURN i;
  END;
  FUNCTION GET_KDNV_PRODL_PRIZN (pFD_DATA1 IN DATE, pFD_DATA2 IN DATE, pFK_PRIZNID IN NUMBER)
    RETURN NUMBER IS
    CURSOR c (pData1 DATE, pData2 DATE, pPrizn NUMBER) IS
      SELECT SUM (FN_KOL)
        FROM tsroky
       WHERE fd_data1 BETWEEN pData1 AND pData2+1-1/(24*60)
         AND fk_pryb IN (5, 6)
         AND GET_PACOUTCOME (FK_PACID) IS NOT NULL
         AND GET_PAC_PRIZN_KODE (FK_PACID) = pPrizn;
    i NUMBER;
  BEGIN
    OPEN c (pFD_DATA1, pFD_DATA2, pFK_PRIZNID);
    FETCH c INTO i;
    CLOSE c;
    IF i IS NULL THEN
      i  := 0;
    END IF;
    RETURN i;
  END;
  FUNCTION GET_KDN_PRODL_PRIZN (pFD_DATA1 IN DATE, pFD_DATA2 IN DATE, pFK_PRIZNID IN NUMBER, pFK_PRYB IN NUMBER)
    RETURN NUMBER IS
    CURSOR c (pData1 DATE, pData2 DATE, pPrizn NUMBER) IS
      SELECT SUM (FN_KOL)
        FROM tsroky
       WHERE fd_data1 BETWEEN pData1 AND pData2+1-1/(24*60)
         AND fk_pryb = pFK_PRYB
         AND GET_PAC_PRIZN_KODE (FK_PACID) = pPrizn;
    i NUMBER;
  BEGIN
    OPEN c (pFD_DATA1, pFD_DATA2, pFK_PRIZNID);
    FETCH c INTO i;
    CLOSE c;
    IF i IS NULL THEN
      i  := 0;
    END IF;
    RETURN i;
  END;
  FUNCTION GET_KDNV_PRODL_PRIZN (pFD_DATA1 IN DATE, pFD_DATA2 IN DATE, pFK_PRIZNID IN NUMBER, pFK_PRYB IN NUMBER)
    RETURN NUMBER IS
    CURSOR c (pData1 DATE, pData2 DATE, pPrizn NUMBER) IS
      SELECT SUM (FN_KOL)
        FROM tsroky
       WHERE fd_data1 BETWEEN pData1 AND pData2+1-1/(24*60)
         AND fk_pryb = pFK_PRYB
         AND GET_PACOUTCOME (FK_PACID) IS NOT NULL
         AND GET_PAC_PRIZN_KODE (FK_PACID) = pPrizn;
    i NUMBER;
  BEGIN
    OPEN c (pFD_DATA1, pFD_DATA2, pFK_PRIZNID);
    FETCH c INTO i;
    CLOSE c;
    IF i IS NULL THEN
      i  := 0;
    END IF;
    RETURN i;
  END;
  FUNCTION GET_KDN_EARLY_PRIZN (pFD_DATA1 IN DATE, pFD_DATA2 IN DATE, pFK_PRIZNID IN NUMBER)
    RETURN NUMBER IS
    CURSOR c (pData1 DATE, pData2 DATE, pPrizn NUMBER) IS
      SELECT SUM (FN_KOL)
        FROM tsroky
       WHERE fk_pryb = 3
         AND fn_kol > 0
         AND fd_data1 BETWEEN pData1 AND pData2+1-1/(24*60)
         AND GET_PAC_PRIZN_KODE (FK_PACID) = pPrizn;
    i NUMBER;
  BEGIN
    OPEN c (pFD_DATA1, pFD_DATA2, pFK_PRIZNID);
    FETCH c INTO i;
    CLOSE c;
    IF i IS NULL THEN
      i  := 0;
    END IF;
    RETURN i;
  END;
  FUNCTION GET_COUNTV_OPOZD_SHORT (pFD_DATA1 IN DATE, pFD_DATA2 IN DATE)
    RETURN NUMBER IS
    CURSOR c (pData1 DATE, pData2 DATE) IS
      SELECT/*+rule*/ COUNT (DISTINCT T2.FK_PACID)
        FROM TSROKY T1, TSROKY T2
       WHERE T1.FK_PACID = T2.FK_PACID
         AND T2.FD_DATA1 BETWEEN pData1 AND pData2+1-1/(24*60)
         AND T2.FK_PRYB = 2
         AND GET_PACOUTCOME (T2.FK_PACID) IS NOT NULL
         AND T1.FD_DATA1 < T2.FD_DATA1
         AND GET_PACDAYSPLAN (T2.FK_PACID) <= PKG_SMINI.READSTRING ('CONFIG', 'SHORT_SROK', '5');
    i NUMBER;
  BEGIN
    OPEN c (pFD_DATA1, pFD_DATA2);
    FETCH c INTO i;
    CLOSE c;
    RETURN i;
  END;
  FUNCTION GET_COUNT_OPOZD_SHORT (pFD_DATA1 IN DATE, pFD_DATA2 IN DATE)
    RETURN NUMBER IS
    CURSOR c (pData1 DATE, pData2 DATE) IS
      SELECT/*+rule*/ COUNT (DISTINCT T2.FK_PACID)
        FROM TSROKY T1, TSROKY T2
       WHERE T1.FK_PACID = T2.FK_PACID
         AND T2.FD_DATA1 BETWEEN pData1 AND pData2+1-1/(24*60)
         AND T2.FK_PRYB = 2
         AND T1.FD_DATA1 < T2.FD_DATA1
         AND GET_PACDAYSPLAN (T2.FK_PACID) <= PKG_SMINI.READSTRING ('CONFIG', 'SHORT_SROK', '5');
    i NUMBER;
  BEGIN
    OPEN c (pFD_DATA1, pFD_DATA2);
    FETCH c INTO i;
    CLOSE c;
    RETURN i;
  END;
  FUNCTION GET_COUNT_PRODL_SHORT (pFD_DATA1 IN DATE, pFD_DATA2 IN DATE)
    RETURN NUMBER IS
    CURSOR c (pData1 DATE, pData2 DATE) IS
      SELECT COUNT (distinct fk_pacid)
        FROM tsroky
       WHERE fd_data1 BETWEEN pData1 AND pData2+1-1/(24*60)
         AND fk_pryb IN (5, 6)
         AND GET_PACDAYSPLAN (FK_PACID) <= PKG_SMINI.READSTRING ('CONFIG', 'SHORT_SROK', '5');
    i NUMBER;
  BEGIN
    OPEN c (pFD_DATA1, pFD_DATA2);
    FETCH c INTO i;
    CLOSE c;
    RETURN i;
  END;
  FUNCTION GET_COUNTV_PRODL_SHORT (pFD_DATA1 IN DATE, pFD_DATA2 IN DATE)
    RETURN NUMBER IS
    CURSOR c (pData1 DATE, pData2 DATE) IS
      SELECT COUNT (distinct fk_pacid)
        FROM tsroky
       WHERE fd_data1 BETWEEN pData1 AND pData2+1-1/(24*60)
         AND fk_pryb IN (5, 6)
         AND GET_PACOUTCOME (FK_PACID) IS NOT NULL
         AND GET_PACDAYSPLAN (FK_PACID) <= PKG_SMINI.READSTRING ('CONFIG', 'SHORT_SROK', '5');
    i NUMBER;
  BEGIN
    OPEN c (pFD_DATA1, pFD_DATA2);
    FETCH c INTO i;
    CLOSE c;
    RETURN i;
  END;
  FUNCTION GET_COUNTV_PRODL_SHORT (pFD_DATA1 IN DATE, pFD_DATA2 IN DATE, pFK_PRYB IN NUMBER)
    RETURN NUMBER IS
    CURSOR c (pData1 DATE, pData2 DATE) IS
      SELECT COUNT (distinct fk_pacid)
        FROM tsroky
       WHERE fd_data1 BETWEEN pData1 AND pData2+1-1/(24*60)
         AND fk_pryb = pFK_PRYB
         AND GET_PACOUTCOME (FK_PACID) IS NOT NULL
         AND GET_PACDAYSPLAN (FK_PACID) <= PKG_SMINI.READSTRING ('CONFIG', 'SHORT_SROK', '5');
    i NUMBER;
  BEGIN
    OPEN c (pFD_DATA1, pFD_DATA2);
    FETCH c INTO i;
    CLOSE c;
    RETURN i;
  END;
  FUNCTION GET_COUNT_PRODL_SHORT (pFD_DATA1 IN DATE, pFD_DATA2 IN DATE, pFK_PRYB IN NUMBER)
    RETURN NUMBER IS
    CURSOR c (pData1 DATE, pData2 DATE) IS
      SELECT COUNT (distinct fk_pacid)
        FROM tsroky
       WHERE fd_data1 BETWEEN pData1 AND pData2+1-1/(24*60)
         AND fk_pryb = pFK_PRYB
         AND GET_PACDAYSPLAN (FK_PACID) <= PKG_SMINI.READSTRING ('CONFIG', 'SHORT_SROK', '5');
    i NUMBER;
  BEGIN
    OPEN c (pFD_DATA1, pFD_DATA2);
    FETCH c INTO i;
    CLOSE c;
    RETURN i;
  END;
  FUNCTION GET_COUNT_EARLY_SHORT (pFD_DATA1 IN DATE, pFD_DATA2 IN DATE)
    RETURN NUMBER IS
    CURSOR c (pData1 DATE, pData2 DATE) IS
      SELECT COUNT (fk_id)
        FROM tsroky
       WHERE fk_pryb = 3
         AND fn_kol > 0
         AND fd_data1 BETWEEN pData1 AND pData2+1-1/(24*60)
         AND GET_PACDAYSPLAN (FK_PACID) <= PKG_SMINI.READSTRING ('CONFIG', 'SHORT_SROK', '5');
    i NUMBER;
  BEGIN
    OPEN c (pFD_DATA1, pFD_DATA2);
    FETCH c INTO i;
    CLOSE c;
    RETURN i;
  END;
  FUNCTION GET_KDNV_OPOZD_SHORT (pFD_DATA1 IN DATE, pFD_DATA2 IN DATE)
    RETURN NUMBER IS
    CURSOR c (pData1 DATE, pData2 DATE) IS
      SELECT/*+rule*/ SUM (T1.FN_KOL - T2.FN_KOL)
        FROM TSROKY T1, TSROKY T2
       WHERE T1.FK_PACID = T2.FK_PACID
         AND GET_PACOUTCOME (T2.FK_PACID) IS NOT NULL
         AND T2.FD_DATA1 BETWEEN pData1 AND pData2+1-1/(24*60)
         AND T2.FK_PRYB = 2
         AND T1.FD_DATA1 < T2.FD_DATA1
         AND GET_PACDAYSPLAN (T2.FK_PACID) <= PKG_SMINI.READSTRING ('CONFIG', 'SHORT_SROK', '5');
    i NUMBER;
  BEGIN
    OPEN c (pFD_DATA1, pFD_DATA2);
    FETCH c INTO i;
    CLOSE c;
    IF i IS NULL THEN
      i  := 0;
    END IF;
    RETURN i;
  END;
  FUNCTION GET_KDN_OPOZD_SHORT (pFD_DATA1 IN DATE, pFD_DATA2 IN DATE)
    RETURN NUMBER IS
    CURSOR c (pData1 DATE, pData2 DATE) IS
      SELECT/*+rule*/ SUM (T1.FN_KOL - T2.FN_KOL)
        FROM TSROKY T1, TSROKY T2
       WHERE T1.FK_PACID = T2.FK_PACID
         AND T2.FD_DATA1 BETWEEN pData1 AND pData2+1-1/(24*60)
         AND T2.FK_PRYB = 2
         AND T1.FD_DATA1 < T2.FD_DATA1
         AND GET_PACDAYSPLAN (T2.FK_PACID) <= PKG_SMINI.READSTRING ('CONFIG', 'SHORT_SROK', '5');
    i NUMBER;
  BEGIN
    OPEN c (pFD_DATA1, pFD_DATA2);
    FETCH c INTO i;
    CLOSE c;
    IF i IS NULL THEN
      i  := 0;
    END IF;
    RETURN i;
  END;
  FUNCTION GET_KDNV_PRODL_SHORT (pFD_DATA1 IN DATE, pFD_DATA2 IN DATE)
    RETURN NUMBER IS
    CURSOR c (pData1 DATE, pData2 DATE) IS
      SELECT SUM (FN_KOL)
        FROM tsroky
       WHERE fd_data1 BETWEEN pData1 AND pData2+1-1/(24*60)
         AND fk_pryb IN (5, 6)
         AND GET_PACOUTCOME (FK_PACID) IS NOT NULL
         AND GET_PACDAYSPLAN (FK_PACID) <= PKG_SMINI.READSTRING ('CONFIG', 'SHORT_SROK', '5');
    i NUMBER;
  BEGIN
    OPEN c (pFD_DATA1, pFD_DATA2);
    FETCH c INTO i;
    CLOSE c;
    IF i IS NULL THEN
      i  := 0;
    END IF;
    RETURN i;
  END;
  FUNCTION GET_KDN_PRODL_SHORT (pFD_DATA1 IN DATE, pFD_DATA2 IN DATE)
    RETURN NUMBER IS
    CURSOR c (pData1 DATE, pData2 DATE) IS
      SELECT SUM (FN_KOL)
        FROM tsroky
       WHERE fd_data1 BETWEEN pData1 AND pData2+1-1/(24*60)
         AND fk_pryb IN (5, 6)
         AND GET_PACDAYSPLAN (FK_PACID) <= PKG_SMINI.READSTRING ('CONFIG', 'SHORT_SROK', '5');
    i NUMBER;
  BEGIN
    OPEN c (pFD_DATA1, pFD_DATA2);
    FETCH c INTO i;
    CLOSE c;
    IF i IS NULL THEN
      i  := 0;
    END IF;
    RETURN i;
  END;
  FUNCTION GET_KDN_PRODL_SHORT (pFD_DATA1 IN DATE, pFD_DATA2 IN DATE, pFK_PRYB IN NUMBER)
    RETURN NUMBER IS
    CURSOR c (pData1 DATE, pData2 DATE) IS
      SELECT SUM (FN_KOL)
        FROM tsroky
       WHERE fd_data1 BETWEEN pData1 AND pData2+1-1/(24*60)
         AND fk_pryb = pFK_PRYB
         AND GET_PACDAYSPLAN (FK_PACID) <= PKG_SMINI.READSTRING ('CONFIG', 'SHORT_SROK', '5');
    i NUMBER;
  BEGIN
    OPEN c (pFD_DATA1, pFD_DATA2);
    FETCH c INTO i;
    CLOSE c;
    IF i IS NULL THEN
      i  := 0;
    END IF;
    RETURN i;
  END;
  FUNCTION GET_KDNV_PRODL_SHORT (pFD_DATA1 IN DATE, pFD_DATA2 IN DATE, pFK_PRYB IN NUMBER)
    RETURN NUMBER IS
    CURSOR c (pData1 DATE, pData2 DATE) IS
      SELECT SUM (FN_KOL)
        FROM tsroky
       WHERE fd_data1 BETWEEN pData1 AND pData2+1-1/(24*60)
         AND fk_pryb = pFK_PRYB
         AND GET_PACOUTCOME (FK_PACID) IS NOT NULL
         AND GET_PACDAYSPLAN (FK_PACID) <= PKG_SMINI.READSTRING ('CONFIG', 'SHORT_SROK', '5');
    i NUMBER;
  BEGIN
    OPEN c (pFD_DATA1, pFD_DATA2);
    FETCH c INTO i;
    CLOSE c;
    IF i IS NULL THEN
      i  := 0;
    END IF;
    RETURN i;
  END;
  FUNCTION GET_KDN_EARLY_SHORT (pFD_DATA1 IN DATE, pFD_DATA2 IN DATE)
    RETURN NUMBER IS
    CURSOR c (pData1 DATE, pData2 DATE) IS
      SELECT SUM (FN_KOL)
        FROM tsroky
       WHERE fk_pryb = 3
         AND fn_kol > 0
         AND fd_data1 BETWEEN pData1 AND pData2+1-1/(24*60)
         AND GET_PACDAYSPLAN (FK_PACID) <= PKG_SMINI.READSTRING ('CONFIG', 'SHORT_SROK', '5');
    i NUMBER;
  BEGIN
    OPEN c (pFD_DATA1, pFD_DATA2);
    FETCH c INTO i;
    CLOSE c;
    IF i IS NULL THEN
      i  := 0;
    END IF;
    RETURN i;
  END;
  FUNCTION GET_COUNT_OPOZD_SHORT_PRIZN (pFD_DATA1 IN DATE, pFD_DATA2 IN DATE, pFK_PRIZNID IN NUMBER)
    RETURN NUMBER IS
    CURSOR c (pData1 DATE, pData2 DATE, pPrizn NUMBER) IS
      SELECT/*+rule*/ COUNT (DISTINCT T2.FK_PACID)
        FROM TSROKY T1, TSROKY T2
       WHERE T1.FK_PACID = T2.FK_PACID
         AND T2.FD_DATA1 BETWEEN pData1 AND pData2+1-1/(24*60)
         AND T2.FK_PRYB = 2
         AND T1.FD_DATA1 < T2.FD_DATA1
         AND GET_PAC_PRIZN_KODE (T2.FK_PACID) = pPrizn
         AND GET_PACDAYSPLAN (T2.FK_PACID) <= PKG_SMINI.READSTRING ('CONFIG', 'SHORT_SROK', '5');
    i NUMBER;
  BEGIN
    OPEN c (pFD_DATA1, pFD_DATA2, pFK_PRIZNID);
    FETCH c INTO i;
    CLOSE c;
    RETURN i;
  END;
  FUNCTION GET_COUNTV_OPOZD_SHORT_PRIZN (pFD_DATA1 IN DATE, pFD_DATA2 IN DATE, pFK_PRIZNID IN NUMBER)
    RETURN NUMBER IS
    CURSOR c (pData1 DATE, pData2 DATE, pPrizn NUMBER) IS
      SELECT/*+rule*/ COUNT (DISTINCT T2.FK_PACID)
        FROM TSROKY T1, TSROKY T2
       WHERE T1.FK_PACID = T2.FK_PACID
         AND GET_PACOUTCOME (T2.FK_PACID) IS NOT NULL
         AND T2.FD_DATA1 BETWEEN pData1 AND pData2+1-1/(24*60)
         AND T2.FK_PRYB = 2
         AND T1.FD_DATA1 < T2.FD_DATA1
         AND GET_PAC_PRIZN_KODE (T2.FK_PACID) = pPrizn
         AND GET_PACDAYSPLAN (T2.FK_PACID) <= PKG_SMINI.READSTRING ('CONFIG', 'SHORT_SROK', '5');
    i NUMBER;
  BEGIN
    OPEN c (pFD_DATA1, pFD_DATA2, pFK_PRIZNID);
    FETCH c INTO i;
    CLOSE c;
    RETURN i;
  END;
  FUNCTION GET_COUNTV_PRODL_SHORT_PRIZN (pFD_DATA1 IN DATE, pFD_DATA2 IN DATE, pFK_PRIZNID IN NUMBER)
    RETURN NUMBER IS
    CURSOR c (pData1 DATE, pData2 DATE, pPrizn NUMBER) IS
      SELECT COUNT (distinct fk_pacid)
        FROM tsroky
       WHERE fd_data1 BETWEEN pData1 AND pData2+1-1/(24*60)
         AND fk_pryb IN (5, 6)
         AND GET_PACOUTCOME (FK_PACID) IS NOT NULL
         AND GET_PAC_PRIZN_KODE (FK_PACID) = pPrizn
         AND GET_PACDAYSPLAN (FK_PACID) <= PKG_SMINI.READSTRING ('CONFIG', 'SHORT_SROK', '5');
    i NUMBER;
  BEGIN
    OPEN c (pFD_DATA1, pFD_DATA2, pFK_PRIZNID);
    FETCH c INTO i;
    CLOSE c;
    RETURN i;
  END;
  FUNCTION GET_COUNT_PRODL_SHORT_PRIZN (pFD_DATA1 IN DATE, pFD_DATA2 IN DATE, pFK_PRIZNID IN NUMBER)
    RETURN NUMBER IS
    CURSOR c (pData1 DATE, pData2 DATE, pPrizn NUMBER) IS
      SELECT COUNT (distinct fk_pacid)
        FROM tsroky
       WHERE fd_data1 BETWEEN pData1 AND pData2+1-1/(24*60)
         AND fk_pryb IN (5, 6)
         AND GET_PAC_PRIZN_KODE (FK_PACID) = pPrizn
         AND GET_PACDAYSPLAN (FK_PACID) <= PKG_SMINI.READSTRING ('CONFIG', 'SHORT_SROK', '5');
    i NUMBER;
  BEGIN
    OPEN c (pFD_DATA1, pFD_DATA2, pFK_PRIZNID);
    FETCH c INTO i;
    CLOSE c;
    RETURN i;
  END;
  FUNCTION GET_COUNTV_PRODL_SHORT_PRIZN (pFD_DATA1 IN DATE, pFD_DATA2 IN DATE, pFK_PRIZNID IN NUMBER, pFK_PRYB IN NUMBER)
    RETURN NUMBER IS
    CURSOR c (pData1 DATE, pData2 DATE, pPrizn NUMBER) IS
      SELECT COUNT (distinct fk_pacid)
        FROM tsroky
       WHERE fd_data1 BETWEEN pData1 AND pData2+1-1/(24*60)
         AND fk_pryb = pFK_PRYB
         AND GET_PACOUTCOME (FK_PACID) IS NOT NULL
         AND GET_PAC_PRIZN_KODE (FK_PACID) = pPrizn
         AND GET_PACDAYSPLAN (FK_PACID) <= PKG_SMINI.READSTRING ('CONFIG', 'SHORT_SROK', '5');
    i NUMBER;
  BEGIN
    OPEN c (pFD_DATA1, pFD_DATA2, pFK_PRIZNID);
    FETCH c INTO i;
    CLOSE c;
    RETURN i;
  END;
  FUNCTION GET_COUNT_PRODL_SHORT_PRIZN (pFD_DATA1 IN DATE, pFD_DATA2 IN DATE, pFK_PRIZNID IN NUMBER, pFK_PRYB IN NUMBER)
    RETURN NUMBER IS
    CURSOR c (pData1 DATE, pData2 DATE, pPrizn NUMBER) IS
      SELECT COUNT (distinct fk_pacid)
        FROM tsroky
       WHERE fd_data1 BETWEEN pData1 AND pData2+1-1/(24*60)
         AND fk_pryb = pFK_PRYB
         AND GET_PAC_PRIZN_KODE (FK_PACID) = pPrizn
         AND GET_PACDAYSPLAN (FK_PACID) <= PKG_SMINI.READSTRING ('CONFIG', 'SHORT_SROK', '5');
    i NUMBER;
  BEGIN
    OPEN c (pFD_DATA1, pFD_DATA2, pFK_PRIZNID);
    FETCH c INTO i;
    CLOSE c;
    RETURN i;
  END;
  FUNCTION GET_COUNT_EARLY_SHORT_PRIZN (pFD_DATA1 IN DATE, pFD_DATA2 IN DATE, pFK_PRIZNID IN NUMBER)
    RETURN NUMBER IS
    CURSOR c (pData1 DATE, pData2 DATE, pPrizn NUMBER) IS
      SELECT COUNT (fk_id)
        FROM tsroky
       WHERE fk_pryb = 3
         AND fn_kol > 0
         AND fd_data1 BETWEEN pData1 AND pData2+1-1/(24*60)
         AND GET_PAC_PRIZN_KODE (FK_PACID) = pPrizn
         AND GET_PACDAYSPLAN (FK_PACID) <= PKG_SMINI.READSTRING ('CONFIG', 'SHORT_SROK', '5');
    i NUMBER;
  BEGIN
    OPEN c (pFD_DATA1, pFD_DATA2, pFK_PRIZNID);
    FETCH c INTO i;
    CLOSE c;
    RETURN i;
  END;
  FUNCTION GET_KDN_OPOZD_SHORT_PRIZN (pFD_DATA1 IN DATE, pFD_DATA2 IN DATE, pFK_PRIZNID IN NUMBER)
    RETURN NUMBER IS
    CURSOR c (pData1 DATE, pData2 DATE, pPrizn NUMBER) IS
      SELECT/*+rule*/ SUM (T1.FN_KOL - T2.FN_KOL)
        FROM TSROKY T1, TSROKY T2
       WHERE T1.FK_PACID = T2.FK_PACID
         AND T2.FD_DATA1 BETWEEN pData1 AND pData2+1-1/(24*60)
         AND T2.FK_PRYB = 2
         AND T1.FD_DATA1 < T2.FD_DATA1
         AND GET_PAC_PRIZN_KODE (T2.FK_PACID) = pPrizn
         AND GET_PACDAYSPLAN (T2.FK_PACID) <= PKG_SMINI.READSTRING ('CONFIG', 'SHORT_SROK', '5');
    i NUMBER;
  BEGIN
    OPEN c (pFD_DATA1, pFD_DATA2, pFK_PRIZNID);
    FETCH c INTO i;
    CLOSE c;
    IF i IS NULL THEN
      i  := 0;
    END IF;
    RETURN i;
  END;
  FUNCTION GET_KDNV_OPOZD_SHORT_PRIZN (pFD_DATA1 IN DATE, pFD_DATA2 IN DATE, pFK_PRIZNID IN NUMBER)
    RETURN NUMBER IS
    CURSOR c (pData1 DATE, pData2 DATE, pPrizn NUMBER) IS
      SELECT/*+rule*/ SUM (T1.FN_KOL - T2.FN_KOL)
        FROM TSROKY T1, TSROKY T2
       WHERE T1.FK_PACID = T2.FK_PACID
         AND GET_PACOUTCOME (T2.FK_PACID) IS NOT NULL
         AND T2.FD_DATA1 BETWEEN pData1 AND pData2+1-1/(24*60)
         AND T2.FK_PRYB = 2
         AND T1.FD_DATA1 < T2.FD_DATA1
         AND GET_PAC_PRIZN_KODE (T2.FK_PACID) = pPrizn
         AND GET_PACDAYSPLAN (T2.FK_PACID) <= PKG_SMINI.READSTRING ('CONFIG', 'SHORT_SROK', '5');
    i NUMBER;
  BEGIN
    OPEN c (pFD_DATA1, pFD_DATA2, pFK_PRIZNID);
    FETCH c INTO i;
    CLOSE c;
    IF i IS NULL THEN
      i  := 0;
    END IF;
    RETURN i;
  END;
  FUNCTION GET_KDN_PRODL_SHORT_PRIZN (pFD_DATA1 IN DATE, pFD_DATA2 IN DATE, pFK_PRIZNID IN NUMBER)
    RETURN NUMBER IS
    CURSOR c (pData1 DATE, pData2 DATE, pPrizn NUMBER) IS
      SELECT SUM (FN_KOL)
        FROM tsroky
       WHERE fd_data1 BETWEEN pData1 AND pData2+1-1/(24*60)
         AND fk_pryb IN (5, 6)
         AND GET_PAC_PRIZN_KODE (FK_PACID) = pPrizn
         AND GET_PACDAYSPLAN (FK_PACID) <= PKG_SMINI.READSTRING ('CONFIG', 'SHORT_SROK', '5');
    i NUMBER;
  BEGIN
    OPEN c (pFD_DATA1, pFD_DATA2, pFK_PRIZNID);
    FETCH c INTO i;
    CLOSE c;
    IF i IS NULL THEN
      i  := 0;
    END IF;
    RETURN i;
  END;
  FUNCTION GET_KDNV_PRODL_SHORT_PRIZN (pFD_DATA1 IN DATE, pFD_DATA2 IN DATE, pFK_PRIZNID IN NUMBER)
    RETURN NUMBER IS
    CURSOR c (pData1 DATE, pData2 DATE, pPrizn NUMBER) IS
      SELECT SUM (FN_KOL)
        FROM tsroky
       WHERE fd_data1 BETWEEN pData1 AND pData2+1-1/(24*60)
         AND GET_PACOUTCOME (FK_PACID) IS NOT NULL
         AND fk_pryb IN (5, 6)
         AND GET_PAC_PRIZN_KODE (FK_PACID) = pPrizn
         AND GET_PACDAYSPLAN (FK_PACID) <= PKG_SMINI.READSTRING ('CONFIG', 'SHORT_SROK', '5');
    i NUMBER;
  BEGIN
    OPEN c (pFD_DATA1, pFD_DATA2, pFK_PRIZNID);
    FETCH c INTO i;
    CLOSE c;
    IF i IS NULL THEN
      i  := 0;
    END IF;
    RETURN i;
  END;
  FUNCTION GET_KDNV_PRODL_SHORT_PRIZN (pFD_DATA1 IN DATE, pFD_DATA2 IN DATE, pFK_PRIZNID IN NUMBER, pFK_PRYB IN NUMBER)
    RETURN NUMBER IS
    CURSOR c (pData1 DATE, pData2 DATE, pPrizn NUMBER) IS
      SELECT SUM (FN_KOL)
        FROM tsroky
       WHERE fd_data1 BETWEEN pData1 AND pData2+1-1/(24*60)
         AND GET_PACOUTCOME (FK_PACID) IS NOT NULL
         AND fk_pryb = pFK_PRYB
         AND GET_PAC_PRIZN_KODE (FK_PACID) = pPrizn
         AND GET_PACDAYSPLAN (FK_PACID) <= PKG_SMINI.READSTRING ('CONFIG', 'SHORT_SROK', '5');
    i NUMBER;
  BEGIN
    OPEN c (pFD_DATA1, pFD_DATA2, pFK_PRIZNID);
    FETCH c INTO i;
    CLOSE c;
    IF i IS NULL THEN
      i  := 0;
    END IF;
    RETURN i;
  END;
  FUNCTION GET_KDN_PRODL_SHORT_PRIZN (pFD_DATA1 IN DATE, pFD_DATA2 IN DATE, pFK_PRIZNID IN NUMBER, pFK_PRYB IN NUMBER)
    RETURN NUMBER IS
    CURSOR c (pData1 DATE, pData2 DATE, pPrizn NUMBER) IS
      SELECT SUM (FN_KOL)
        FROM tsroky
       WHERE fd_data1 BETWEEN pData1 AND pData2+1-1/(24*60)
         AND fk_pryb = pFK_PRYB
         AND GET_PAC_PRIZN_KODE (FK_PACID) = pPrizn
         AND GET_PACDAYSPLAN (FK_PACID) <= PKG_SMINI.READSTRING ('CONFIG', 'SHORT_SROK', '5');
    i NUMBER;
  BEGIN
    OPEN c (pFD_DATA1, pFD_DATA2, pFK_PRIZNID);
    FETCH c INTO i;
    CLOSE c;
    IF i IS NULL THEN
      i  := 0;
    END IF;
    RETURN i;
  END;
  FUNCTION GET_KDN_EARLY_SHORT_PRIZN (pFD_DATA1 IN DATE, pFD_DATA2 IN DATE, pFK_PRIZNID IN NUMBER)
    RETURN NUMBER IS
    CURSOR c (pData1 DATE, pData2 DATE, pPrizn NUMBER) IS
      SELECT SUM (FN_KOL)
        FROM tsroky
       WHERE fk_pryb = 3
         AND fn_kol > 0
         AND fd_data1 BETWEEN pData1 AND pData2+1-1/(24*60)
         AND GET_PAC_PRIZN_KODE (FK_PACID) = pPrizn
         AND GET_PACDAYSPLAN (FK_PACID) <= PKG_SMINI.READSTRING ('CONFIG', 'SHORT_SROK', '5');
    i NUMBER;
  BEGIN
    OPEN c (pFD_DATA1, pFD_DATA2, pFK_PRIZNID);
    FETCH c INTO i;
    CLOSE c;
    IF i IS NULL THEN
      i  := 0;
    END IF;
    RETURN i;
  END;
  FUNCTION GET_COUNT_INCOME_IN_PERIOD (pFD_DATA1 IN DATE, pFD_DATA2 IN DATE)
    RETURN VARCHAR2 IS
    CURSOR cIn (pData1 DATE, pData2 DATE, nPryb NUMBER) IS
      SELECT COUNT (FK_PACID)
        FROM TSROKY
       WHERE FD_DATA1 BETWEEN pData1 AND pData2+1-1/(24*60)
         AND FK_PRYB = nPryb;
    i NUMBER;
    str VARCHAR2 (50);
  BEGIN
    OPEN cIn (pFD_DATA1, pFD_DATA2, 2);
    FETCH cIn INTO i;
    CLOSE cIn;
    str  := i;
    OPEN cIn (pFD_DATA1, pFD_DATA2, 4);
    FETCH cIn INTO i;
    CLOSE cIn;
    IF i > 0 THEN
      str  := str || ' + ' || i;
    END IF;
    RETURN str;
  END;
  FUNCTION GET_COUNT_OUTCOME_IN_PERIOD (pFD_DATA1 IN DATE, pFD_DATA2 IN DATE)
    RETURN VARCHAR2 IS
    CURSOR cIn (pData1 DATE, pData2 DATE, nPryb NUMBER) IS
      SELECT COUNT (FK_PACID)
        FROM TSROKY
       WHERE FD_DATA1 BETWEEN pData1 AND pData2+1-1/(24*60)
         AND FK_PRYB = nPryb;
    i NUMBER;
    str VARCHAR2 (50);
  BEGIN
    OPEN cIn (pFD_DATA1, pFD_DATA2, 3);
    FETCH cIn INTO i;
    CLOSE cIn;
    str  := i;
    OPEN cIn (pFD_DATA1, pFD_DATA2, 7);
    FETCH cIn INTO i;
    CLOSE cIn;
    IF i > 0 THEN
      str  := str || ' + ' || i;
    END IF;
    RETURN str;
  END;
  FUNCTION GET_COUNT_OUTCOME_IN_PERIODVID (pFD_DATA1 IN DATE, pFD_DATA2 IN DATE, pFK_KOD2 IN NUMBER)
    RETURN VARCHAR2 IS
    CURSOR cIn (pData1 DATE, pData2 DATE, nPryb NUMBER, pKOD2 NUMBER) IS
      SELECT COUNT (FK_PACID)
        FROM TSROKY
       WHERE FD_DATA1 BETWEEN pData1 AND pData2+1-1/(24*60)
         AND FK_PRYB = nPryb
         AND GET_PAC_VID_KODE (FK_PACID) = pKOD2;
    i NUMBER;
    str VARCHAR2 (50);
  BEGIN
    OPEN cIn (pFD_DATA1, pFD_DATA2, 3, pFK_KOD2);
    FETCH cIn INTO i;
    CLOSE cIn;
    str  := i;
    OPEN cIn (pFD_DATA1, pFD_DATA2, 7, pFK_KOD2);
    FETCH cIn INTO i;
    CLOSE cIn;
    IF i > 0 THEN
      str  := str || ' + ' || i;
    END IF;
    RETURN str;
  END;
  FUNCTION GET_COUNTOUTCOMEINPERIODSUBVID (pFD_DATA1 IN DATE, pFD_DATA2 IN DATE, pFK_KOD2 IN NUMBER, pFK_KOD IN NUMBER)
    RETURN VARCHAR2 IS
    CURSOR cIn (pData1 DATE, pData2 DATE, nPryb NUMBER, pKOD2 NUMBER, pKOD NUMBER) IS
      SELECT COUNT (FK_PACID)
        FROM TSROKY
       WHERE FD_DATA1 BETWEEN pData1 AND pData2+1-1/(24*60)
         AND FK_PRYB = nPryb
         AND GET_PAC_VID_KODE (FK_PACID) = pKOD2
         AND GET_PAC_SUB_VID_KODE (FK_PACID) = pKOD;
    i NUMBER;
    str VARCHAR2 (50);
  BEGIN
    OPEN cIn (pFD_DATA1, pFD_DATA2, 3, pFK_KOD2, pFK_KOD);
    FETCH cIn INTO i;
    CLOSE cIn;
    str  := i;
    OPEN cIn (pFD_DATA1, pFD_DATA2, 7, pFK_KOD2, pFK_KOD);
    FETCH cIn INTO i;
    CLOSE cIn;
    IF i > 0 THEN
      str  := str || ' + ' || i;
    END IF;
    RETURN str;
  END;
  FUNCTION GET_COUNT_INCOME_INPERIODPRIZN (pFD_DATA1 IN DATE, pFD_DATA2 IN DATE, pFK_PRIZN IN NUMBER)
    RETURN VARCHAR2 IS
    CURSOR cIn (pData1 DATE, pData2 DATE, nPryb NUMBER, nPryzn NUMBER) IS
      SELECT COUNT (FK_PACID)
        FROM TSROKY
       WHERE FD_DATA1 BETWEEN pData1 AND pData2+1-1/(24*60)
         AND FK_PRYB = nPryb
         AND GET_PAC_PRIZN_KODE (FK_PACID) = nPryzn;
    i NUMBER;
    str VARCHAR2 (50);
  BEGIN
    OPEN cIn (pFD_DATA1, pFD_DATA2, 2, pFK_PRIZN);
    FETCH cIn INTO i;
    CLOSE cIn;
    str  := i;
    OPEN cIn (pFD_DATA1, pFD_DATA2, 4, pFK_PRIZN);
    FETCH cIn INTO i;
    CLOSE cIn;
    IF i > 0 THEN
      str  := str || ' + ' || i;
    END IF;
    RETURN str;
  END;
  FUNCTION GET_COUNT_OUTCOMEINPERIODPRIZN (pFD_DATA1 IN DATE, pFD_DATA2 IN DATE, pFK_PRIZN IN NUMBER)
    RETURN VARCHAR2 IS
    CURSOR cIn (pData1 DATE, pData2 DATE, nPryb NUMBER, nPryzn NUMBER) IS
      SELECT COUNT (FK_PACID)
        FROM TSROKY
       WHERE FD_DATA1 BETWEEN pData1 AND pData2+1-1/(24*60)
         AND FK_PRYB = nPryb
         AND GET_PAC_PRIZN_KODE (FK_PACID) = nPryzn;
    i NUMBER;
    str VARCHAR2 (50);
  BEGIN
    OPEN cIn (pFD_DATA1, pFD_DATA2, 3, pFK_PRIZN);
    FETCH cIn INTO i;
    CLOSE cIn;
    str  := i;
    OPEN cIn (pFD_DATA1, pFD_DATA2, 7, pFK_PRIZN);
    FETCH cIn INTO i;
    CLOSE cIn;
    IF i > 0 THEN
      str  := str || ' + ' || i;
    END IF;
    RETURN str;
  END;
  FUNCTION GET_COUNT_INCOME_INPERIODSHORT (pFD_DATA1 IN DATE, pFD_DATA2 IN DATE)
    RETURN VARCHAR2 IS
    CURSOR cIn (pData1 DATE, pData2 DATE, nPryb NUMBER) IS
      SELECT COUNT (FK_PACID)
        FROM TSROKY
       WHERE FD_DATA1 BETWEEN pData1 AND pData2+1-1/(24*60)
         AND FK_PRYB = nPryb
         AND GET_PACDAYSPLAN (FK_PACID) <= PKG_SMINI.READSTRING ('CONFIG', 'SHORT_SROK', 5);
    i NUMBER;
    str VARCHAR2 (50);
  BEGIN
    OPEN cIn (pFD_DATA1, pFD_DATA2, 2);
    FETCH cIn INTO i;
    CLOSE cIn;
    str  := i;
    OPEN cIn (pFD_DATA1, pFD_DATA2, 4);
    FETCH cIn INTO i;
    CLOSE cIn;
    IF i > 0 THEN
      str  := str || ' + ' || i;
    END IF;
    RETURN str;
  END;
  FUNCTION GET_COUNT_OUTCOMEINPERIODSHORT (pFD_DATA1 IN DATE, pFD_DATA2 IN DATE)
    RETURN VARCHAR2 IS
    CURSOR cIn (pData1 DATE, pData2 DATE, nPryb NUMBER) IS
      SELECT COUNT (FK_PACID)
        FROM TSROKY
       WHERE FD_DATA1 BETWEEN pData1 AND pData2+1-1/(24*60)
         AND FK_PRYB = nPryb
         AND GET_PACDAYSPLAN (FK_PACID) <= PKG_SMINI.READSTRING ('CONFIG', 'SHORT_SROK', 5);
    i NUMBER;
    str VARCHAR2 (50);
  BEGIN
    OPEN cIn (pFD_DATA1, pFD_DATA2, 3);
    FETCH cIn INTO i;
    CLOSE cIn;
    str  := i;
    OPEN cIn (pFD_DATA1, pFD_DATA2, 7);
    FETCH cIn INTO i;
    CLOSE cIn;
    IF i > 0 THEN
      str  := str || ' + ' || i;
    END IF;
    RETURN str;
  END;
  FUNCTION GET_INCOME_IN_PERIODSHORTPRIZN (pFD_DATA1 IN DATE, pFD_DATA2 IN DATE, pFK_PRIZN IN NUMBER)
    RETURN VARCHAR2 IS
    CURSOR cIn (pData1 DATE, pData2 DATE, nPryb NUMBER, nPryzn NUMBER) IS
      SELECT COUNT (FK_PACID)
        FROM TSROKY
       WHERE FD_DATA1 BETWEEN pData1 AND pData2+1-1/(24*60)
         AND FK_PRYB = nPryb
         AND GET_PACDAYSPLAN (FK_PACID) <= PKG_SMINI.READSTRING ('CONFIG', 'SHORT_SROK', 5)
         AND GET_PAC_PRIZN_KODE (FK_PACID) = nPryzn;
    i NUMBER;
    str VARCHAR2 (50);
  BEGIN
    OPEN cIn (pFD_DATA1, pFD_DATA2, 2, pFK_PRIZN);
    FETCH cIn INTO i;
    CLOSE cIn;
    str  := i;
    OPEN cIn (pFD_DATA1, pFD_DATA2, 4, pFK_PRIZN);
    FETCH cIn INTO i;
    CLOSE cIn;
    IF i > 0 THEN
      str  := str || ' + ' || i;
    END IF;
    RETURN str;
  END;
  FUNCTION GET_OUTCOME_INPERIODSHORTPRIZN (pFD_DATA1 IN DATE, pFD_DATA2 IN DATE, pFK_PRIZN IN NUMBER)
    RETURN VARCHAR2 IS
    CURSOR cIn (pData1 DATE, pData2 DATE, nPryb NUMBER, nPryzn NUMBER) IS
      SELECT COUNT (FK_PACID)
        FROM TSROKY
       WHERE FD_DATA1 BETWEEN pData1 AND pData2+1-1/(24*60)
         AND FK_PRYB = nPryb
         AND GET_PACDAYSPLAN (FK_PACID) <= PKG_SMINI.READSTRING ('CONFIG', 'SHORT_SROK', 5)
         AND GET_PAC_PRIZN_KODE (FK_PACID) = nPryzn;
    i NUMBER;
    str VARCHAR2 (50);
  BEGIN
    OPEN cIn (pFD_DATA1, pFD_DATA2, 3, pFK_PRIZN);
    FETCH cIn INTO i;
    CLOSE cIn;
    str  := i;
    OPEN cIn (pFD_DATA1, pFD_DATA2, 7, pFK_PRIZN);
    FETCH cIn INTO i;
    CLOSE cIn;
    IF i > 0 THEN
      str  := str || ' + ' || i;
    END IF;
    RETURN str;
  END;
  FUNCTION GET_COUNT_OUT_PERIODVIDPRIZNPR (pFD_DATA1 IN DATE, pFD_DATA2 IN DATE, pFK_KOD2 IN NUMBER, pFK_PRIZNID IN NUMBER)
    RETURN VARCHAR2 IS
    CURSOR cIn (pData1 DATE, pData2 DATE, nPryb NUMBER, pKOD2 NUMBER) IS
      SELECT COUNT (FK_ID)
        FROM TSROKY
       WHERE FD_DATA1 BETWEEN pData1 AND pData2+1-1/(24*60)
         AND FK_PRYB = nPryb
         AND GET_PAC_VID_KODE (FK_PACID) = pKOD2
         AND GET_PAC_PRIZN_KODE (FK_PACID) = pFK_PRIZNID;
    i NUMBER;
    str VARCHAR2 (50);
  BEGIN
    OPEN cIn (pFD_DATA1, pFD_DATA2, 3, pFK_KOD2);
    FETCH cIn INTO i;
    CLOSE cIn;
    str  := i;
    OPEN cIn (pFD_DATA1, pFD_DATA2, 7, pFK_KOD2);
    FETCH cIn INTO i;
    CLOSE cIn;
    IF i > 0 THEN
      str  := str || ' + ' || i;
    END IF;
    RETURN str;
  END;
  FUNCTION GET_COUNT_OUT_IN_PERIODVIDSH (pFD_DATA1 IN DATE, pFD_DATA2 IN DATE, pFK_KOD2 IN NUMBER)
    RETURN VARCHAR2 IS
    CURSOR cIn (pData1 DATE, pData2 DATE, nPryb NUMBER, pKOD2 NUMBER) IS
      SELECT COUNT (FK_ID)
        FROM TSROKY
       WHERE FD_DATA1 BETWEEN pData1 AND pData2+1-1/(24*60)
         AND FK_PRYB = nPryb
         AND GET_PAC_VID_KODE (FK_PACID) = pKOD2
         AND GET_PACDAYSPLAN (FK_PACID) <= PKG_SMINI.READSTRING ('CONFIG', 'SHORT_SROK', '5');
    i NUMBER;
    str VARCHAR2 (50);
  BEGIN
    OPEN cIn (pFD_DATA1, pFD_DATA2, 3, pFK_KOD2);
    FETCH cIn INTO i;
    CLOSE cIn;
    str  := i;
    OPEN cIn (pFD_DATA1, pFD_DATA2, 7, pFK_KOD2);
    FETCH cIn INTO i;
    CLOSE cIn;
    IF i > 0 THEN
      str  := str || ' + ' || i;
    END IF;
    RETURN str;
  END;
  FUNCTION GET_COUNT_OUTPERIODVIDPRIZNPRS (pFD_DATA1 IN DATE, pFD_DATA2 IN DATE, pFK_KOD2 IN NUMBER, pFK_PRIZNID IN NUMBER)
    RETURN VARCHAR2 IS
    CURSOR cIn (pData1 DATE, pData2 DATE, nPryb NUMBER, pKOD2 NUMBER) IS
      SELECT COUNT (FK_ID)
        FROM TSROKY
       WHERE FD_DATA1 BETWEEN pData1 AND pData2+1-1/(24*60)
         AND FK_PRYB = nPryb
         AND GET_PAC_VID_KODE (FK_PACID) = pKOD2
         AND GET_PAC_PRIZN_KODE (FK_PACID) = pFK_PRIZNID
         AND GET_PACDAYSPLAN (FK_PACID) <= PKG_SMINI.READSTRING ('CONFIG', 'SHORT_SROK', '5');
    i NUMBER;
    str VARCHAR2 (50);
  BEGIN
    OPEN cIn (pFD_DATA1, pFD_DATA2, 3, pFK_KOD2);
    FETCH cIn INTO i;
    CLOSE cIn;
    str  := i;
    OPEN cIn (pFD_DATA1, pFD_DATA2, 7, pFK_KOD2);
    FETCH cIn INTO i;
    CLOSE cIn;
    IF i > 0 THEN
      str  := str || ' + ' || i;
    END IF;
    RETURN str;
  END;
  FUNCTION GET_COUNTOUTINPERIODSUBVIDSH (pFD_DATA1 IN DATE, pFD_DATA2 IN DATE, pFK_KOD2 IN NUMBER, pFK_KOD IN NUMBER)
    RETURN VARCHAR2 IS
    CURSOR cIn (pData1 DATE, pData2 DATE, nPryb NUMBER, pKOD2 NUMBER, pKOD NUMBER) IS
      SELECT COUNT (FK_PACID)
        FROM TSROKY
       WHERE FD_DATA1 BETWEEN pData1 AND pData2+1-1/(24*60)
         AND FK_PRYB = nPryb
         AND GET_PAC_VID_KODE (FK_PACID) = pKOD2
         AND GET_PAC_SUB_VID_KODE (FK_PACID) = pKOD
         AND GET_PACDAYSPLAN (FK_PACID) <= PKG_SMINI.READSTRING ('CONFIG', 'SHORT_SROK', '5');
    i NUMBER;
    str VARCHAR2 (50);
  BEGIN
    OPEN cIn (pFD_DATA1, pFD_DATA2, 3, pFK_KOD2, pFK_KOD);
    FETCH cIn INTO i;
    CLOSE cIn;
    str  := i;
    OPEN cIn (pFD_DATA1, pFD_DATA2, 7, pFK_KOD2, pFK_KOD);
    FETCH cIn INTO i;
    CLOSE cIn;
    IF i > 0 THEN
      str  := str || ' + ' || i;
    END IF;
    RETURN str;
  END;
  FUNCTION GET_COUNTOUTINPERIODSUBVIDPR (pFD_DATA1 IN DATE, pFD_DATA2 IN DATE, pFK_KOD2 IN NUMBER, pFK_KOD IN NUMBER, pFK_PRIZNID IN NUMBER)
    RETURN VARCHAR2 IS
    CURSOR cIn (pData1 DATE, pData2 DATE, nPryb NUMBER, pKOD2 NUMBER, pKOD NUMBER) IS
      SELECT COUNT (FK_PACID)
        FROM TSROKY
       WHERE FD_DATA1 BETWEEN pData1 AND pData2+1-1/(24*60)
         AND FK_PRYB = nPryb
         AND GET_PAC_VID_KODE (FK_PACID) = pKOD2
         AND GET_PAC_SUB_VID_KODE (FK_PACID) = pKOD
         AND GET_PAC_PRIZN_KODE (FK_PACID) = pFK_PRIZNID;
    i NUMBER;
    str VARCHAR2 (50);
  BEGIN
    OPEN cIn (pFD_DATA1, pFD_DATA2, 3, pFK_KOD2, pFK_KOD);
    FETCH cIn INTO i;
    CLOSE cIn;
    str  := i;
    OPEN cIn (pFD_DATA1, pFD_DATA2, 7, pFK_KOD2, pFK_KOD);
    FETCH cIn INTO i;
    CLOSE cIn;
    IF i > 0 THEN
      str  := str || ' + ' || i;
    END IF;
    RETURN str;
  END;
  FUNCTION GET_COUNTOUTINPERIODSUBVIDPRSH (pFD_DATA1 IN DATE, pFD_DATA2 IN DATE, pFK_KOD2 IN NUMBER, pFK_KOD IN NUMBER, pFK_PRIZNID IN NUMBER)
    RETURN VARCHAR2 IS
    CURSOR cIn (pData1 DATE, pData2 DATE, nPryb NUMBER, pKOD2 NUMBER, pKOD NUMBER) IS
      SELECT COUNT (FK_PACID)
        FROM TSROKY
       WHERE FD_DATA1 BETWEEN pData1 AND pData2+1-1/(24*60)
         AND FK_PRYB = nPryb
         AND GET_PAC_VID_KODE (FK_PACID) = pKOD2
         AND GET_PAC_SUB_VID_KODE (FK_PACID) = pKOD
         AND GET_PAC_PRIZN_KODE (FK_PACID) = pFK_PRIZNID
         AND GET_PACDAYSPLAN (FK_PACID) <= PKG_SMINI.READSTRING ('CONFIG', 'SHORT_SROK', '5');
    i NUMBER;
    str VARCHAR2 (50);
  BEGIN
    OPEN cIn (pFD_DATA1, pFD_DATA2, 3, pFK_KOD2, pFK_KOD);
    FETCH cIn INTO i;
    CLOSE cIn;
    str  := i;
    OPEN cIn (pFD_DATA1, pFD_DATA2, 7, pFK_KOD2, pFK_KOD);
    FETCH cIn INTO i;
    CLOSE cIn;
    IF i > 0 THEN
      str  := str || ' + ' || i;
    END IF;
    RETURN str;
  END;
  FUNCTION DO_CALC_INTIME (pFD_DATA1 IN DATE, pFD_DATA2 IN DATE, pFK_VRACHID IN NUMBER)
    RETURN NUMBER IS-- Used in rInTime.dpr
    CURSOR cVID IS
           SELECT fk_id, fc_name
             FROM tvid
            ORDER BY fk_id;
    CURSOR cSUBVID (pVIDID NUMBER) IS
           SELECT fk_id, fc_name
             FROM tsubvid
            WHERE FK_VIDID = pVIDID
            ORDER BY fk_id;
    CURSOR cPrizn IS
           SELECT FK_ID, FC_SHORT
             FROM TPRIZN;
    TYPE TPr IS TABLE OF cPrizn%ROWTYPE
                INDEX BY BINARY_INTEGER;
    nC NUMBER;
    cC CLOB;
    str VARCHAR2 (32767);
    Pr TPr;
    i NUMBER;
    j NUMBER;
/* procedure do_log (d in date,c in varchar2) is
 pragma autonomous_transaction;
 begin
   insert into TLOGTABLE (FD_VALUE,FC_VALUE) values (d,c);
   commit;
 end;*/
BEGIN
--  do_log(sysdate,'Begin of function is reached!');
    INSERT INTO TCLOBS (FC_CLOB)
         VALUES (EMPTY_CLOB () )
      RETURNING FK_ID, FC_CLOB INTO nC, cC;
--    j:=PROGRESS_BAR.INIT;
    DBMS_LOB.OPEN (cC, DBMS_LOB.LOB_READWRITE);
    str := PKG_HTML.GET_HEAD('excel','Своевременность поступления по санаторию "'||PKG_SMINI.READSTRING('CONFIG','S_NAME','Не известен')||'" за период с '||TO_CHAR(pFD_DATA1,'dd.mm.yyyy')||' по '||TO_CHAR(pFD_DATA2,'dd.mm.yyyy'),
                             null,'10.0',null,
                             null,null,null,
                             null,null,null,
                             '297','210','landscape',
                             null,null,null,null,
                             null,null,null,'left',
                             null,null,null,null,
                             null,null,null);
    DBMS_LOB.WRITEAPPEND (cC, LENGTH (str), str);
    str :='<BODY>'||
          '<P align="CENTER"><B>Своевременность поступления по санаторию "' ||PKG_SMINI.READSTRING ('CONFIG', 'S_NAME', 'Не известен') ||'"</B><BR> за период с ' || TO_CHAR (pFD_DATA1, 'dd.mm.yyyy') || ' по ' || TO_CHAR (pFD_DATA2, 'dd.mm.yyyy') || '</P>'||
          '<table>'||
          '<TR>'||
          ' <TD><p class=user>&nbsp;</p></TD>'||
          ' <TD class=v><p class=user>Всего:</p></TD>';
    FOR p IN cPrizn LOOP
      Pr (cPrizn%ROWCOUNT)  := p;
    END LOOP;
    FOR i IN 1 .. Pr.COUNT LOOP
      str  := str || '<TD class=v><p class=user> В т/ч ' || Pr (i).FC_SHORT || '</p></TD>';
    END LOOP;
    str  := str || '<TD class=v><p class=user>Кор.срок всего:</p></TD>';
    FOR i IN 1 .. Pr.COUNT LOOP
      str  := str ||'<TD class=v><p class=user> В т/ч ' || Pr (i).FC_SHORT || ' (к.с.)</p></TD>';
    END LOOP;
    str := str || '</TR>'||
          '<TR>'||
          '<TD class=user><P class=user>Состояло на начало отчетного периода (чел.)</P></TD>'||
          '<TD><P class=user>' || RETURN_VALUE (PAC_MOVEMENT.GET_COUNT_MORNING (pFD_DATA1) )|| '</P></TD>';
    PROGRESS_BAR.SETSTROUT ('Подсчет общего количества состоявших...');
    PROGRESS_BAR.STEPIT;
    FOR i IN 1 .. Pr.COUNT LOOP
      str  := str || '<TD><P class=user>' || RETURN_VALUE (PAC_MOVEMENT.GET_COUNT_MORNING_PRIZN (pFD_DATA1, Pr (i).FK_ID)) || '</P></TD>';
--      PROGRESS_BAR.STEPIT;
    END LOOP;
    str  := str || '<TD><P class=user>' || RETURN_VALUE (PAC_MOVEMENT.GET_COUNT_MORNING_SHORT (pFD_DATA1)) || '</P></TD>';
--    PROGRESS_BAR.STEPIT;
    FOR i IN 1 .. Pr.COUNT LOOP
      str  := str || '<TD><P class=user>' || RETURN_VALUE (PAC_MOVEMENT.GET_COUNT_MORNING_SHORT_PRIZN (pFD_DATA1, Pr (i).FK_ID)) || '</P></TD>';
--      PROGRESS_BAR.STEPIT;
    END LOOP;
    str := str || '</TR>';
    DBMS_LOB.WRITEAPPEND (cC, LENGTH (str), str);
    str :='<TR>'||
          '<TD class=user><P class=user>Прибыло в течение отчетного периода (чел.)</P></TD>'||
          '<TD><P class=user>' || RETURN_VALUE (GET_COUNT_INCOME_IN_PERIOD (pFD_DATA1, pFD_DATA2)) || '</P></TD>';
    PROGRESS_BAR.SETSTROUT ('Подсчет общего количества прибывших...');
    PROGRESS_BAR.STEPIT;
    FOR i IN 1 .. Pr.COUNT LOOP
      str  := str || '<TD><P class=user>' || RETURN_VALUE (GET_COUNT_INCOME_INPERIODPRIZN (pFD_DATA1, pFD_DATA2, Pr (i).FK_ID) )|| '</P></TD>';
--      PROGRESS_BAR.STEPIT;
    END LOOP;
    str  := str || '<TD><P class=user>' || RETURN_VALUE (GET_COUNT_INCOME_INPERIODSHORT (pFD_DATA1, pFD_DATA2) )|| '</P></TD>';
--    PROGRESS_BAR.STEPIT;
    FOR i IN 1 .. Pr.COUNT LOOP
      str  := str || '<TD><P class=user>' || RETURN_VALUE (GET_INCOME_IN_PERIODSHORTPRIZN (pFD_DATA1, pFD_DATA2, Pr (i).FK_ID) )|| '</P></TD>';
--      PROGRESS_BAR.STEPIT;
    END LOOP;
    str  := str ||'</TR>';
    DBMS_LOB.WRITEAPPEND (cC, LENGTH (str), str);
    str  := '<TR><TD class=user><P class=user>Выбыло в течение отчетного периода (чел.)</P></TD>'||
            '<TD><P class=user>' || RETURN_VALUE (GET_COUNT_OUTCOME_IN_PERIOD (pFD_DATA1, pFD_DATA2) )|| '</P></TD>';
    PROGRESS_BAR.SETSTROUT ('Подсчет общего количества выбывших...');
    PROGRESS_BAR.STEPIT;
    FOR i IN 1 .. Pr.COUNT LOOP
      str  := str || '<TD><P class=user>' || RETURN_VALUE (GET_COUNT_OUTCOMEINPERIODPRIZN (pFD_DATA1, pFD_DATA2, Pr (i).FK_ID) )|| '</P></TD>';
--      PROGRESS_BAR.STEPIT;
    END LOOP;
    str  := str || '<TD><P class=user>' || RETURN_VALUE (GET_COUNT_OUTCOMEINPERIODSHORT (pFD_DATA1, pFD_DATA2) )|| '</P></TD>';
--    PROGRESS_BAR.STEPIT;
    FOR i IN 1 .. Pr.COUNT LOOP
      str  := str || '<TD><P class=user>' || RETURN_VALUE (GET_OUTCOME_INPERIODSHORTPRIZN (pFD_DATA1, pFD_DATA2, Pr (i).FK_ID)) || '</P></TD>';
--      PROGRESS_BAR.STEPIT;
    END LOOP;
    str  := str || '</TR>';
    DBMS_LOB.WRITEAPPEND (cC, LENGTH (str), str);
    FOR z IN cVid LOOP
      PROGRESS_BAR.SETSTROUT ('Выбывшие по '||z.FC_NAME||'...');
      PROGRESS_BAR.STEPIT;
      str  := '<TR><TD class=user><P class=user>В т/ч по ' || z.FC_NAME || ' (чел.)' || '</P></TD>'||
              '<TD><P class=user>' || RETURN_VALUE (GET_COUNT_OUTCOME_IN_PERIODVID (pFD_DATA1, pFD_DATA2, z.FK_ID)) || '</P></TD>';
--      PROGRESS_BAR.STEPIT;
      FOR i IN 1 .. Pr.COUNT LOOP
        str  := str || '<TD><P class=user>' || RETURN_VALUE (GET_COUNT_OUT_PERIODVIDPRIZNPR (pFD_DATA1, pFD_DATA2, z.FK_ID, Pr (i).FK_ID) )|| '</P></TD>';
--        PROGRESS_BAR.STEPIT;
      END LOOP;
      str  := str || '<TD><P class=user>' || RETURN_VALUE (GET_COUNT_OUT_IN_PERIODVIDSH (pFD_DATA1, pFD_DATA2, z.FK_ID)) || '</P></TD>';
--      PROGRESS_BAR.STEPIT;
      FOR i IN 1 .. Pr.COUNT LOOP
        str  := str || '<TD><P class=user>' || RETURN_VALUE (GET_COUNT_OUTPERIODVIDPRIZNPRS (pFD_DATA1, pFD_DATA2, z.FK_ID, Pr (i).FK_ID) )|| '</P></TD>';
--        PROGRESS_BAR.STEPIT;
      END LOOP;
      str  := str || '</TR>';
      DBMS_LOB.WRITEAPPEND (cC, LENGTH (str), str);
      FOR n IN cSubVid (z.FK_ID) LOOP
        PROGRESS_BAR.SETSTROUT ('Выбывшие по '||z.FC_NAME||'-'||n.FC_NAME||'...');
        PROGRESS_BAR.STEPIT;
        str :='<TR><TD class=user style=''margin-left:5mm''><P class=user> - ' || n.FC_NAME || ' (чел.)' || '</P></TD>'||
              '<TD><P class=user>' || RETURN_VALUE (GET_COUNTOUTCOMEINPERIODSUBVID (pFD_DATA1, pFD_DATA2, z.FK_ID, n.FK_ID)) || '</P></TD>';
--        PROGRESS_BAR.STEPIT;
        FOR i IN 1 .. Pr.COUNT LOOP
          str  := str || '<TD><P class=user>' || RETURN_VALUE (GET_COUNTOUTINPERIODSUBVIDPR (pFD_DATA1, pFD_DATA2, z.FK_ID, n.FK_ID, Pr (i).FK_ID)) || '</P></TD>';
--          PROGRESS_BAR.STEPIT;
        END LOOP;
        str  := str || '<TD><P class=user>' || RETURN_VALUE (GET_COUNTOUTINPERIODSUBVIDSH (pFD_DATA1, pFD_DATA2, z.FK_ID, n.FK_ID)) || '</P></TD>';
--        PROGRESS_BAR.STEPIT;
        FOR i IN 1 .. Pr.COUNT LOOP
          str  := str || '<TD><P class=user>' || RETURN_VALUE (GET_COUNTOUTINPERIODSUBVIDPRSH (pFD_DATA1, pFD_DATA2, z.FK_ID, n.FK_ID, Pr (i).FK_ID) )|| '</P></TD>';
--          PROGRESS_BAR.STEPIT;
        END LOOP;
--
/*        FOR i IN 1 .. Pr.COUNT LOOP
          str  := '<TD>&nbsp;</TD><TD>&nbsp;</TD>';
          DBMS_LOB.WRITEAPPEND (cC, LENGTH (str), str);
          PROGRESS_BAR.STEPIT;
        END LOOP;
*/
        str  := str || '</TR>';
        DBMS_LOB.WRITEAPPEND (cC, LENGTH (str), str);
      END LOOP;
    END LOOP;
    PROGRESS_BAR.SETSTROUT ('Подсчет общего количества состоящих на конец отчетного периода...');
    PROGRESS_BAR.STEPIT;
    str :='<TR>'||
          '<TD class=user><P class=user>Состоит на конец отчетного периода (чел.)</P></TD>'||
          '<TD><P class=user>' || RETURN_VALUE (PAC_MOVEMENT.GET_COUNT_MORNING (pFD_DATA2 + 1))|| '</P></TD>';
    FOR i IN 1 .. Pr.COUNT LOOP
      str  := str || '<TD><P class=user>' || RETURN_VALUE (PAC_MOVEMENT.GET_COUNT_MORNING_PRIZN (pFD_DATA2 + 1, Pr (i).FK_ID) )|| '</P></TD>';
--      PROGRESS_BAR.STEPIT;
    END LOOP;
    str  := str || '<TD><P class=user>' || RETURN_VALUE (PAC_MOVEMENT.GET_COUNT_MORNING_SHORT (pFD_DATA2 + 1) )|| '</P></TD>';
--    PROGRESS_BAR.STEPIT;
    FOR i IN 1 .. Pr.COUNT LOOP
      str  := str || '<TD><P class=user>' || RETURN_VALUE (PAC_MOVEMENT.GET_COUNT_MORNING_SHORT_PRIZN (pFD_DATA2 + 1, Pr (i).FK_ID) )|| '</P></TD>';
--      PROGRESS_BAR.STEPIT;
    END LOOP;
    DBMS_LOB.WRITEAPPEND (cC, LENGTH (str), str);
    PROGRESS_BAR.SETSTROUT ('Подсчет койко-дней всего за период...');
    PROGRESS_BAR.STEPIT;
    i    := Pr.COUNT * 2 + 3;
    str  := '</TR><TR><TD COLSPAN="' || i || '"><P class=user>&nbsp;</P></TD></TR>'||
            '<TR><TD class=user><P class=user>Проведено койко-дней (к/дн.)</P></TD>'||
            '<TD><P class=user>' || RETURN_VALUE (GET_KDN_PERIOD (pFD_DATA1, pFD_DATA2) )|| '</P></TD>';
    FOR i IN 1 .. Pr.COUNT LOOP
      str  := str || '<TD><P class=user>' || RETURN_VALUE (GET_KDN_PERIOD_PRIZN (pFD_DATA1, pFD_DATA2, Pr (i).FK_ID) )|| '</P></TD>';
--      PROGRESS_BAR.STEPIT;
    END LOOP;
    str  := str || '<TD><P class=user>' || RETURN_VALUE (GET_KDN_PERIOD_SHORT (pFD_DATA1, pFD_DATA2) )|| '</P></TD>';
--    PROGRESS_BAR.STEPIT;
    FOR i IN 1 .. Pr.COUNT LOOP
      str  := str || '<TD><P class=user>' || RETURN_VALUE (GET_KDN_PERIOD_PRIZN_SHORT (pFD_DATA1, pFD_DATA2, Pr (i).FK_ID) )|| '</P></TD>';
--      PROGRESS_BAR.STEPIT;
    END LOOP;
    str  := str || '</TR>';
    DBMS_LOB.WRITEAPPEND (cC, LENGTH (str), str);
    --Койко дни по типу прибытия...
    FOR p IN cVid LOOP
      PROGRESS_BAR.SETSTROUT ('Койко-дни по '||p.FC_NAME||'...');
      PROGRESS_BAR.STEPIT;
      str  := '<TR>'||
              '<TD class=user><P class=user>В т/ч по ' || p.FC_NAME || ' (кдн.)' || '</P></TD>'||
              '<TD><P class=user>' || RETURN_VALUE (GET_KDN_PERIOD_VID (pFD_DATA1, pFD_DATA2, p.FK_ID)) || '</P></TD>';
      FOR i IN 1 .. Pr.COUNT LOOP
        str  := str || '<TD><P class=user>' || RETURN_VALUE (GET_KDN_PERIOD_PRIZN_VID (pFD_DATA1, pFD_DATA2, Pr (i).FK_ID, p.FK_ID)) || '</P></TD>';
--        PROGRESS_BAR.STEPIT;
      END LOOP;
      str  := str || '<TD><P class=user>' || RETURN_VALUE (GET_KDN_PERIOD_VID_SHORT (pFD_DATA1, pFD_DATA2, p.FK_ID)) || '</P></TD>';
--      PROGRESS_BAR.STEPIT;
      FOR i IN 1 .. Pr.COUNT LOOP
        str  := str || '<TD><P class=user>' || RETURN_VALUE (GET_KDN_PERIOD_PRIZN_VID_SHORT (pFD_DATA1, pFD_DATA2, Pr (i).FK_ID, p.FK_ID))|| '</P></TD>';
--        PROGRESS_BAR.STEPIT;
      END LOOP;
      str  := str || '</TR>';
      DBMS_LOB.WRITEAPPEND (cC, LENGTH (str), str);
      FOR n IN cSubVid (p.FK_ID) LOOP
        PROGRESS_BAR.SETSTROUT ('Койко-дни по '||p.FC_NAME||'-'||n.FC_NAME||'...');
        PROGRESS_BAR.STEPIT;
        str  := '<TR>'||
                '<TD class=user style=''margin-left:5mm''><P class=user> - ' || n.FC_NAME || ' (кдн.)' || '</P></TD>'||
                '<TD><P class=user>' || RETURN_VALUE (GET_KDN_PERIOD_SUBVID (pFD_DATA1, pFD_DATA2, p.FK_ID, n.FK_ID)) || '</P></TD>';
--        PROGRESS_BAR.STEPIT;
        FOR i IN 1 .. Pr.COUNT LOOP
          str  := str || '<TD><P class=user>' || RETURN_VALUE (GET_KDN_PERIOD_PRIZN_SUBVID (pFD_DATA1, pFD_DATA2, Pr (i).FK_ID, n.FK_ID, p.FK_ID)) || '</P></TD>';
--          PROGRESS_BAR.STEPIT;
        END LOOP;
        str  := str || '<TD><P class=user>' || RETURN_VALUE (GET_KDN_PERIOD_SUBVID_SHORT (pFD_DATA1, pFD_DATA2, p.FK_ID, n.FK_ID) )|| '</P></TD>';
--        PROGRESS_BAR.STEPIT;
        FOR i IN 1 .. Pr.COUNT LOOP
          str  := str || '<TD><P class=user>' || RETURN_VALUE (GET_KDN_PERIODPRIZNSUBVIDSHORT (pFD_DATA1, pFD_DATA2, Pr (i).FK_ID, n.FK_ID, p.FK_ID)) || '</P></TD>';
--          PROGRESS_BAR.STEPIT;
        END LOOP;
        str  := str || '</TR>';
        DBMS_LOB.WRITEAPPEND (cC, LENGTH (str), str);
      END LOOP;
    END LOOP;
    i    := Pr.COUNT * 2 + 3;
    str  := '<TR><TD COLSPAN="' || i || '"><P class=user>&nbsp;</P></TD></TR>';
    DBMS_LOB.WRITEAPPEND (cC, LENGTH (str), str);
--Опоздание
    PROGRESS_BAR.SETSTROUT ('Подсчет опоздавших...');
    PROGRESS_BAR.STEPIT;
    str  := '<TR><TD class=user><P class=user>Опоздавших (чел.)</P></TD>'||
            '<TD><P class=user>' || RETURN_VALUE (GET_COUNTV_OPOZD (pFD_DATA1, pFD_DATA2) )|| '</P></TD>';
    FOR i IN 1 .. Pr.COUNT LOOP
      str  := str || '<TD><P class=user>' || RETURN_VALUE (GET_COUNTV_OPOZD_PRIZN (pFD_DATA1, pFD_DATA2, Pr (i).FK_ID) )|| '</P></TD>';
--      PROGRESS_BAR.STEPIT;
    END LOOP;
    str  := str || '<TD><P class=user>' || RETURN_VALUE (GET_COUNTV_OPOZD_SHORT (pFD_DATA1, pFD_DATA2)) || '</P></TD>';
--    PROGRESS_BAR.STEPIT;
    FOR i IN 1 .. Pr.COUNT LOOP
      str  := str || '<TD><P class=user>' || RETURN_VALUE (GET_COUNTV_OPOZD_SHORT_PRIZN (pFD_DATA1, pFD_DATA2, Pr (i).FK_ID) )|| '</P></TD>';
--      PROGRESS_BAR.STEPIT;
    END LOOP;
    str  := str || '</TR>';
    DBMS_LOB.WRITEAPPEND (cC, LENGTH (str), str);
    PROGRESS_BAR.SETSTROUT ('Подсчет кол-ва койко дней опоздавших...');
    PROGRESS_BAR.STEPIT;
    str  := '<TR>'||
            '<TD class=user><P class=user>Число дней опоздания (к/дн.)</P></TD>'||
            '<TD><P class=user>' ||RETURN_VALUE ( GET_KDNV_OPOZD (pFD_DATA1, pFD_DATA2)) || '</P></TD>';
    FOR i IN 1 .. Pr.COUNT LOOP
      str  := str || '<TD><P class=user>' || RETURN_VALUE (GET_KDNV_OPOZD_PRIZN (pFD_DATA1, pFD_DATA2, Pr (i).FK_ID)) || '</P></TD>';
--      PROGRESS_BAR.STEPIT;
    END LOOP;
    str  := str || '<TD><P class=user>' || RETURN_VALUE (GET_KDNV_OPOZD_SHORT (pFD_DATA1, pFD_DATA2) )|| '</P></TD>';
--    PROGRESS_BAR.STEPIT;
    FOR i IN 1 .. Pr.COUNT LOOP
      str  := str || '<TD><P class=user>' || RETURN_VALUE (GET_KDNV_OPOZD_SHORT_PRIZN (pFD_DATA1, pFD_DATA2, Pr (i).FK_ID) )|| '</P></TD>';
--      PROGRESS_BAR.STEPIT;
    END LOOP;
    str  := str || '</TR>';
    DBMS_LOB.WRITEAPPEND (cC, LENGTH (str), str);
--Выбыло ранее...
    PROGRESS_BAR.SETSTROUT ('Выбыло ранее...');
    PROGRESS_BAR.STEPIT;
    str  := '<TR><TD class=user><P class=user>Выбыло ранее срока (чел.)</P></TD>'||
            '<TD><P class=user>' || RETURN_VALUE (GET_COUNT_EARLY (pFD_DATA1, pFD_DATA2) )|| '</P></TD>';
    FOR i IN 1 .. Pr.COUNT LOOP
      str  := str || '<TD><P class=user>' ||RETURN_VALUE ( GET_COUNT_EARLY_PRIZN (pFD_DATA1, pFD_DATA2, Pr (i).FK_ID)) || '</P></TD>';
--      PROGRESS_BAR.STEPIT;
    END LOOP;
    str  := str || '<TD><P class=user>' || RETURN_VALUE (GET_COUNT_EARLY_SHORT (pFD_DATA1, pFD_DATA2)) || '</P></TD>';
--    PROGRESS_BAR.STEPIT;
    FOR i IN 1 .. Pr.COUNT LOOP
      str  := str || '<TD><P class=user>' || RETURN_VALUE (GET_COUNT_EARLY_SHORT_PRIZN (pFD_DATA1, pFD_DATA2, Pr (i).FK_ID)) || '</P></TD>';
--      PROGRESS_BAR.STEPIT;
    END LOOP;
    str  := str || '</TR>';
    DBMS_LOB.WRITEAPPEND (cC, LENGTH (str), str);
    PROGRESS_BAR.SETSTROUT ('Подсчет неиспользованных койко-дней...');
    PROGRESS_BAR.STEPIT;
    str  := '<TR><TD class=user><P class=user>Не использовано к/дн (к/дн.)</P></TD>'||
            '<TD><P class=user>' || RETURN_VALUE (GET_KDN_EARLY (pFD_DATA1, pFD_DATA2) )|| '</P></TD>';
    FOR i IN 1 .. Pr.COUNT LOOP
      str  := str || '<TD><P class=user>' || RETURN_VALUE (GET_KDN_EARLY_PRIZN (pFD_DATA1, pFD_DATA2, Pr (i).FK_ID)) || '</P></TD>';
--      PROGRESS_BAR.STEPIT;
    END LOOP;
    str  := str || '<TD><P class=user>' || RETURN_VALUE (GET_KDN_EARLY_SHORT (pFD_DATA1, pFD_DATA2) )|| '</P></TD>';
--    PROGRESS_BAR.STEPIT;
    FOR i IN 1 .. Pr.COUNT LOOP
      str  := str || '<TD><P class=user>' || RETURN_VALUE (GET_KDN_EARLY_SHORT_PRIZN (pFD_DATA1, pFD_DATA2, Pr (i).FK_ID)) || '</P></TD>';
--      PROGRESS_BAR.STEPIT;
    END LOOP;
    str  := str || '</TR>';
    DBMS_LOB.WRITEAPPEND (cC, LENGTH (str), str);
--Продление
    PROGRESS_BAR.SETSTROUT ('Продлилось...');
    PROGRESS_BAR.STEPIT;
    str  := '<TR><TD class=user><P class=user>Число лиц, продливших срок лечения (чел.)</P></TD>'||
            '<TD><P class=user>' || RETURN_VALUE (GET_COUNTV_PRODL (pFD_DATA1, pFD_DATA2)) || '</P></TD>';
    FOR i IN 1 .. Pr.COUNT LOOP
      str  := str || '<TD><P class=user>' || RETURN_VALUE (GET_COUNTV_PRODL_PRIZN (pFD_DATA1, pFD_DATA2, Pr (i).FK_ID)) || '</P></TD>';
--      PROGRESS_BAR.STEPIT;
    END LOOP;
    str  := str || '<TD><P class=user>' || RETURN_VALUE (GET_COUNTV_PRODL_SHORT (pFD_DATA1, pFD_DATA2)) || '</P></TD>';
--    PROGRESS_BAR.STEPIT;
    FOR i IN 1 .. Pr.COUNT LOOP
      str  := str || '<TD><P class=user>' || RETURN_VALUE (GET_COUNTV_PRODL_SHORT_PRIZN (pFD_DATA1, pFD_DATA2, Pr (i).FK_ID) )|| '</P></TD>';
--      PROGRESS_BAR.STEPIT;
    END LOOP;
    str  := str || '</TR>';
    DBMS_LOB.WRITEAPPEND (cC, LENGTH (str), str);
    PROGRESS_BAR.SETSTROUT ('Подсчет дней продлления...');
    PROGRESS_BAR.STEPIT;
    str  := '<TR><TD class=user><P class=user>Число дней продления (к/дн.)</P></TD>'||
            '<TD><P class=user>' || RETURN_VALUE (GET_KDNV_PRODL (pFD_DATA1, pFD_DATA2)) || '</P></TD>';
    FOR i IN 1 .. Pr.COUNT LOOP
      str  := str || '<TD><P class=user>' || RETURN_VALUE (GET_KDNV_PRODL_PRIZN (pFD_DATA1, pFD_DATA2, Pr (i).FK_ID)) || '</P></TD>';
--      PROGRESS_BAR.STEPIT;
    END LOOP;
    str  := str || '<TD><P class=user>' || RETURN_VALUE (GET_KDNV_PRODL_SHORT (pFD_DATA1, pFD_DATA2) )|| '</P></TD>';
--    PROGRESS_BAR.STEPIT;
    FOR i IN 1 .. Pr.COUNT LOOP
      str  := str || '<TD><P class=user>' || RETURN_VALUE (GET_KDNV_PRODL_SHORT_PRIZN (pFD_DATA1, pFD_DATA2, Pr (i).FK_ID) )|| '</P></TD>';
--      PROGRESS_BAR.STEPIT;
    END LOOP;
    str  := str || '</TR>';
    DBMS_LOB.WRITEAPPEND (cC, LENGTH (str), str);
--Продление по типам
    j    := 7;
    LOOP
      j := j - 1;
      IF j < 4 THEN EXIT;
      END IF;
      str  := '<TR><TD class=user><P class=user>';
      IF j = 6 THEN
        str  := str || 'В т/ч продление по опозданию ';
        PROGRESS_BAR.SETSTROUT ('Продление по опозданию...');
      ELSIF j = 5 THEN
        str  := str || 'В т/ч продление за наличный расчет ';
        PROGRESS_BAR.SETSTROUT ('Продление за наличный расчет...');
      ELSE
        str  := str || 'Восстановлено ';
        PROGRESS_BAR.SETSTROUT ('Восстановлено...');
      END IF;
      PROGRESS_BAR.STEPIT;
      str  := str || ' (чел.)</TD>'||
                     '<TD><P class=user>' || RETURN_VALUE (GET_COUNTV_PRODL (pFD_DATA1, pFD_DATA2, j) )|| '</P></TD>';
      FOR i IN 1 .. Pr.COUNT LOOP
        str  := str || '<TD><P class=user>' || RETURN_VALUE (GET_COUNTV_PRODL_PRIZN (pFD_DATA1, pFD_DATA2, Pr (i).FK_ID, j)) || '</P></TD>';
--        PROGRESS_BAR.STEPIT;
      END LOOP;
      str  := str || '<TD><P class=user>' || RETURN_VALUE (GET_COUNTV_PRODL_SHORT (pFD_DATA1, pFD_DATA2, j)) || '</P></TD>';
--      PROGRESS_BAR.STEPIT;
      FOR i IN 1 .. Pr.COUNT LOOP
        str  := str || '<TD><P class=user>' || RETURN_VALUE (GET_COUNTV_PRODL_SHORT_PRIZN (pFD_DATA1, pFD_DATA2, Pr (i).FK_ID, j)) || '</P></TD>';
--        PROGRESS_BAR.STEPIT;
      END LOOP;
      str  := str || '</TR>';
      DBMS_LOB.WRITEAPPEND (cC, LENGTH (str), str);
      IF j IN (5, 6) THEN
        str  := '<TR><TD class=user style=''margin-left:3mm''><P class=user>Число дней продления (к/дн.)</P></TD>'||
                '<TD><P class=user>' || RETURN_VALUE (GET_KDNV_PRODL (pFD_DATA1, pFD_DATA2, j)) || '</P></TD>';
        PROGRESS_BAR.SETSTROUT ('Число дней продления...');
      ELSE
        str  := '<TR><TD class=user style=''margin-left:3mm''><P class=user>Число дней восстановления (к/дн.)</P></TD>'||
                '<TD><P class=user>' || RETURN_VALUE (GET_KDNV_PRODL (pFD_DATA1, pFD_DATA2, j)) || '</P></TD>';
        PROGRESS_BAR.SETSTROUT ('Число дней восстановления...');
      END IF;
      PROGRESS_BAR.STEPIT;
      FOR i IN 1 .. Pr.COUNT LOOP
        str  := str || '<TD><P class=user>' || RETURN_VALUE (GET_KDNV_PRODL_PRIZN (pFD_DATA1, pFD_DATA2, Pr (i).FK_ID, j)) || '</P></TD>';
--        PROGRESS_BAR.STEPIT;
      END LOOP;
      str  := str || '<TD><P class=user>' || RETURN_VALUE (GET_KDNV_PRODL_SHORT (pFD_DATA1, pFD_DATA2, j)) || '</P></TD>';
--      PROGRESS_BAR.STEPIT;
      FOR i IN 1 .. Pr.COUNT LOOP
        str  := str || '<TD><P class=user>' || RETURN_VALUE (GET_KDNV_PRODL_SHORT_PRIZN (pFD_DATA1, pFD_DATA2, Pr (i).FK_ID, j)) || '</P></TD>';
--        PROGRESS_BAR.STEPIT;
      END LOOP;
      str  := str || '</TR>';
      DBMS_LOB.WRITEAPPEND (cC, LENGTH (str), str);
    END LOOP;
    str  := '</TABLE><BR><P><B>Отчет составил_________________________' || DO_VRACHFIO (pFK_VRACHID);
    str  := str || '</B></P></BODY></HTML>';
    DBMS_LOB.WRITEAPPEND (cC, LENGTH (str), str);
    DBMS_LOB.CLOSE (cC);
--  do_log(sysdate,'END of function is reached!');
    RETURN nC;
  END;
  FUNCTION GET_INCOME_VITIAZ (pFD_DATA1 IN DATE, pFD_DATA2 IN DATE, pFK_VRACHID IN NUMBER) RETURN NUMBER
   IS-- Used in rIncomeVitiaz.dpr
    CURSOR c (pDATA1 DATE, pDATA2 DATE) IS
           SELECT /*+rule*/fc_fam, fc_im, fc_otch, get_pacvid (TKARTA.FK_KOD2) FC_VID, GET_PACFROMTO (TKARTA.FK_ID) FC_FROMTO,
                  TO_CHAR (FD_ROJD, 'dd.mm.yyyy') FD_ROJD, GET_PACVOZR (TKARTA.FK_ID) FN_VOZR,
                  GET_SKK (TKARTA.FK_ID) FC_SKK, FC_PUT, GET_IB (TKARTA.FK_ID) FK_IB, FC_RABOTA
             FROM TKARTA, TSROKY
            WHERE TSROKY.FK_PACID = TKARTA.FK_ID
              AND TSROKY.FD_DATA1 BETWEEN pData1 AND pData2+1-1/(24*60)
              AND TSROKY.FK_PRYB = 2;
    cC CLOB;
    nC NUMBER;
    str VARCHAR2 (32767);
  BEGIN
    PROGRESS_BAR.Setmaxvalue(4);
    PROGRESS_BAR.SETSTROUT ('Подготовка отчета...');
    PROGRESS_BAR.STEPIT;
    INSERT INTO TCLOBS (FC_CLOB)
         VALUES (EMPTY_CLOB () )
      RETURNING FK_ID, FC_CLOB INTO nC, cC;
    DBMS_LOB.OPEN (cC, DBMS_LOB.LOB_READWRITE);
    str := PKG_HTML.GET_HEAD('excel','Список заехавших в ЛОК "'||PKG_SMINI.READSTRING ('CONFIG', 'S_NAME', 'Не известен') ||'" за период с ' || TO_CHAR (pFD_DATA1, 'dd.mm.yyyy') || ' по ' || TO_CHAR (pFD_DATA2, 'dd.mm.yyyy'),
                             null,null,null,
                             null,null,null,
                             null,null,null,
                             null,null,'landscape',
                             null,null,null,null,
                             null,null,null,'left',
                             null,null,null,null,
                             null,null,null);
    DBMS_LOB.WRITEAPPEND (cC, LENGTH (str), str);
    str  :=
      '<BODY>' ||
      '<P ALIGN="CENTER"><B>Список заехавших в ЛОК "'||PKG_SMINI.READSTRING ('CONFIG', 'S_NAME', 'Не известен') ||'"</B><BR>'||
      'за период с ' || TO_CHAR (pFD_DATA1, 'dd.mm.yyyy') || ' по ' || TO_CHAR (pFD_DATA2, 'dd.mm.yyyy') ||
      '<BR>(прошедшие лечение)</P>';
    DBMS_LOB.WRITEAPPEND (cC, LENGTH (str), str);
    str  :=
      '<table>'||
      '<tr>'||
      '<TD>№ п/п:</td>'||
      '<TD colspan=3>Ф.И.О.:</td>'||
      '<TD>Категория поступления:</td>'||
      '<TD>Сроки лечения:</td>'||
      '<TD>Дата рождения:</td>'||
      '<TD>Возрастная категория:</td>'||
      '<TD>Санаторная карта:</td>'||
      '<TD>№ Путевки:</td>'||
      '<TD>№ И.Б.:</td>'||
      '<TD>Место работы:</td>'||
      '</tr>';
    DBMS_LOB.WRITEAPPEND (cC, LENGTH (str), str);
    PROGRESS_BAR.SETSTROUT ('Список прошедших лечение...');
    PROGRESS_BAR.STEPIT;
    FOR p IN c (pFD_DATA1, pFD_DATA2) LOOP
      str  :=
        '<TR><TD>' || c%ROWCOUNT || '</TD>'||
        '<TD class=user>' || RETURN_VALUE(p.FC_FAM) || '</TD>'||
        '<TD class=user>' || RETURN_VALUE(p.FC_IM) || '</TD>'||
        '<TD class=user>' || RETURN_VALUE(p.FC_OTCH) || '</TD>'||
        '<TD class=user>' || RETURN_VALUE(p.FC_VID) || '</TD>'||
        '<TD>' || RETURN_VALUE(p.FC_FROMTO) || '</TD>'||
        '<TD>' || RETURN_VALUE(p.FD_ROJD) || '</TD><TD>';
      IF p.FN_VOZR < 5 THEN
        str := str||'младше 5';
      ELSIF p.FN_VOZR < 12 THEN
        str := str||'младше 12';
      ELSIF p.FN_VOZR > 60 THEN
        str := str||'старше 60';
      ELSE
        str := str||'&nbsp;';
      END IF;
      str := str||'</TD><TD>' || RETURN_VALUE(p.FC_SKK) || '</TD>'||
                  '<TD style=''text-align:right;''>' || RETURN_VALUE(p.FC_PUT) || '</TD>'||
                  '<TD style=''mso-number-format:"\@";''>' || RETURN_VALUE(p.FK_IB) || '</TD>'||-- I mat' ego tak...
                  '<TD class=user>' || RETURN_VALUE(p.FC_RABOTA) || '</TD></TR>';
      DBMS_LOB.WRITEAPPEND (cC, LENGTH (str), str);
    END LOOP;
    PROGRESS_BAR.SETSTROUT ('Подсчет количества...');
    PROGRESS_BAR.STEPIT;
    str  := '</TABLE>'||
            '<P ALIGN="CENTER"><B>Количество отдыхающих прошедших лечение</B><BR>за период с ' || TO_CHAR (pFD_DATA1, 'dd.mm.yyyy') || ' по ' || TO_CHAR (pFD_DATA1, 'dd.mm.yyyy')||'</P>'||
            '<table>'||
            '<TR><TD>&nbsp;</TD>'||
            '<TD>Всего:</TD>'||
            '<TD>Врослых:</TD>'||
            '<TD>Старше 60:</TD>'||
            '<TD>Дети (до 12):</TD>'||
            '<TD>Младше 5:</TD></TR>'||
            '<TR><TD>Всего:</TD>'||
            '<TD>' || GET_COUNT_INCOME_PERIOD (pFD_DATA1, pFD_DATA2) || '</TD>'||
            '<TD>' || GET_COUNT_VOZR (pFD_DATA1,pFD_DATA2,12,1) ||'</TD>'||
            '<TD>' || GET_COUNT_VOZR (pFD_DATA1, pFD_DATA2, 60, 1) ||'</TD>'||
            '<TD>' || GET_COUNT_VOZR (pFD_DATA1, pFD_DATA2, 12, 0) ||'</TD>'||
            '<TD>' || GET_COUNT_VOZR (pFD_DATA1, pFD_DATA2, 5, 0) ||'</TD></TR>';
    DBMS_LOB.WRITEAPPEND (cC, LENGTH (str), str);
    str  :=
      '<TR><TD>С сан. кур.:</TD><TD>' || GET_COUNT_INCOME_PERIOD_SKK (pFD_DATA1, pFD_DATA2, 1) || '</TD><TD>' ||
        GET_COUNT_VOZR (pFD_DATA1, pFD_DATA2, 12, 1, 1) ||
        '</TD><TD>' ||
        GET_COUNT_VOZR (pFD_DATA1, pFD_DATA2, 60, 1, 1) ||
        '</TD><TD>' ||
        GET_COUNT_VOZR (pFD_DATA1, pFD_DATA2, 12, 0, 1) ||
        '</TD><TD>' ||
        GET_COUNT_VOZR (pFD_DATA1, pFD_DATA2, 5, 0, 1) ||
        '</TD></TR>';
    DBMS_LOB.WRITEAPPEND (cC, LENGTH (str), str);
    str  :=
      '<TR ALIGN="CENTER"><TD>Без сан. кур.:</TD><TD>' || GET_COUNT_INCOME_PERIOD_SKK (pFD_DATA1, pFD_DATA2, 0) || '</TD><TD>' ||
        GET_COUNT_VOZR (pFD_DATA1, pFD_DATA2, 12, 1, 0) ||
        '</TD><TD>' ||
        GET_COUNT_VOZR (pFD_DATA1, pFD_DATA2, 60, 1, 0) ||
        '</TD><TD>' ||
        GET_COUNT_VOZR (pFD_DATA1, pFD_DATA2, 12, 0, 0) ||
        '</TD><TD>' ||
        GET_COUNT_VOZR (pFD_DATA1, pFD_DATA2, 5, 0, 0) ||
        '</TD></TR>';
    DBMS_LOB.WRITEAPPEND (cC, LENGTH (str), str);
    PROGRESS_BAR.SETSTROUT ('Все почти готово...');
    PROGRESS_BAR.STEPIT;
    str  := '</TABLE><BR><P><B>Отчет составил: _________________________ ' || DO_VRACHFIO (pFK_VRACHID) || '</B></body></html>';
    DBMS_LOB.WRITEAPPEND (cC, LENGTH (str), str);
    DBMS_LOB.CLOSE (cC);
    RETURN nC;
  END;
  FUNCTION GET_LECH_ZAGR_VITIAZ (pFD_DATA1 IN DATE, pFD_DATA2 IN DATE, pFK_VRACHID IN NUMBER)
    RETURN NUMBER IS
    CURSOR cVrach IS
      SELECT/*+rule*/ DO_VRACHFIO (FK_ID) fc_fio, fk_id
        FROM tsotr
       WHERE fp_vrach = 1
       ORDER BY 1;
    CURSOR ct (pID NUMBER) IS
      SELECT/*+rule*/ COUNT (distinct tkarta.fk_id) fn_count
        FROM tkarta, tsroky
       WHERE tsroky.fk_pacid = tkarta.fk_id
         AND tsroky.fd_data1 BETWEEN pFD_DATA1 AND pFD_DATA2
         AND tsroky.fk_pryb = 2
         AND fk_kod2 = pID;
    CURSOR ccount IS
      SELECT/*+rule*/ COUNT (distinct tkarta.fk_id) fn_count
        FROM tkarta, tsroky
       WHERE tsroky.fk_pacid = tkarta.fk_id
         AND tsroky.fd_data1 BETWEEN pFD_DATA1 AND pFD_DATA2
         AND tsroky.fk_pryb = 2;
    CURSOR c (pID NUMBER, pVRACHID NUMBER) IS
      SELECT/*+rule*/ COUNT (distinct tkarta.fk_id) fn_count
        FROM tkarta, tsroky, tvrach
       WHERE tsroky.fk_pacid = tkarta.fk_id
         AND tsroky.fd_data1 BETWEEN pFD_DATA1 AND pFD_DATA2
         AND tsroky.fk_pryb = 2
         AND tvrach.fk_pacid = tkarta.fk_id
         AND tvrach.fl_vid = 'M'
         AND tvrach.fk_vrachid = pVRACHID
         AND fk_kod2 = pID;
    CURSOR cv (pVRACHID NUMBER) IS
      SELECT/*+rule*/ COUNT (distinct tkarta.fk_id) fn_count
        FROM tkarta, tsroky, tvrach
       WHERE tsroky.fk_pacid = tkarta.fk_id
         AND tsroky.fd_data1 BETWEEN pFD_DATA1 AND pFD_DATA2
         AND tsroky.fk_pryb = 2
         AND tvrach.fk_pacid = tkarta.fk_id
         AND tvrach.fl_vid = 'M'
         AND tvrach.fk_vrachid = pVRACHID;
    cC CLOB;
    nC NUMBER;
    str VARCHAR2 (4000);
    s VARCHAR2 (100);
    i NUMBER;
  BEGIN
    INSERT INTO TCLOBS
                (FC_CLOB)
         VALUES (EMPTY_CLOB () )
      RETURNING FK_ID, FC_CLOB
      INTO nC, cC;
    FILL_VID;
    DBMS_LOB.OPEN (cC, DBMS_LOB.LOB_READWRITE);
    str  :=
      '<html><head><meta http-equiv="Content-Type" content="text/html; charset=windows-1251"></head><P ALIGN="CENTER"><B>Отчет о загрузке врачей по ЛОК "' ||
        PKG_SMINI.READSTRING ('CONFIG', 'S_NAME', 'Не известен') ||
        '"</B><BR>';
    str  := str || '<ALIGN="CENTER">за период с ' || TO_CHAR (pFD_DATA1, 'dd.mm.yyyy') || ' по ' || TO_CHAR (pFD_DATA2, 'dd.mm.yyyy') || '</P>';
    DBMS_LOB.WRITEAPPEND (cC, LENGTH (str), str);
    str  := '<table align="center" width="100%" border="1" bordercolorlight="#000000" bordercolordark="#FFFFFF" bordercolor="#FFFFFF" bgcolor="#FFFFFF" cellpadding="0" cellspacing="0">';
    DBMS_LOB.WRITEAPPEND (cC, LENGTH (str), str);
    str  :=
      '<TR ALIGN="CENTER"><TD ROWSPAN="2"><B>Ф.И.О. врача:</B></TD><TD ROWSPAN="2"><B>Всего отдыхающих ха отчетный период (взрослые):</B></TD><TD COLSPAN="' || vids.COUNT ||
        '"><B>В том числе</B></TD></TR><TR ALIGN="CENTER">';
    DBMS_LOB.WRITEAPPEND (cC, LENGTH (str), str);
    FOR i IN 1 .. vids.COUNT LOOP
      str  := '<TD><B>' || vids (i).FC_NAME || ':</B></TD>';
      DBMS_LOB.WRITEAPPEND (cC, LENGTH (str), str);
    END LOOP;
    str  := '</TR>';
    FOR p IN cVrach LOOP
      OPEN cv (p.FK_ID);
      FETCH cv INTO s;
      CLOSE cv;
      str  := '<TR ALIGN="CENTER"><TD>' || p.FC_FIO || '</TD><TD>' || s || '</TD>';
      FOR i IN 1 .. vids.COUNT LOOP
        OPEN c (vids (i).FK_ID, p.FK_ID);
        FETCH c INTO s;
        CLOSE c;
        str  := str || '<TD>' || s || '</TD>';
      END LOOP;
      str  := str || '</TR>';
      DBMS_LOB.WRITEAPPEND (cC, LENGTH (str), str);
    END LOOP;
    OPEN cCount;
    FETCH cCount INTO s;
    CLOSE cCount;
    str  := '<TR ALIGN="CENTER"><TD><B>Итого:</B></TD><TD><B>' || s || '</B></TD>';
    DBMS_LOB.WRITEAPPEND (cC, LENGTH (str), str);
    FOR i IN 1 .. vids.COUNT LOOP
      OPEN ct (vids (i).FK_ID);
      FETCH ct INTO s;
      CLOSE ct;
      str  := '<TD><B>' || s || '</B></TD>';
      DBMS_LOB.WRITEAPPEND (cC, LENGTH (str), str);
    END LOOP;
    str  := '</TR>';
    DBMS_LOB.WRITEAPPEND (cC, LENGTH (str), str);
    str  := '</TABLE></BODY></HTML>';
    DBMS_LOB.WRITEAPPEND (cC, LENGTH (str), str);
    DBMS_LOB.CLOSE (cC);
    RETURN nC;
  END;
  FUNCTION GET_COUNT_INCOME_VITIAZ (pFD_DATA1 IN DATE, pFD_DATA2 IN DATE, pFK_VRACHID IN NUMBER)
    RETURN NUMBER IS
    cC CLOB;
    nC NUMBER;
    str VARCHAR2 (4000);
    s VARCHAR2 (100);
    i NUMBER;
    nTotal NUMBER;
  BEGIN
    INSERT INTO TCLOBS
                (FC_CLOB)
         VALUES (EMPTY_CLOB () )
      RETURNING FK_ID, FC_CLOB
      INTO nC, cC;
    PROGRESS_BAR.SETMAXVALUE (4);
    DBMS_LOB.OPEN (cC, DBMS_LOB.LOB_READWRITE);
    str     :=
      '<html><head><meta http-equiv="Content-Type" content="text/html; charset=windows-1251"></head><P ALIGN="CENTER"><B>Отчет о прибывших за период по ЛОК "' ||
        PKG_SMINI.READSTRING ('CONFIG', 'S_NAME', 'Не известен') ||
        '"</B><BR>';
    str     := str || '<ALIGN="CENTER">за период с ' || TO_CHAR (pFD_DATA1, 'dd.mm.yyyy') || ' по ' || TO_CHAR (pFD_DATA2, 'dd.mm.yyyy') || '</P>';
    DBMS_LOB.WRITEAPPEND (cC, LENGTH (str), str);
    str     := '<P><table align="center" width="100%" border="1" bordercolorlight="#000000" bordercolordark="#FFFFFF" bordercolor="#FFFFFF" bgcolor="#FFFFFF" cellpadding="0" cellspacing="0">';
    DBMS_LOB.WRITEAPPEND (cC, LENGTH (str), str);
    PROGRESS_BAR.SETSTROUT ('Общее количество');
    PROGRESS_BAR.STEPIT;
    str     := '<TR ALIGN="CENTER"><TD>&nbsp;</TD><TD ><B>Прибыло:</B></TD><TD><B>Без сан. карт.:</B></TD><TD><B>С сан.карт.:</B></TD><TD><B>Без СЭО:</B></TD><TD><B>С СЭО:</B></TD></TR>';
    DBMS_LOB.WRITEAPPEND (cC, LENGTH (str), str);
    str     :=
      '<TR ALIGN="CENTER"><TD><B>Всего:</B></TD><TD>' || GET_COUNT_INCOME_PERIOD (pFD_DATA1, pFD_DATA2) || '</TD><TD>' || GET_COUNT_INCOME_PERIOD_SKK (pFD_DATA1, pFD_DATA2, 0) || '</TD><TD>' ||
        GET_COUNT_INCOME_PERIOD_SKK (pFD_DATA1, pFD_DATA2, 1) ||
        '</TD>';
    str     := str || '<TD>' || GET_COUNT_INCOME_PERIOD_SEO (pFD_DATA1, pFD_DATA2, 0) || '</TD><TD>' || GET_COUNT_INCOME_PERIOD_SEO (pFD_DATA1, pFD_DATA2, 1) || '</TD></TR>';
    DBMS_LOB.WRITEAPPEND (cC, LENGTH (str), str);
    PROGRESS_BAR.STEPIT;
    str     :=
      '<TR ALIGN="CENTER"><TD><B>Взрослые:</B></TD><TD>' || GET_COUNT_VOZR (pFD_DATA1, pFD_DATA2, 18, 1) || '</TD><TD>' || GET_COUNT_VOZR (pFD_DATA1, pFD_DATA2, 18, 1, 0) || '</TD><TD>' ||
        GET_COUNT_VOZR (pFD_DATA1, pFD_DATA2, 18, 1, 1) ||
        '</TD>';
    str     := str || '<TD>' || GET_COUNT_VOZR_SEO (pFD_DATA1, pFD_DATA2, 18, 1, 0) || '</TD><TD>' || GET_COUNT_VOZR_SEO (pFD_DATA1, pFD_DATA2, 18, 1, 1) || '</TD></TR>';
    DBMS_LOB.WRITEAPPEND (cC, LENGTH (str), str);
    str     :=
      '<TR ALIGN="CENTER"><TD><B>Дети:</B></TD><TD>' || GET_COUNT_VOZR (pFD_DATA1, pFD_DATA2, 18, 0) || '</TD><TD>' || GET_COUNT_VOZR (pFD_DATA1, pFD_DATA2, 18, 0, 0) || '</TD><TD>' ||
        GET_COUNT_VOZR (pFD_DATA1, pFD_DATA2, 18, 0, 1) ||
        '</TD>';
    str     := str || '<TD>' || GET_COUNT_VOZR_SEO (pFD_DATA1, pFD_DATA2, 18, 0, 0) || '</TD><TD>' || GET_COUNT_VOZR_SEO (pFD_DATA1, pFD_DATA2, 18, 0, 1) || '</TD></TR>';
    DBMS_LOB.WRITEAPPEND (cC, LENGTH (str), str);
    str     := '</TABLE></P>';
    DBMS_LOB.WRITEAPPEND (cC, LENGTH (str), str);
    PROGRESS_BAR.SETSTROUT ('% отношение к абсолютному числу прибывших');
    PROGRESS_BAR.STEPIT;
    str     := '<P ALIGN="CENTER"><B>% отношение к абсолютному числу прибывших</B>';
    DBMS_LOB.WRITEAPPEND (cC, LENGTH (str), str);
    str     := '<table align="center" width="100%" border="1" bordercolorlight="#000000" bordercolordark="#FFFFFF" bordercolor="#FFFFFF" bgcolor="#FFFFFF" cellpadding="0" cellspacing="0">';
    DBMS_LOB.WRITEAPPEND (cC, LENGTH (str), str);
    str     :=
      '<TR ALIGN="CENTER"><TD>&nbsp;</TD><TD ><B>Общее число:</B></TD><TD><B>% от числа:</B></TD><TD><B>Без сан. карт.:</B></TD><TD><B>% от числа:</B></TD><TD><B>С сан.карт.:</B></TD><TD><B>% от числа:</B></TD><TD><B>Без СЭО:</B><TD><B>% от числа:</B></TD></TD><TD><B>С СЭО:</B></TD><TD><B>% от числа:</B></TD></TR>';
    DBMS_LOB.WRITEAPPEND (cC, LENGTH (str), str);
    PROGRESS_BAR.STEPIT;
    str     :=
      '<TR ALIGN="CENTER"><TD><B>1</B></TD><TD><B>2</B></TD><TD><B>3</B></TD><TD><B>4</B></TD><TD><B>5</B></TD><TD><B>6</B></TD><TD><B>7</B></TD><TD><B>8</B><TD><B>9</B></TD></TD><TD><B>10</B></TD><TD><B>11</B></TD></TR>';
    DBMS_LOB.WRITEAPPEND (cC, LENGTH (str), str);
    nTotal  := GET_COUNT_INCOME_PERIOD (pFD_DATA1, pFD_DATA2);
    str     :=
      '<TR ALIGN="CENTER"><TD><B>Всего:</B></TD><TD>' || nTotal || '</TD><TD>100%</TD><TD>' || GET_COUNT_INCOME_PERIOD_SKK (pFD_DATA1, pFD_DATA2, 0) || '</TD><TD>' ||
        TO_CHAR ( (GET_COUNT_INCOME_PERIOD_SKK (pFD_DATA1, pFD_DATA2, 0) / nTotal) * 100, '990.00') ||
        '%</TD><TD>' ||
        GET_COUNT_INCOME_PERIOD_SKK (pFD_DATA1, pFD_DATA2, 1) ||
        '</TD><TD>' ||
        TO_CHAR ( (GET_COUNT_INCOME_PERIOD_SKK (pFD_DATA1, pFD_DATA2, 1) / nTotal) * 100, '990.00') ||
        '%</TD>';
    str     :=
      str || '<TD>' || GET_COUNT_INCOME_PERIOD_SEO (pFD_DATA1, pFD_DATA2, 0) || '</TD><TD>' || TO_CHAR ( (GET_COUNT_INCOME_PERIOD_SEO (pFD_DATA1, pFD_DATA2, 0) / nTotal) * 100, '990.00') || '%</TD><TD>' ||
        GET_COUNT_INCOME_PERIOD_SEO (pFD_DATA1, pFD_DATA2, 1) ||
        '</TD><TD>' ||
        TO_CHAR ( (GET_COUNT_INCOME_PERIOD_SEO (pFD_DATA1, pFD_DATA2, 1) / nTotal) * 100, '990.00') ||
        '%</TD></TR>';
    DBMS_LOB.WRITEAPPEND (cC, LENGTH (str), str);
    PROGRESS_BAR.STEPIT;
    str     :=
      '<TR ALIGN="CENTER"><TD><B>Взрослые:</B></TD><TD>' || GET_COUNT_VOZR (pFD_DATA1, pFD_DATA2, 18, 1) || '</TD><TD>' || TO_CHAR ( (GET_COUNT_VOZR (pFD_DATA1, pFD_DATA2, 18, 1) / nTotal) * 100,
                                                                                                                             '990.00'
                                                                                                                           ) ||
        '%</TD><TD>' ||
        GET_COUNT_VOZR (pFD_DATA1, pFD_DATA2, 18, 1, 0) ||
        '</TD><TD>' ||
        TO_CHAR ( (GET_COUNT_VOZR (pFD_DATA1, pFD_DATA2, 18, 1, 0) / nTotal) * 100, '990.00') ||
        '%</TD><TD>' ||
        GET_COUNT_VOZR (pFD_DATA1, pFD_DATA2, 18, 1, 1) ||
        '</TD><TD>' ||
        TO_CHAR ( (GET_COUNT_VOZR (pFD_DATA1, pFD_DATA2, 18, 1, 1) / nTotal) * 100, '990.00') ||
        '%</TD>';
    str     :=
      str || '<TD>' || GET_COUNT_VOZR_SEO (pFD_DATA1, pFD_DATA2, 18, 1, 0) || '</TD><TD>' || TO_CHAR ( (GET_COUNT_VOZR_SEO (pFD_DATA1, pFD_DATA2, 18, 1, 0) / nTotal) * 100, '990.00') || '%</TD><TD>' ||
        GET_COUNT_VOZR_SEO (pFD_DATA1, pFD_DATA2, 18, 1, 1) ||
        '</TD><TD>' ||
        TO_CHAR ( (GET_COUNT_VOZR_SEO (pFD_DATA1, pFD_DATA2, 18, 1, 1) / nTotal) * 100, '990.00') ||
        '%</TD></TR>';
    DBMS_LOB.WRITEAPPEND (cC, LENGTH (str), str);
    str     :=
      '<TR ALIGN="CENTER"><TD><B>Дети:</B></TD><TD>' || GET_COUNT_VOZR (pFD_DATA1, pFD_DATA2, 18, 0) || '</TD><TD>' || TO_CHAR ( (GET_COUNT_VOZR (pFD_DATA1, pFD_DATA2, 18, 0) / nTotal) * 100, '990.00') ||
        '%</TD><TD>' ||
        GET_COUNT_VOZR (pFD_DATA1, pFD_DATA2, 18, 0, 0) ||
        '</TD><TD>' ||
        TO_CHAR ( (GET_COUNT_VOZR (pFD_DATA1, pFD_DATA2, 18, 0, 0) / nTotal) * 100, '990.00') ||
        '%</TD><TD>' ||
        GET_COUNT_VOZR (pFD_DATA1, pFD_DATA2, 18, 0, 1) ||
        '</TD><TD>' ||
        TO_CHAR ( (GET_COUNT_VOZR (pFD_DATA1, pFD_DATA2, 18, 0, 1) / nTotal) * 100, '990.00') ||
        '%</TD>';
    str     :=
      str || '<TD>' || GET_COUNT_VOZR_SEO (pFD_DATA1, pFD_DATA2, 18, 0, 0) || '</TD><TD>' || TO_CHAR ( (GET_COUNT_VOZR_SEO (pFD_DATA1, pFD_DATA2, 18, 0, 0) / nTotal) * 100, '990.00') || '%</TD><TD>' ||
        GET_COUNT_VOZR_SEO (pFD_DATA1, pFD_DATA2, 18, 0, 1) ||
        '</TD><TD>' ||
        TO_CHAR ( (GET_COUNT_VOZR_SEO (pFD_DATA1, pFD_DATA2, 18, 0, 1) / nTotal) * 100, '990.00') ||
        '%</TD></TR>';
    DBMS_LOB.WRITEAPPEND (cC, LENGTH (str), str);
    str     := '</TABLE></P>';
    DBMS_LOB.WRITEAPPEND (cC, LENGTH (str), str);
    PROGRESS_BAR.SETSTROUT ('% отношение к абсолютному числу детей');
    PROGRESS_BAR.STEPIT;
    str     := '<P ALIGN="CENTER"><B>% отношение к абсолютному числу детей</B>';
    DBMS_LOB.WRITEAPPEND (cC, LENGTH (str), str);
    str     := '<table align="center" width="100%" border="1" bordercolorlight="#000000" bordercolordark="#FFFFFF" bordercolor="#FFFFFF" bgcolor="#FFFFFF" cellpadding="0" cellspacing="0">';
    DBMS_LOB.WRITEAPPEND (cC, LENGTH (str), str);
    str     :=
      '<TR ALIGN="CENTER"><TD>&nbsp;</TD><TD ><B>Общее число:</B></TD><TD><B>% от числа:</B></TD><TD><B>Без сан. карт.:</B></TD><TD><B>% от числа:</B></TD><TD><B>С сан.карт.:</B></TD><TD><B>% от числа:</B></TD><TD><B>Без СЭО:</B><TD><B>% от числа:</B></TD></TD><TD><B>С СЭО:</B></TD><TD><B>% от числа:</B></TD></TR>';
    DBMS_LOB.WRITEAPPEND (cC, LENGTH (str), str);
    PROGRESS_BAR.STEPIT;
    nTotal  := GET_COUNT_VOZR (pFD_DATA1, pFD_DATA2, 18, 0);
    str     :=
      '<TR ALIGN="CENTER"><TD><B>Дети:</B></TD><TD>' || GET_COUNT_VOZR (pFD_DATA1, pFD_DATA2, 18, 0) || '</TD><TD>' || TO_CHAR ( (GET_COUNT_VOZR (pFD_DATA1, pFD_DATA2, 18, 0) / nTotal) * 100, '990.00') ||
        '%</TD><TD>' ||
        GET_COUNT_VOZR (pFD_DATA1, pFD_DATA2, 18, 0, 0) ||
        '</TD><TD>' ||
        TO_CHAR ( (GET_COUNT_VOZR (pFD_DATA1, pFD_DATA2, 18, 0, 0) / nTotal) * 100, '990.00') ||
        '%</TD><TD>' ||
        GET_COUNT_VOZR (pFD_DATA1, pFD_DATA2, 18, 0, 1) ||
        '</TD><TD>' ||
        TO_CHAR ( (GET_COUNT_VOZR (pFD_DATA1, pFD_DATA2, 18, 0, 1) / nTotal) * 100, '990.00') ||
        '%</TD>';
    str     :=
      str || '<TD>' || GET_COUNT_VOZR_SEO (pFD_DATA1, pFD_DATA2, 18, 0, 0) || '</TD><TD>' || TO_CHAR ( (GET_COUNT_VOZR_SEO (pFD_DATA1, pFD_DATA2, 18, 0, 0) / nTotal) * 100, '990.00') || '%</TD><TD>' ||
        GET_COUNT_VOZR_SEO (pFD_DATA1, pFD_DATA2, 18, 0, 1) ||
        '</TD><TD>' ||
        TO_CHAR ( (GET_COUNT_VOZR_SEO (pFD_DATA1, pFD_DATA2, 18, 0, 1) / nTotal) * 100, '990.00') ||
        '%</TD></TR>';
    DBMS_LOB.WRITEAPPEND (cC, LENGTH (str), str);
    str     := '</TABLE></P>';
    DBMS_LOB.WRITEAPPEND (cC, LENGTH (str), str);
    PROGRESS_BAR.SETSTROUT ('% отношение к абсолютному числу взрослых');
    PROGRESS_BAR.STEPIT;
    str     := '<P ALIGN="CENTER"><B>% отношение к абсолютному числу взрослых</B>';
    DBMS_LOB.WRITEAPPEND (cC, LENGTH (str), str);
    str     := '<table align="center" width="100%" border="1" bordercolorlight="#000000" bordercolordark="#FFFFFF" bordercolor="#FFFFFF" bgcolor="#FFFFFF" cellpadding="0" cellspacing="0">';
    DBMS_LOB.WRITEAPPEND (cC, LENGTH (str), str);
    str     :=
      '<TR ALIGN="CENTER"><TD>&nbsp;</TD><TD ><B>Общее число:</B></TD><TD><B>% от числа:</B></TD><TD><B>Без сан. карт.:</B></TD><TD><B>% от числа:</B></TD><TD><B>С сан.карт.:</B></TD><TD><B>% от числа:</B></TD><TD><B>Без СЭО:</B><TD><B>% от числа:</B></TD></TD><TD><B>С СЭО:</B></TD><TD><B>% от числа:</B></TD></TR>';
    PROGRESS_BAR.STEPIT;
    DBMS_LOB.WRITEAPPEND (cC, LENGTH (str), str);
    nTotal  := GET_COUNT_VOZR (pFD_DATA1, pFD_DATA2, 18, 1);
    str     :=
      '<TR ALIGN="CENTER"><TD><B>Взрослые:</B></TD><TD>' || GET_COUNT_VOZR (pFD_DATA1, pFD_DATA2, 18, 1) || '</TD><TD>' || TO_CHAR ( (GET_COUNT_VOZR (pFD_DATA1, pFD_DATA2, 18, 1) / nTotal) * 100,
                                                                                                                             '990.00'
                                                                                                                           ) ||
        '%</TD><TD>' ||
        GET_COUNT_VOZR (pFD_DATA1, pFD_DATA2, 18, 1, 0) ||
        '</TD><TD>' ||
        TO_CHAR ( (GET_COUNT_VOZR (pFD_DATA1, pFD_DATA2, 18, 1, 0) / nTotal) * 100, '990.00') ||
        '%</TD><TD>' ||
        GET_COUNT_VOZR (pFD_DATA1, pFD_DATA2, 18, 1, 1) ||
        '</TD><TD>' ||
        TO_CHAR ( (GET_COUNT_VOZR (pFD_DATA1, pFD_DATA2, 18, 1, 1) / nTotal) * 100, '990.00') ||
        '%</TD>';
    str     :=
      str || '<TD>' || GET_COUNT_VOZR_SEO (pFD_DATA1, pFD_DATA2, 18, 1, 0) || '</TD><TD>' || TO_CHAR ( (GET_COUNT_VOZR_SEO (pFD_DATA1, pFD_DATA2, 18, 1, 0) / nTotal) * 100, '990.00') || '%</TD><TD>' ||
        GET_COUNT_VOZR_SEO (pFD_DATA1, pFD_DATA2, 18, 1, 1) ||
        '</TD><TD>' ||
        TO_CHAR ( (GET_COUNT_VOZR_SEO (pFD_DATA1, pFD_DATA2, 18, 1, 1) / nTotal) * 100, '990.00') ||
        '%</TD></TR>';
    PROGRESS_BAR.STEPIT;
    DBMS_LOB.WRITEAPPEND (cC, LENGTH (str), str);
    str     := '</TABLE></P>';
    DBMS_LOB.WRITEAPPEND (cC, LENGTH (str), str);
    str     := '</BODY></HTML>';
    DBMS_LOB.WRITEAPPEND (cC, LENGTH (str), str);
    DBMS_LOB.CLOSE (cC);
    RETURN nC;
  END;
  FUNCTION GET_COUNT_MORNING_AGE (pFD_DATAC IN DATE, pFN_AGE IN NUMBER, pFL_GREATER IN NUMBER)
    RETURN NUMBER IS
    CURSOR c IS
            SELECT COUNT (*) AS fn_count
              FROM (SELECT fk_ibid, fc_fam
                      FROM tsroky, TKARTA
                     WHERE TRUNC(fd_data1) < pFD_DATAC
                       AND TRUNC(fd_data3) >= pFD_DATAC
                       and fk_pryb not in (1,3,7)
                       AND TKARTA.FK_ID = FK_PACID
                       AND GET_PACVOZR (TKARTA.FK_ID) < pFN_AGE
                     UNION
                    SELECT fk_ibid, fc_fam
                      FROM tsroky, TKARTA
                     WHERE TRUNC(fd_data1) = pFD_DATAC
                       AND TRUNC(fd_data3) >= pFD_DATAC
                       and fk_pryb in (5,6)
                       AND TKARTA.FK_ID = FK_PACID
                       AND GET_PACVOZR (TKARTA.FK_ID) < pFN_AGE);
    CURSOR c1 IS
            SELECT COUNT (*) AS fn_count
              FROM (SELECT fk_ibid, fc_fam
                      FROM tsroky, TKARTA
                     WHERE TRUNC(fd_data1) < pFD_DATAC
                       AND TRUNC(fd_data3) >= pFD_DATAC
                       and fk_pryb not in (1,3,7)
                       AND TKARTA.FK_ID = FK_PACID
                       AND GET_PACVOZR (TKARTA.FK_ID) >= pFN_AGE
                     UNION
                    SELECT fk_ibid, fc_fam
                      FROM tsroky, TKARTA
                     WHERE TRUNC(fd_data1) = pFD_DATAC
                       AND TRUNC(fd_data3) >= pFD_DATAC
                       and fk_pryb in (5,6)
                       AND TKARTA.FK_ID = FK_PACID
                       AND GET_PACVOZR (TKARTA.FK_ID) >= pFN_AGE);
    i NUMBER;
  BEGIN
    IF pFL_GREATER = 1 THEN
      OPEN c1;
      FETCH c1 INTO i;
      CLOSE c1;
    ELSE
      OPEN c;
      FETCH c INTO i;
      CLOSE c;
    END IF;
    RETURN i;
  END;
  --Прибытие по возрастам
  FUNCTION GET_COUNT_IN_AGE (pFD_DATAC IN DATE, pFN_AGE IN NUMBER, pFL_GREATER IN NUMBER)
  RETURN NUMBER
   IS
    CURSOR c IS
           SELECT COUNT (fk_id)
             FROM tsroky
            where fd_data1 between pFD_DATAC and pFD_DATAC+1-1/(24*60)
              AND fk_pryb = 2
              AND GET_PACVOZR (FK_PACID) >= pFN_AGE;
    CURSOR c1 IS
           SELECT COUNT (fk_id)
             FROM tsroky
            where fd_data1 between pFD_DATAC and pFD_DATAC+1-1/(24*60)
              AND fk_pryb = 2
              AND GET_PACVOZR (FK_PACID) < pFN_AGE;
    i NUMBER;
  BEGIN
    IF pFL_GREATER = 1 THEN
      OPEN c;
      FETCH c INTO i;
      CLOSE c;
    ELSE
      OPEN c1;
      FETCH c1 INTO i;
      CLOSE c1;
    END IF;
    RETURN i;
  END;
  FUNCTION GET_COUNT_RECOVER_AGE (pFD_DATAC IN DATE, pFN_AGE IN NUMBER, pFL_GREATER IN NUMBER)
  RETURN NUMBER
   IS
    CURSOR c IS
            SELECT COUNT (fk_id)
              FROM tsroky
             where fd_data1 between pFD_DATAC and pFD_DATAC+1-1/(24*60)
               AND fk_pryb = 4
               AND GET_PACVOZR (FK_PACID) >= pFN_AGE;
    CURSOR c1 IS
            SELECT COUNT (fk_id)
              FROM tsroky
             where fd_data1 between pFD_DATAC and pFD_DATAC+1-1/(24*60)
               AND fk_pryb = 4
               AND GET_PACVOZR (FK_PACID) < pFN_AGE;
    i NUMBER;
  BEGIN
    IF pFL_GREATER = 1 THEN
      OPEN c;
      FETCH c INTO i;
      CLOSE c;
    ELSE
      OPEN c1;
      FETCH c1 INTO i;
      CLOSE c1;
    END IF;
    RETURN i;
  END;
  FUNCTION GET_COUNT_PRYB_AGE (pFD_DATAC IN DATE, pFN_AGE IN NUMBER, pFL_GREATER IN NUMBER)
  RETURN VARCHAR2
   IS
    i NUMBER;
    j NUMBER;
  BEGIN
    i  := GET_COUNT_RECOVER_AGE (pFD_DATAC, pFN_AGE, pFL_GREATER);
    j  := GET_COUNT_IN_AGE (pFD_DATAC, pFN_AGE, pFL_GREATER);
    IF i > 0 THEN
      RETURN j || '+' || i;
    ELSE
      IF j > 0 THEN
        RETURN j;
      END IF;
    END IF;
    RETURN NULL;
  END;
--Конец прибытие по возрастам
--Прибытие по возрастам
  FUNCTION GET_COUNT_OUT_AGE (pFD_DATAC IN DATE, pFN_AGE IN NUMBER, pFL_GREATER IN NUMBER)
  RETURN NUMBER
   IS
    CURSOR c IS
           SELECT COUNT (fk_id)
             FROM tsroky
            where fd_data1 between pFD_DATAC and pFD_DATAC+1-1/(24*60)
              AND fk_pryb = 3
              AND GET_PACVOZR (FK_PACID) >= pFN_AGE;
    CURSOR c1 IS
           SELECT COUNT (fk_id)
             FROM tsroky
            where fd_data1 between pFD_DATAC and pFD_DATAC+1-1/(24*60)
              AND fk_pryb = 3
              AND GET_PACVOZR (FK_PACID) < pFN_AGE;
    i NUMBER;
  BEGIN
    IF pFL_GREATER = 1 THEN
      OPEN c;
      FETCH c INTO i;
      CLOSE c;
    ELSE
      OPEN c1;
      FETCH c1 INTO i;
      CLOSE c1;
    END IF;
    RETURN i;
  END;
  FUNCTION GET_COUNT_TEMPOUT_AGE (pFD_DATAC IN DATE, pFN_AGE IN NUMBER, pFL_GREATER IN NUMBER)
  RETURN NUMBER
   IS
    CURSOR c IS
           SELECT COUNT (fk_id)
             FROM tsroky
            where fd_data1 between pFD_DATAC and pFD_DATAC+1-1/(24*60)
              AND fk_pryb = 7
              AND GET_PACVOZR (FK_PACID) >= pFN_AGE;
    CURSOR c1 IS
           SELECT COUNT (fk_id)
             FROM tsroky
            where fd_data1 between pFD_DATAC and pFD_DATAC+1-1/(24*60)
              AND fk_pryb = 7
              AND GET_PACVOZR (FK_PACID) < pFN_AGE;
    i NUMBER;
  BEGIN
    IF pFL_GREATER = 1 THEN
      OPEN c;
      FETCH c INTO i;
      CLOSE c;
    ELSE
      OPEN c1;
      FETCH c1 INTO i;
      CLOSE c1;
    END IF;
    RETURN i;
  END;
  FUNCTION GET_COUNT_VYB_AGE (pFD_DATAC IN DATE, pFN_AGE IN NUMBER, pFL_GREATER IN NUMBER)
  RETURN VARCHAR2
   IS
    i NUMBER;
    j NUMBER;
  BEGIN
    i  := GET_COUNT_TEMPOUT_AGE (pFD_DATAC, pFN_AGE, pFL_GREATER);
    j  := GET_COUNT_OUT_AGE (pFD_DATAC, pFN_AGE, pFL_GREATER);
    IF i > 0 THEN
      RETURN j || '+' || i;
    ELSE
      IF j > 0 THEN
        RETURN j;
      END IF;
    END IF;
    RETURN NULL;
  END;
--Конец выбытие по возрастам
--Койко дни досрочного отъезда
  FUNCTION GET_COUNT_DO (pFD_DATAC IN DATE)
  RETURN NUMBER
   IS
    CURSOR c IS
           SELECT SUM (fn_kol)
             FROM TSROKY
            WHERE fd_data1 between pFD_DATAC and pFD_DATAC+1-1/(24*60)
              AND FK_PRYB = 3
              AND FN_KOL > 0;
    i NUMBER;
  BEGIN
    OPEN c;
    FETCH c INTO i;
    CLOSE c;
    RETURN i;
  END;
  FUNCTION GET_COUNT_DO (pFD_DATA1 IN DATE, pFD_DATA2 IN DATE)
  RETURN NUMBER
   IS
    CURSOR c IS
           SELECT SUM (fn_kol)
             FROM TSROKY
            WHERE fd_data1 BETWEEN pFD_DATA1 AND pFD_DATA2+1-1/(24*60)
              AND FK_PRYB = 3
              AND FN_KOL > 0;
    i NUMBER;
  BEGIN
    OPEN c;
    FETCH c INTO i;
    CLOSE c;
    RETURN NVL(i,0);
  END;
--Конец койко дни досрочного отъезда
  FUNCTION GET_PACMOVEMENT_MASHUK (pFD_DATA1 IN DATE, pFD_DATA2 IN DATE, pFK_VRACHID IN NUMBER)
  RETURN NUMBER
  IS-- Used in rPacMoveMash.dpr
    cC CLOB;
    nC NUMBER;
    str VARCHAR2 (32767);
    nTemp NUMBER;
    s VARCHAR2 (100);
  BEGIN
    INSERT INTO TCLOBS (FC_CLOB)
         VALUES (EMPTY_CLOB () )
      RETURNING FK_ID, FC_CLOB INTO nC, cC;
    DBMS_LOB.OPEN (cC, DBMS_LOB.LOB_READWRITE);
    str := PKG_HTML.GET_HEAD('word','Отчет о движении пациентов по санаторию "' ||PKG_SMINI.READSTRING('CONFIG','S_NAME','Не известен')||'"',
                             null,null,null,
                             null,null,null,
                             null,null,null,
                             null,null,null,
                             null,null,null,null,
                             null,null,null,null,
                             null,null,null,null,
                             null,null,null);
    DBMS_LOB.WRITEAPPEND (cC, LENGTH (str), str);
    str :='<BODY><P ALIGN="CENTER"><B>Отчет о движении пациентов по санаторию "'||PKG_SMINI.READSTRING('CONFIG','S_NAME','Не известен')||'"</B><BR>'||
          'за период с ' || TO_CHAR (pFD_DATA1, 'dd.mm.yyyy') || ' по ' || TO_CHAR (pFD_DATA2, 'dd.mm.yyyy') || '</P><BR>'||
          '<table>';
    DBMS_LOB.WRITEAPPEND (cC, LENGTH (str), str);
    str :='<TR>'||
          '<TD><B>Дата:</B></TD>'||
          '<TD><B>Состояло на начало дня:</B></TD>'||
          '<TD><B>Прибыло:</B></TD>'||
          '<TD><B>Выбыло:</B></TD>'||
          '<TD><B>Состоит на конец дня:</B></TD>'||
          '<TD><B>Д/О:</B></TD>'||
          '<TD><B>К/дни:</B></TD>'||
          '</TR>';
    DBMS_LOB.WRITEAPPEND (cC, LENGTH (str), str);
    FOR d IN 0 .. pFD_DATA2 - pFD_DATA1 LOOP
      str:='<TR><TD>' || TO_CHAR (pFD_DATA1 + d, 'dd.mm.yyyy') || '</TD>';
--Состояло на начало дня...
      str:=str||'<TD>' || PAC_MOVEMENT.GET_COUNT_MORNING (pFD_DATA1 + d);
      nTemp  := GET_COUNT_MORNING_AGE (pFD_DATA1 + d, 15, 0);
      IF nTemp > 0 THEN
        str  := str || '(' || nTemp || ')';
      END IF;
      str    := str || '</TD>';
-- Конец состояло на начало дня...
--Прибыло
      str    := str || '<TD>' || PAC_MOVEMENT.GET_COUNT_PRYB (pFD_DATA1 + d);
      s      := GET_COUNT_PRYB_AGE (pFD_DATA1 + d, 15, 0);
      IF s IS NOT NULL THEN
        str  := str || '(' || s || ')';
      END IF;
      str    := str || '</TD>';
--Конец прибыло...
--ВЫбыло
      str    := str || '<TD>' || PAC_MOVEMENT.GET_COUNT_VYB (pFD_DATA1 + d);
      s      := GET_COUNT_VYB_AGE (pFD_DATA1 + d, 15, 0);
      IF s IS NOT NULL THEN
        str  := str || '(' || s || ')';
      END IF;
      str    := str || '</TD>';
--Конец Выбыло...
--Состояло на конец дня...
      str    := str || '<TD>' || PAC_MOVEMENT.GET_COUNT_MORNING (pFD_DATA1 + d + 1);
      nTemp  := GET_COUNT_MORNING_AGE (pFD_DATA1 + d + 1, 15, 0);
      IF nTemp > 0 THEN
        str  := str || '(' || nTemp || ')';
      END IF;
      str    := str || '</TD>';
-- Конец состоит на конец дня...
--До...
      str    := str || '<TD>';
      s      := GET_COUNT_DO (pFD_DATA1 + d);
      IF s IS NULL THEN
        s  := '-';
      END IF;
      str    := str || s || '</TD>';
--Конец до....
--Кдн...
      str    := str || '<TD>' || PAC_MOVEMENT.GET_KDN (pFD_DATA1 + d) || '</TD>';
--Конец кдн....
      str    := str || '</TR>';
      DBMS_LOB.WRITEAPPEND (cC, LENGTH (str), str);
      PROGRESS_BAR.SETSTROUT (TO_CHAR (pFD_DATA1 + d, 'dd.mm.yyyy') );
      PROGRESS_BAR.STEPIT;
    END LOOP;
    str  :=
      '<TR><TD><B>Итого:</B></TD>'||
      '<TD>&nbsp;</TD>'||
      '<TD><B>' || GET_COUNT_INCOME_PERIOD (pFD_DATA1, pFD_DATA2) || '</B></TD>'||
      '<TD><B>' || GET_COUNT_OUT_PERIOD (pFD_DATA1, pFD_DATA2) || '</B></TD>'||
      '<TD>&nbsp;</TD>'||
      '<TD><B>' || GET_COUNT_DO (pFD_DATA1, pFD_DATA2) || '</B></td>'||
      '<TD><B>' || GET_KDN_PERIOD (pFD_DATA1, pFD_DATA2) || '</B></TD></TR>';
    DBMS_LOB.WRITEAPPEND (cC, LENGTH (str), str);
    str  := '</TABLE>'||
            '<BR><P><B>Отчет составил: _________________________ ' || DO_VRACHFIO (pFK_VRACHID) || '</B></P></BODY></HTML>';
    DBMS_LOB.WRITEAPPEND (cC, LENGTH (str), str);
    DBMS_LOB.CLOSE (cC);
    RETURN nC;
  END;
  FUNCTION GET_OUT_PEOPLE_MASHUK (pFD_DATA1 IN DATE, pFD_DATA2 IN DATE, pFK_VRACHID IN NUMBER)
  RETURN NUMBER
   IS-- Used in rPacUutPeriod.dpr
    CURSOR c IS
      SELECT DISTINCT FK_IBID, FK_IBY, GET_IB (FK_PACID) FK_IB, GET_PACFIO (FK_PACID) FC_FIO, DO_VRACHFIO (GET_PACVRACH (FK_PACID) ) FC_VFIO
        FROM TSROKY T1, TKARTA
       WHERE FD_DATA3 BETWEEN pFD_DATA1 AND pFD_DATA2+1-1/(24*60)
         AND TKARTA.FK_ID = FK_PACID
         AND T1.FK_ID = (SELECT MAX (FK_ID)
                           FROM TSROKY
                          WHERE FK_PRYB IN (2, 4, 5, 6)
                            AND FK_VYB = 3 -- << Modified by TimurLan
                            AND FK_PACID = t1.FK_PACID)
       ORDER BY FK_IBY, FK_IBID;
    cC CLOB;
    nC NUMBER;
    str VARCHAR2 (32767);
  BEGIN
    INSERT INTO TCLOBS (FC_CLOB)
         VALUES (EMPTY_CLOB () )
      RETURNING FK_ID, FC_CLOB INTO nC, cC;
    DBMS_LOB.OPEN (cC, DBMS_LOB.LOB_READWRITE);
    str := PKG_HTML.GET_HEAD('word','Список выписанных пациентов по санаторию "' ||PKG_SMINI.READSTRING('CONFIG','S_NAME','Не известен')||'"',
                             null,null,null,
                             null,null,null,
                             null,null,null,
                             '297','210','landscape',
                             '20','10','20','20',
                             null,null,null,'right',
                             null,null,null,null,
                             null,null,null);
    DBMS_LOB.WRITEAPPEND (cC, LENGTH (str), str);
    str  :=
      '<BODY><div class=user><P ALIGN="CENTER"><B>Список выписанных пациентов по санаторию "' || PKG_SMINI.READSTRING ('CONFIG', 'S_NAME', 'Не известен') || '"</B><BR>'||
      'за период с ' || TO_CHAR (pFD_DATA1, 'dd.mm.yyyy') || ' по ' || TO_CHAR (pFD_DATA2, 'dd.mm.yyyy') || '</P><BR>'||
      '<table>';
    DBMS_LOB.WRITEAPPEND (cC, LENGTH (str), str);
    str  := '<TR>'||
            '<TD><B>№ п/п:</B></TD>'||
            '<TD><B>№ И.Б.:</B></TD>'||
            '<TD><B>Ф.И.О.:</B></TD>'||
            '<TD><B>Врач:</B></TD>';
    FOR i IN 1 .. 20 LOOP
      str  := str || '<TD>&nbsp;</TD>';
    END LOOP;
    str  := str || '</TR>';
    DBMS_LOB.WRITEAPPEND (cC, LENGTH (str), str);
    FOR p IN c LOOP
      str  := '<TR><TD>' || c%ROWCOUNT || '</TD>'||
              '<TD class=user>' || p.FK_IB || '</TD>'||
              '<TD style=''text-align:left''>' || p.FC_FIO || '</TD>'||
              '<TD class=user>' || p.FC_VFIO || '</TD>';
      FOR i IN 1 .. 20 LOOP
        str  := str || '<TD>&nbsp;</TD>';
      END LOOP;
      str  := str || '</TR>';
      DBMS_LOB.WRITEAPPEND (cC, LENGTH (str), str);
    END LOOP;
    str  := '</TABLE>'||
            '<BR><P><B>Отчет составил: _________________________ ' || DO_VRACHFIO (pFK_VRACHID) || '</B></P></div></BODY></HTML>';
    DBMS_LOB.WRITEAPPEND (cC, LENGTH (str), str);
    DBMS_LOB.CLOSE (cC);
    RETURN nC;
  END;
  PROCEDURE DO_FILL_MONTHS (nYear IN NUMBER) IS
    i NUMBER;
  BEGIN
    Month (1).sName   := 'Январь';
    Month (2).sName   := 'Февраль';
    Month (3).sName   := 'Март';
    Month (4).sName   := 'Апрель';
    Month (5).sName   := 'Май';
    Month (6).sName   := 'Июнь';
    Month (7).sName   := 'Июль';
    Month (8).sName   := 'Август';
    Month (9).sName   := 'Сентябрь';
    Month (10).sName  := 'Откябрь';
    Month (11).sName  := 'Ноябрь';
    Month (12).sName  := 'Декабрь';
    FOR i IN 1 .. 12 LOOP
      Month (i).dData1  := TO_DATE ('01.' || i || '.' || nYear, 'dd.mm.yyyy');
      IF i = 12 THEN
        Month (i).dData2  := TO_DATE ('31.' || i || '.' || nYear, 'dd.mm.yyyy');
      ELSE
        Month (i).dData2  := TO_DATE ('01.' || (i + 1) || '.' || nYear, 'dd.mm.yyyy') - 1;
      END IF;
    END LOOP;
  END;
  FUNCTION GET_COUNT_PUT_GROUP_PERIOD (dData1 IN DATE, dData2 IN DATE, nGroup IN NUMBER)
  RETURN NUMBER
   IS
    CURSOR c (pD1 DATE, pD2 DATE, nG NUMBER) IS
           SELECT /*+ rule*/COUNT (DISTINCT TPUTS.FC_PUT)
             FROM TKARTA, TSROKY, TPUTS
            WHERE TKARTA.FK_ID = TSROKY.FK_PACID
              AND TSROKY.FK_PRYB = 2
              AND FD_DATA1 BETWEEN pD1 AND pD2+1-1/(24*60)
              AND TKARTA.FK_GROUPID = nG
              AND TPUTS.FK_PACID = TKARTA.FK_ID;
    i NUMBER;
  BEGIN
    OPEN c (dData1, dData2, nGroup);
    FETCH c INTO i;
    CLOSE c;
    RETURN i;
  END;
  FUNCTION GET_COUNT_PUT_PERIOD (dData1 IN DATE, dData2 IN DATE)
  RETURN NUMBER
   IS
    CURSOR c (pD1 DATE, pD2 DATE) IS
           SELECT /*+ rule*/COUNT (DISTINCT TPUTS.FC_PUT)
             FROM TKARTA, TSROKY, TPUTS
            WHERE TKARTA.FK_ID = TSROKY.FK_PACID
              AND TSROKY.FK_PRYB = 2
              AND FD_DATA1 BETWEEN pD1 AND pD2+1-1/(24*60)
              AND TPUTS.FK_PACID = TKARTA.FK_ID;
    i NUMBER;
  BEGIN
    OPEN c (dData1, dData2);
    FETCH c INTO i;
    CLOSE c;
    RETURN i;
  END;
------------------------------------------------------------------------------------------------------------
--########################################################################################################--
------------------------------------------------------------------------------------------------------------
  FUNCTION GET_RASP_PUT_MASHUK (nMonth1 IN NUMBER, nMonth2 IN NUMBER, nYear IN NUMBER, pFK_VRACHID IN NUMBER)
  RETURN NUMBER
   IS-- Used in rRaspPutPred.dpr
    CURSOR c IS SELECT FC_NAME, FK_ID FROM TGROUP order by 1;
    cC CLOB;
    nC NUMBER;
    str VARCHAR2 (32767);
    i NUMBER;
    s VARCHAR2 (4000);
    d1 DATE;
    d2 DATE;
  BEGIN
    DO_FILL_MONTHS (nYear);
    INSERT INTO TCLOBS (FC_CLOB)
         VALUES (EMPTY_CLOB () )
      RETURNING FK_ID, FC_CLOB INTO nC, cC;
    DBMS_LOB.OPEN (cC, DBMS_LOB.LOB_READWRITE);
    str := PKG_HTML.GET_HEAD('excel','Сведения по фактическому заезду отдыхающих по санаторию "' ||PKG_SMINI.READSTRING ('CONFIG', 'S_NAME', 'Не известен') ||'"',
                             null,null,null,
                             null,null,null,
                             null,null,null,
                             null,null,'landscape',
                             '.78','.39','.78','.78',
                             null,null,null,'left',
                             null,null,null,null,
                             null,null,null);
    DBMS_LOB.WRITEAPPEND (cC, LENGTH (str), str);
    s := Month (nMonth1).sName;
    if (nMonth1 = 3) OR (nMonth1 = 8) then
      s := s || 'а';
    else
      s := SUBSTR (s, 1, LENGTH (s) - 1) || 'я';
    end if;
    str := '<BODY><P ALIGN="CENTER"><B>Сведения по фактическому заезду отдыхающих по санаторию "' || PKG_SMINI.READSTRING ('CONFIG', 'S_NAME', 'Не известен') || '"</B><BR>'||
           'за период с ' || s || ' по ' || Month (nMonth2).sName || ' ' || nYear || ' года</P><BR>'||
           '<table>';
    DBMS_LOB.WRITEAPPEND (cC, LENGTH (str), str);
    str  := '<TR><TD><B>Наименование предприятия:</B></TD>';
    FOR i IN nMonth1 .. nMonth2 LOOP
      str  := str || '<TD class=v><B>' || Month (i).sName || '</B></TD>';
    END LOOP;
    str  := str || '<TD class=v><B>Итого факт:</B></TD>'||
                   '<TD class=v><B>Итого план на ' || nYear || ' год:</B></TD></TR>';
    DBMS_LOB.WRITEAPPEND (cC, LENGTH (str), str);
    PROGRESS_BAR.SETMAXVALUE (468);
    FOR p IN c LOOP
      str  := '<TR><TD class=user>' || c%ROWCOUNT || '. ' || p.FC_NAME || '</TD>';
      FOR i IN nMonth1 .. nMonth2 LOOP
        d1:=Month (i).dData1;
        d2:=Month (i).dData2;
        str  := str || '<TD>' || RETURN_VALUE( GET_COUNT_PUT_GROUP_PERIOD (d1, d2, p.FK_ID) ) || '</TD>';
        PROGRESS_BAR.SETSTROUT ('Подсчет путевок по ' || p.FC_NAME || ' за ' || Month (i).sName);
        PROGRESS_BAR.STEPIT;
      END LOOP;
      d1:=Month (nMonth1).dData1;
      d2:=Month (nMonth2).dData2;
      str  := str || '<TD><B>' || RETURN_VALUE( GET_COUNT_PUT_GROUP_PERIOD (d1, d2, p.FK_ID) ) || '</B></TD>'||
                     '<TD>&nbsp;</TD></TR>';
      DBMS_LOB.WRITEAPPEND (cC, LENGTH (str), str);
    END LOOP;
    str  := '<TR><TD class=user><B>Итого:</B></TD>';
    FOR i IN nMonth1 .. nMonth2 LOOP
      d1:=Month (i).dData1;
      d2:=Month (i).dData2;
      str  := str || '<TD><B>' || GET_COUNT_PUT_PERIOD (d1, d2) || '</B></TD>';
      PROGRESS_BAR.SETSTROUT ('Подсчет общего количества путевок за ' || Month (i).sName);
      PROGRESS_BAR.STEPIT;
    END LOOP;
    d1:=Month (nMonth1).dData1;
    d2:=Month (nMonth2).dData2;
    str  := str || '<TD><B>' || GET_COUNT_PUT_PERIOD (d1, d2) || '</B></TD>'||
                   '<TD>&nbsp;</TD></TR>';
    DBMS_LOB.WRITEAPPEND (cC, LENGTH (str), str);
    str  := '</TABLE><BR><P><B>Отчет составил: _________________________ ' || DO_VRACHFIO (pFK_VRACHID) || '</B></P></BODY></HTML>';
    DBMS_LOB.WRITEAPPEND (cC, LENGTH (str), str);
    DBMS_LOB.CLOSE (cC);
    RETURN nC;
  END;
  FUNCTION GET_COUNT_INCOME_PERIOD_PUT (pFD_DATA1 IN DATE, pFD_DATA2 IN DATE)
    RETURN NUMBER IS
    CURSOR c IS
      SELECT/*+rule*/ COUNT (DISTINCT TPUTS.FC_PUT)
        FROM TSROKY, TKARTA, TPUTS
       WHERE FK_PRYB = 2
         AND TRUNC(FD_DATA1) BETWEEN pFD_DATA1 AND pFD_DATA2
         AND TKARTA.FK_ID = TSROKY.FK_PACID
         AND TPUTS.FK_PACID = TKARTA.FK_ID
         AND IS_FCPUT_MORE_ZERO(TPUTS.FC_PUT) > 0;
    i NUMBER;
  BEGIN
    OPEN c;
    FETCH c INTO i;
    CLOSE c;
    RETURN i;
  END;
  FUNCTION GET_COUNT_PEREHOD_PUT (pFD_DATA1 IN DATE)
    RETURN NUMBER IS
    CURSOR c IS
      SELECT/*+rule*/ COUNT (DISTINCT TPUTS.FC_PUT)
        FROM TSROKY, TKARTA, TPUTS
       WHERE TKARTA.FK_ID = TSROKY.FK_PACID
         AND TRUNC(FD_DATA1) <= pFD_DATA1
         AND FK_PRYB IN (2, 4, 5, 6)
         AND TRUNC(FD_DATA3) > pFD_DATA1
         AND TPUTS.FK_PACID = TKARTA.FK_ID;
    i NUMBER;
  BEGIN
    OPEN c;
    FETCH c INTO i;
    CLOSE c;
    RETURN i;
  END;
  FUNCTION GET_COUNT_PEREHOD_KDN (pFD_DATA1 IN DATE)
    RETURN NUMBER IS
    CURSOR c IS
      SELECT/*+rule*/ SUM (TRUNC(FD_DATA3) - pFD_DATA1)
        FROM tsroky,
             (SELECT DISTINCT FK_ID FK_VID
                FROM TSROKY
               WHERE TRUNC(FD_DATA1) <= pFD_DATA1
                 AND FK_PRYB IN (2, 4, 5, 6)
                 AND TRUNC(FD_DATA3) > pFD_DATA1)
       WHERE fk_id = fk_vid;
    i NUMBER;
  BEGIN
    OPEN c;
    FETCH c INTO i;
    CLOSE c;
    IF i IS NULL THEN
      i  := 0;
    END IF;
    RETURN i;
  END;
  FUNCTION GET_COUNT_DIV_KDN (pFD_DATA1 IN DATE, pFD_DATA2 IN DATE)
    RETURN NUMBER IS
    CURSOR c IS
      SELECT COUNT (DISTINCT FK_PACID), COUNT (DISTINCT FC_PUT)
        FROM (SELECT tputs.fc_put, tputs.fk_pacid, get_count_putputs (tputs.fk_pacid, pFD_DATA1, pFD_DATA2) FN_CPUT, get_count_pacputs (tputs.fc_put, pFD_DATA1, pFD_DATA2) FN_CPAC
                FROM tputs, tsroky
               WHERE FD_DATA1 BETWEEN pFD_DATA1 AND pFD_DATA2+1-1/(24*60)
                 AND fk_pryb = 2
                 AND TPUTS.FK_PACID = TSROKY.FK_PACID)
       WHERE fn_cpac > 1
          OR fn_cput > 1
       ORDER BY FC_PUT;
    nPut NUMBER;
    nPac NUMBER;
    nSum NUMBER;
  BEGIN
    nSum  := 0;
    OPEN c;
    FETCH c INTO nPac, nPut;
    CLOSE c;
    BEGIN
      nSum  := (21 - TRUNC ( (nPut * 21) / nPac) + 1) * nPut;
      EXCEPTION WHEN OTHERS THEN NULL;
    END;
    RETURN nSum;
  END;
  FUNCTION GET_KDN_PERIOD_MASHUK (pFD_DATA1 IN DATE, pFD_DATA2 IN DATE, pFK_VRACHID IN NUMBER)
    RETURN NUMBER IS-- Used in rKDNPerMashuk.dpr
    cC CLOB;
    nC NUMBER;
    str VARCHAR2 (32767);
  BEGIN
    INSERT INTO TCLOBS (FC_CLOB)
         VALUES (EMPTY_CLOB () )
      RETURNING FK_ID, FC_CLOB INTO nC, cC;
    DBMS_LOB.OPEN (cC, DBMS_LOB.LOB_READWRITE);
    str := PKG_HTML.GET_HEAD('word','Отчет о койко-днях по санаторию "' ||PKG_SMINI.READSTRING('CONFIG','S_NAME','Не известен')||'"',
                             null,null,'Courier New',
                             null,null,null,
                             null,null,null,
                             null,null,null,
                             null,null,null,null,
                             null,null,null,null,
                             null,null,null,null,
                             null,null,null);
    DBMS_LOB.WRITEAPPEND (cC, LENGTH (str), str);
    str := '<BODY><P ALIGN="CENTER"><B>Отчет о койко-днях по санаторию "' || PKG_SMINI.READSTRING ('CONFIG', 'S_NAME', 'Не известен') || '"</B><BR>'||
           'за период с ' || TO_CHAR (pFD_DATA1, 'dd.mm.yyyy') || ' по ' || TO_CHAR (pFD_DATA2, 'dd.mm.yyyy') || '</P>';
    DBMS_LOB.WRITEAPPEND (cC, LENGTH (str), str);
    PROGRESS_BAR.SETSTROUT ('Подсчет общего количества койко-дней');
    PROGRESS_BAR.STEPIT;
    str  := '<BR><P class=user>Койко-дней всего - <B>' || GET_KDN_PERIOD (pFD_DATA1, pFD_DATA2) || '</B> к/дн.';
    PROGRESS_BAR.SETSTROUT ('Подсчет общего количества прибывших');
    PROGRESS_BAR.STEPIT;
    str  := str || '<BR>Прибыло - <B>' || GET_COUNT_INCOME_PERIOD (pFD_DATA1, pFD_DATA2) || '</B> чел. (<B>' || GET_COUNT_INCOME_PERIOD_PUT (pFD_DATA1, pFD_DATA2) || '</B> пут.)';
    PROGRESS_BAR.SETSTROUT ('Подсчет общего количества досрочных отъездов');
    PROGRESS_BAR.STEPIT;
    str  := str || '<BR>Досрочный отъезд - <B>' || GET_COUNT_DO (pFD_DATA1, pFD_DATA2) || '</B> к/дн.';
    PROGRESS_BAR.SETSTROUT ('Подсчет общего количества переходячих путевок');
    PROGRESS_BAR.STEPIT;
    str  := str || '<BR>Переходящих - <B>' || GET_COUNT_PEREHOD_PUT (pFD_DATA2) || '</B> пут.';
    PROGRESS_BAR.SETSTROUT ('Подсчет общего количества переходящих койко-дней');
    PROGRESS_BAR.STEPIT;
    str  := str || '<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; - <B>' || GET_COUNT_PEREHOD_KDN (pFD_DATA2) || '</B> к/дн.';
    PROGRESS_BAR.SETSTROUT ('Подсчет общего количества делящихся путевок');
    PROGRESS_BAR.STEPIT;
    str  := str || '<BR>Деление - <B>' || GET_COUNT_DIV_KDN (pFD_DATA1, pFD_DATA2) || '</B> к/дн.';
    str  := str || '</P><BR><P><B>Отчет составил: _________________________ ' || DO_VRACHFIO (pFK_VRACHID) || '</B></P></BODY></HTML>';
    DBMS_LOB.WRITEAPPEND (cC, LENGTH (str), str);
    DBMS_LOB.CLOSE (cC);
    RETURN nC;
  END;
  FUNCTION GET_COUNT_VYP_COC_GROUP (pFD_DATA1 IN DATE, pFD_DATA2 IN DATE, pFK_COC IN NUMBER, pFK_GROUP IN NUMBER)
  RETURN NUMBER
   IS
    CURSOR c IS
           SELECT COUNT (tkarta.fk_id) AS FN_COUNT
             FROM tkarta,(SELECT DISTINCT tsroky.fk_pacid
                            FROM tsroky
                           WHERE fd_data1 BETWEEN pFD_DATA1 AND pFD_DATA2+1-1/(24*60)
                             AND fk_pryb = 3)
            WHERE fk_coc_polid = pFK_COC
              AND fk_id = fk_pacid
              AND fk_groupid = pFK_GROUP;
    i NUMBER;
  BEGIN
    OPEN c;
    FETCH c INTO i;
    CLOSE c;
    RETURN i;
  END;
  FUNCTION GET_COUNT_VYP_COC_NK (pFD_DATA1 IN DATE, pFD_DATA2 IN DATE, pFK_COC IN NUMBER)
  RETURN NUMBER
   IS
    CURSOR c IS
           SELECT COUNT (tkarta.fk_id) AS FN_COUNT
             FROM tkarta,(SELECT DISTINCT tsroky.fk_pacid
                            FROM tsroky
                           WHERE fd_data1 BETWEEN pFD_DATA1 AND pFD_DATA2+1-1/(24*60)
                             AND fk_pryb = 3),
                         (SELECT fk_id fk_vgroupid
                            FROM tgroup
                           WHERE fl_Kont = 0)
            WHERE fk_coc_polid = pFK_COC
              AND fk_id = fk_pacid
              AND fk_groupid = fk_vgroupid;
    i NUMBER;
  BEGIN
    OPEN c;
    FETCH c INTO i;
    CLOSE c;
    RETURN i;
  END;
  FUNCTION GET_COUNT_VYP_COC (pFD_DATA1 IN DATE, pFD_DATA2 IN DATE, pFK_COC IN NUMBER)
  RETURN NUMBER
   IS
    CURSOR c IS
           SELECT COUNT (tkarta.fk_id) AS FN_COUNT
             FROM tkarta,(SELECT DISTINCT tsroky.fk_pacid
                            FROM tsroky
                           WHERE fd_data1 BETWEEN pFD_DATA1 AND pFD_DATA2+1-1/(24*60)
                             AND fk_pryb = 3)
            WHERE fk_coc_polid = pFK_COC
              AND fk_id = fk_pacid;
    i NUMBER;
  BEGIN
    OPEN c;
    FETCH c INTO i;
    CLOSE c;
    RETURN i;
  END;
  FUNCTION GET_COUNT_VYP_GROUP (pFD_DATA1 IN DATE, pFD_DATA2 IN DATE, pFK_COC IN NUMBER)
  RETURN NUMBER
   IS
    CURSOR c IS
           SELECT COUNT (tkarta.fk_id) AS FN_COUNT
             FROM tkarta,(SELECT DISTINCT tsroky.fk_pacid
                            FROM tsroky
                           WHERE fd_data1 BETWEEN pFD_DATA1 AND pFD_DATA2+1-1/(24*60)
                             AND fk_pryb = 3)
            WHERE fk_groupid = pFK_COC
              AND fk_id = fk_pacid;
    i NUMBER;
  BEGIN
    OPEN c;
    FETCH c INTO i;
    CLOSE c;
    RETURN i;
  END;
  FUNCTION GET_COUNT_VYP_NK (pFD_DATA1 IN DATE, pFD_DATA2 IN DATE)
  RETURN NUMBER
   IS
    CURSOR c IS
           SELECT COUNT (tkarta.fk_id) AS FN_COUNT
             FROM tkarta,(SELECT DISTINCT tsroky.fk_pacid
                            FROM tsroky
                           WHERE fd_data1 BETWEEN pFD_DATA1 AND pFD_DATA2+1-1/(24*60)
                             AND fk_pryb = 3),
                         (SELECT fk_id fk_vgroupid
                            FROM tgroup
                           WHERE fl_Kont = 0)
            WHERE fk_id = fk_pacid
              AND fk_groupid = fk_vgroupid;
    i NUMBER;
  BEGIN
    OPEN c;
    FETCH c INTO i;
    CLOSE c;
    RETURN i;
  END;
  FUNCTION GET_COUNT_VYP (pFD_DATA1 IN DATE, pFD_DATA2 IN DATE)
  RETURN NUMBER
   IS
    CURSOR c IS
           SELECT COUNT (distinct tsroky.fk_pacid)
             FROM tsroky
            WHERE fd_data1 BETWEEN pFD_DATA1 AND pFD_DATA2+1-1/(24*60)
              AND fk_pryb = 3;
    i NUMBER;
  BEGIN
    OPEN c;
    FETCH c INTO i;
    CLOSE c;
    RETURN i;
  END;
  FUNCTION DO_CALC_SOC_SOSTAV (pFD_DATA1 IN DATE, pFD_DATA2 IN DATE, pFK_VRACHID IN NUMBER)-- Modified by TimurLan
  RETURN NUMBER
   IS-- Used in rSocCoc.dpr
    CURSOR cCoc IS SELECT fk_id, fc_name FROM tcoc_pol ORDER BY FC_NAME;
    CURSOR cGroup IS SELECT fk_id, /*FC_SHORT*/ fc_name FROM tgroup/*WHERE FL_KONT=1*/ ORDER BY FL_KONT DESC, fc_name;
    CURSOR cCountKont IS SELECT COUNT (FK_ID) FROM TGROUP WHERE FL_KONT = 1;
    TYPE TpCG IS TABLE OF cGroup%ROWTYPE
                 INDEX BY BINARY_INTEGER;
    nC NUMBER;
    cC CLOB;
    str VARCHAR2 (32767);
    pCG TpCG;
    nK NUMBER;
    z NUMBER;
    nTemp NUMBER;
  BEGIN
    PROGRESS_BAR.SETSTROUT('Подготовка отчета..');
    nTemp:=0;
    FOR p IN cGroup LOOP
      pCG (cGroup%ROWCOUNT)  := p;
    END LOOP;
    OPEN cCountKont;
    FETCH cCountKont INTO nK;
    CLOSE cCountKont;
    SELECT COUNT(FK_ID) INTO z FROM TCOC_POL;
    z := (z + 1) * (pCG.COUNT + 2);
    PROGRESS_BAR.SETMAXValue (z);
    PROGRESS_BAR.SETSTEPVALUE (1);
    INSERT INTO TCLOBS (FC_CLOB)
         VALUES (EMPTY_CLOB () )
      RETURNING FK_ID, FC_CLOB INTO nC, cC;
    DBMS_LOB.OPEN (cC, DBMS_LOB.LOB_READWRITE);
    str := PKG_HTML.GET_HEAD('excel','Социальный состав лечившихся в санатории "'||PKG_SMINI.READSTRING('CONFIG','S_NAME','Не известен')||'" за период с '||TO_CHAR(pFD_DATA1,'dd.mm.yyyy')||' по '||TO_CHAR(pFD_DATA2,'dd.mm.yyyy'),
                             null,null,null,
                             null,null,null,
                             null,null,null,
                             null,null,'landscape',
                             null,null,null,null,
                             null,null,null,'left',
                             null,null,null,null,
                             null,null,null);
    DBMS_LOB.WRITEAPPEND (cC, LENGTH (str), str);
    if nK = 0 then nTemp := 1; end if;
    str := '<BODY>'||
           '<P ALIGN="CENTER"><B>Социальный состав лечившихся в санатории "' || PKG_SMINI.READSTRING ('CONFIG', 'S_NAME', 'Не известен') || '"</B><BR>'||'за период с ' || TO_CHAR (pFD_DATA1, 'dd.mm.yyyy') || ' по ' || TO_CHAR (pFD_DATA2, 'dd.mm.yyyy') || '</P>'||
           '<table>'||
           '<TR>'||
           ' <TD ROWSPAN="2">Состав лечившихся и отдыхающих:</TD>'||
           ' <TD COLSPAN="' || nTemp || '">Контингент поликлиник МЦ</TD>'||
           ' <TD COLSPAN="' || (pCG.COUNT - nK) ||'">Другие лечебные учреждения (не контингент)</TD>'||
           ' <TD ROWSPAN="2"><B>Всего:</B></TD>'||
           '</TR>';
    DBMS_LOB.WRITEAPPEND (cC, LENGTH (str), str);
    if nK = 0 then
      str:='<TR><TD class=v>не найдено</TD>';
    else
      str:='<TR>';
    end if;
    FOR i IN 1 .. pCG.COUNT LOOP
      str  := str || '<TD class=v>' || pCG (i).FC_NAME || ' (осн.чл.сем.)</TD>';
    END LOOP;
    str  := STR || '</TR>';
    DBMS_LOB.WRITEAPPEND (cC, LENGTH (str), str);
    FOR p IN cCoc LOOP
      str  := '<TR><TD class=user>' || p.FC_NAME || '</TD>';
      if nK = 0 then
        str:=str||'<TD>-</TD>';
      end if;
      FOR i IN 1 .. pCG.COUNT LOOP
        str  := str||'<TD>' || RETURN_VALUE(GET_COUNT_VYP_COC_GROUP (pFD_DATA1, pFD_DATA2, p.FK_ID, pCg (i).FK_ID)) || '</TD>';
        PROGRESS_BAR.SETStrOut (p.FC_NAME||' - '||pCG(i).FC_NAME);
        PROGRESS_BAR.STEPIT;
      END LOOP;
      str  :=/*'<TD>'||GET_COUNT_VYP_COC_NK(pFD_DATA1,pFD_DATA2,p.FK_ID)||'</TD>*/ str || '<TD><B>' || RETURN_VALUE(GET_COUNT_VYP_COC (pFD_DATA1, pFD_DATA2, p.FK_ID)) || '</B></TD></TR>';
      DBMS_LOB.WRITEAPPEND (cC, LENGTH (str), str);
      PROGRESS_BAR.STEPIT (2);
    END LOOP;
    str  := '<TR><TD class=user><B>Итого:</B></TD>';
    if nK = 0 then
      str:=str||'<TD><B>-</B></TD>';
    end if;
    FOR i IN 1 .. pCG.COUNT LOOP
      str  := str||'<TD><B>' || GET_COUNT_VYP_GROUP (pFD_DATA1, pFD_DATA2, pCg (i).FK_ID) || '</B></TD>';
      PROGRESS_BAR.SETStrOut ('Итого - '||pCG(i).FC_NAME);
      PROGRESS_BAR.STEPIT;
    END LOOP;
    str  :=/*'<TD><B>'||GET_COUNT_VYP_NK(pFD_DATA1, pFD_DATA2)||'</B></TD>*/ str||'<TD><B>' || GET_COUNT_VYP (pFD_DATA1, pFD_DATA2) || '</B></TD></TR>';
    DBMS_LOB.WRITEAPPEND (cC, LENGTH (str), str);
    PROGRESS_BAR.STEPIT (2);
    str  := '</TABLE>'||
            '<BR><P><B>Отчет составил: _________________________ ' || DO_VRACHFIO (pFK_VRACHID) || '</B></body></html>';
    DBMS_LOB.WRITEAPPEND (cC, LENGTH (str), str);
    DBMS_LOB.CLOSE (cC);
    RETURN nC;
  END;
FUNCTION DO_DINNER_REPORT(pFK_PACID IN NUMBER,pFK_VRACHID IN NUMBER) RETURN NUMBER
 IS-- Created by TimurLan
CURSOR cMAIN
 IS
  SELECT GET_PACFULLFIO(TKARTA.FK_ID) FC_FIO,
         TPEOPLES.FD_ROJD,
         GET_COC_POL(TKARTA.FK_COC_POLID) FC_COC_POL,
         GET_GROUP(TKARTA.FK_GROUPID) FC_GROUP,
         GET_PRIZN(TKARTA.FK_PRIZN) FC_PRIZN,
         GET_PACINCOME(TKARTA.FK_ID) FD_DATA1,
         GET_PACPLANOUTCOME(TKARTA.FK_ID) FD_DATA3,
         GET_PACFCPALATA(TKARTA.FK_ID) FC_PALATA
  from TKARTA, TPEOPLES
  where TKARTA.FK_ID=pFK_PACID
  AND TPEOPLES.FK_ID=TKARTA.FK_PEPLID;
 cl CLOB;
 str VARCHAR2(32767);
 rc NUMBER;
 pFC_FIO VARCHAR2(200);
 pFD_ROJD DATE;
 pFC_COC_POL VARCHAR2(30);
 pFC_GROUP VARCHAR2(100);
 pFC_PRIZN VARCHAR2(100);
 pFD_DATA1 DATE;
 pFD_DATA3 DATE;
 pFC_PALATA VARCHAR(20);
BEGIN
  OPEN cMAIN;
  FETCH cMAIN INTO pFC_FIO, pFD_ROJD, pFC_COC_POL, pFC_GROUP, pFC_PRIZN, pFD_DATA1, pFD_DATA3, pFC_PALATA;
  CLOSE cMAIN;
  INSERT INTO TCLOBS(FC_CLOB) VALUES(EMPTY_CLOB()) RETURNING FK_ID,FC_CLOB INTO rC,cl;
  DBMS_LOB.OPEN(cl,DBMS_LOB.LOB_READWRITE);
--
  str:='<html><head><meta http-equiv="Content-Type" content="text/html; charset=windows-1251"></head><BODY><p ALIGN="RIGHT"><small>учетная форма 397</small></P><P ALIGN="CENTER"><B><BIG>В СТОЛОВУЮ</BIG></B></P>';
  DBMS_LOB.WRITEAPPEND(cl,LENGTH(str),str);
--
  str:='<P ALIGN="LEFT"><font face="Courier New, Courier, mono"><B>Отдыхающий &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</B>'||pFC_FIO||'<BR>';
  str:=str||'<B>Дата рождения &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</B>'||to_char(pFD_ROJD,'dd.mm.yyyy')||'<BR>';
  str:=str||'<B>Социальное положение </B>'||pFC_COC_POL||'<BR>';
  str:=str||'<B>Группа отбора &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</B>'||pFC_GROUP||'<BR>';
  str:=str||'<B>Признак контингента &nbsp;</B>'||pFC_PRIZN||'<BR>';
  str:=str||'<B>Дата поступления &nbsp;&nbsp;&nbsp;&nbsp;</B>'||to_char(pFD_DATA1,'dd.mm.yyyy')||'<BR>';
  str:=str||'<B>Дата выбытия &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</B>'||to_char(pFD_DATA3,'dd.mm.yyyy')||'<BR>';
  str:=str||'<B>Лечащий врач &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</B>'||DO_VRACHFIO (GET_PACVRACH (pFK_PACID) ) ||'<BR><BR>';
  str:=str||'<B>Комната № </B>'||pFC_PALATA||'<B> Салфетка № </B>________ '||'<BR>';
  str:=str||'<B>&lt&lt____&gt&gt__________________  г.________</B><BR><BR>';
  str:=str||'<B>Медсестра &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</B>'||DO_VRACHFIO(pFK_VRACHID)||'<BR>';
  str:=str||'</FONT></P></BODY></HTML>';
  DBMS_LOB.WRITEAPPEND(cl,LENGTH(str),str);
  DBMS_LOB.CLOSE(cl);
  RETURN rc;
END;
FUNCTION DO_DAYPLAN_REPORT(pFK_PACID IN NUMBER, pFC_TABLE IN VARCHAR2, pFC_SALFET IN VARCHAR2) RETURN NUMBER
 IS-- Created by TimurLan
 HTML_HEAD CONSTANT VARCHAR2 (32767) :=
' <html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:w="urn:schemas-microsoft-com:office:word" xmlns="http://www.w3.org/TR/REC-html40"> '||
' <head> '||
' <meta http-equiv=Content-Type content="text/html; charset=windows-1251"> '||
' <link rel=File-List href="./Doc3.files/filelist.xml"> '||
' <title>САНИТАРНО-КУРОРТНАЯ КАРТА</title> '||
' <!--[if gte mso 9]><xml> '||
'  <w:WordDocument> '||
'   <w:View>Print</w:View> '||
'   <w:Zoom>BestFit</w:Zoom> '||
'  </w:WordDocument> '||
' </xml><![endif]--> '||
' <style> '||
' <!-- '||
'  /* Style Definitions */ '||
' .my_td  '||
'     {border:solid windowtext .5pt;padding:0cm 5.4pt 0cm 5.4pt} '||
' p.MsoNormal, li.MsoNormal, div.MsoNormal '||
' 	{mso-style-parent:""; '||
' 	margin:0mm; '||
' 	margin-bottom:.0001pt; '||
' 	mso-pagination:widow-orphan; '||
' 	font-size:12.0pt; '||
' 	font-family:"Courier New"; '||
' 	mso-fareast-font-family:"Courier New";} '||
' @page Section1 '||
' 	{size:842.0pt 210.0mm; '||
' 	mso-page-orientation:landscape; '||
' 	margin:20.0mm 70.9pt 20.0mm 70.9pt; '||
' 	mso-header-margin:0mm; '||
' 	mso-footer-margin:0mm; '||
' 	mso-columns:2 even 40.0mm; '||
' 	mso-paper-source:0;} '||
' div.Section1 '||
' 	{page:Section1;} '||
' --> '||
' </style> '||
' </head> '||
' <body> '||
' <div class=Section1> '||
'  <!--здесь по-ходу начинается рамка титульника--> '||
' <table border=1 cellspacing=0 cellpadding=0 align=right width="100%" '||
'  style=''width:100.0%;border-collapse:collapse;border:none;mso-border-alt:solid windowtext .5pt;mso-table-lspace:9.0pt;mso-table-rspace:9.0pt;mso-table-anchor-vertical:paragraph;mso-table-anchor-horizontal:margin;mso-table-left:right;mso-table-top:.1pt;mso-padding-alt:0mm 5.4pt 0mm 5.4pt''> '||
' <tr style=''height:485.5pt''> '||
'   <td width="100%" valign=top style=''width:100.0%;border:solid windowtext .5pt;padding:0mm 5.4pt 0mm 5.4pt;height:485.5pt''> '||
'    <!--содержимое титульника--> '||
'   <p class=MsoNormal><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></p> '||
'   <p class=MsoNormal align=center >САНАТОРНО-КУРОРТНАЯ КАРТА</p> '||
'   <p class=MsoNormal><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></p> '||
'   <p class=MsoNormal><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></p> '||
'   <p class=MsoNormal><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></p> '||
'   <p class=MsoNormal><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></p> '||
'   <p class=MsoNormal><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></p> '||
'   <p class=MsoNormal><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></p> '||
'   <p class=MsoNormal><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></p> ';
CURSOR cKARTA IS
 select /*+ rule*/
       TKARTA.FC_FAM FC_FAM, TKARTA.FC_IM FC_IM, TKARTA.FC_OTCH FC_OTCH, TKARTA.FC_PUT FC_PUT,
       GET_PACINCOME(TKARTA.FK_ID) FD_DATA1,
       GET_PACPLANOUTCOME(TKARTA.FK_ID) FD_DATA2,
       GET_VRACHFCOTDEL(GET_PACVRACH(TKARTA.FK_ID)) FC_OTDEL,
       GET_PACFCKORP(TKARTA.FK_ID) FC_KORP,
       GET_PACFCPALATA(TKARTA.FK_ID) FC_PALATA,
       DO_VRACHFIO(GET_PACVRACH(TKARTA.FK_ID)) FC_VRACH,
       null as FC_KAB,
--       GET_VRACHFCKAB(GET_PACVRACH(TKARTA.FK_ID)) FC_KAB,
       GET_VRACHTEL(GET_PACVRACH(TKARTA.FK_ID)) FC_TEL
  from TKARTA
 where TKARTA.FK_ID = pFK_PACID;
 CURSOR cDayPlan IS select fc_time1, fc_time2, fc_name from tdayplan;
 cC CLOB;
 nC NUMBER;
 str VARCHAR2 (4000);
 cTemp1 VARCHAR (30);
 cTemp2 VARCHAR (30);
BEGIN
  DBMS_LOB.CREATETEMPORARY (cC, TRUE, DBMS_LOB.SESSION);
  str := HTML_HEAD;
  DBMS_LOB.WRITEAPPEND (cC, LENGTH (str), str);
  FOR p IN cKARTA LOOP
    str:='<p class=MsoNormal><b>Фамилия</b>&nbsp;&nbsp;&nbsp;'||p.FC_FAM||'</p>';
    str:=str||'<p class=MsoNormal><b>Имя</b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'||p.FC_IM||'</p>';
    str:=str||'<p class=MsoNormal><b>Отчество</b>&nbsp;&nbsp;'||p.FC_OTCH||'</p>';
    if (p.FC_PUT = '') OR (p.FC_PUT IS NULL)
     then cTemp1 := '_______';
     else cTemp1 := p.FC_PUT; end if;
    str:=str||'<p class=MsoNormal><b>Путевка №</b>&nbsp;'||cTemp1||'</p>';
    str:=str||'<p class=MsoNormal><b>Лечение с</b>&nbsp;'||TO_CHAR(p.FD_DATA1,'DD.MM.YYYY')||'&nbsp;<b>по</b>&nbsp;'||TO_CHAR(p.FD_DATA2,'DD.MM.YYYY')||'</p>';
    str:=str||'<p class=MsoNormal><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></p>';
    str:=str||'<p class=MsoNormal><b>Прибыл</b>&nbsp;&nbsp;&nbsp;&nbsp;'||TO_CHAR(p.FD_DATA1,'DD.MM.YYYY')||'</p>';
    str:=str||'<p class=MsoNormal><b>Отделение</b>&nbsp;'||p.FC_OTDEL||'</p>';
    str:=str||'<p class=MsoNormal><b>Корпус</b>&nbsp;&nbsp;&nbsp;&nbsp;'||p.FC_KORP||'</p>';
    str:=str||'<p class=MsoNormal><b>Комната №</b>&nbsp;'||p.FC_PALATA||'</p>';
    if (pFC_TABLE = '') OR (pFC_TABLE IS NULL)
     then cTemp1 := '_______';
     else cTemp1 := pFC_TABLE; end if;
    str:=str||'<p class=MsoNormal><b>Стол №</b>&nbsp;'||cTemp1||'</p>';
    if (pFC_SALFET = '') OR (pFC_SALFET IS NULL)
     then cTemp1 := '_______';
     else cTemp1 := pFC_SALFET; end if;
    str:=str||'<p class=MsoNormal><b>Салфетка №</b>&nbsp;'||cTemp1||'</p>';
    str:=str||'<p class=MsoNormal><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></p>';
    str:=str||'<p class=MsoNormal><b>Лечащий врач</b>&nbsp;'||p.FC_VRACH||'</p>';
    if (p.FC_KAB = 'Неизвестен') OR (p.FC_KAB  IS NULL)
     then cTemp1 := '_______';
     else cTemp1:=p.FC_KAB; end if;
    if (p.FC_TEL = '') OR (p.FC_TEL IS NULL)
     then cTemp2 := '_______';
     else cTemp2:=p.FC_TEL; end if;
    str:=str||'<p class=MsoNormal><b>Каб. №</b>&nbsp;'||cTemp1||'&nbsp;<b>тел. №</b>&nbsp;'||cTemp2||'</p>';
  END LOOP;
  DBMS_LOB.WRITEAPPEND (cC, LENGTH (str), str);
  str:='<p class=MsoNormal><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></p>';
  str:=str||'<p class=MsoNormal><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></p>';
  str:=str||'<p class=MsoNormal><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></p>';
  str:=str||'<p class=MsoNormal><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></p>';
  str:=str||'<p class=MsoNormal><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></p>';
  str:=str||'<p class=MsoNormal><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></p>';
  str:=str||'<p class=MsoNormal><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></p>';
  str:=str||'<p class=MsoNormal><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></p>';
  str:=str||'<p class=MsoNormal><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></p>';
  DBMS_LOB.WRITEAPPEND (cC, LENGTH (str), str);

  str:='<p class=MsoNormal align=center>САНАТОРИЙ «'||PKG_SMINI.READSTRING ('CONFIG', 'S_NAME', 'Не известен') ||'»</p>';
  str:=str||'<p class=MsoNormal align=center>'|| TO_CHAR(SYSDATE, 'YYYY') ||' год</p>';
  DBMS_LOB.WRITEAPPEND (cC, LENGTH (str), str);
  str:=
  '   </td> '||
  '  </tr> '||
  ' </table> '||
  '  <!--здесь кончается рамка титульника--> '||
  ' <p class=MsoNormal><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></p> '||
  '  <!--здесь начинается рамка распорядка--> '||
  ' <table border=1 cellspacing=0 cellpadding=0 align=right width="100%" '||
  '  style=''width:100.0%;border-collapse:collapse;border:none;mso-border-alt:solid windowtext .5pt;mso-table-lspace:9.0pt;mso-table-rspace:9.0pt;mso-table-anchor-vertical:paragraph;mso-table-anchor-horizontal:margin;mso-table-left:right;mso-table-top:.1pt;mso-padding-alt:0mm 5.4pt 0mm 5.4pt''> '||
  '  <tr style=''height:485.5pt''> '||
  '   <td width="100%" valign=top style=''width:100.0%;border:solid windowtext .5pt;padding:0mm 5.4pt 0mm 5.4pt;height:485.5pt''> '||
  '   <!--содержимое распорядка--> '||
  '   <p class=MsoNormal><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></p> '||
  '   <p class=MsoNormal align=center>РАСПОРЯДОК ДНЯ:</p> '||
  '   <p class=MsoNormal><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></p> '||
  '   <!--пошла таблица распорядка--> '||
  '   <table border=1 cellspacing=0 cellpadding=0 width="99%" style=''width:99.92%;border-collapse:collapse;border:none;mso-border-alt:solid windowtext .5pt;mso-padding-alt:0mm 5.4pt 0mm 5.4pt''> '||
  '    <tr><!--ШАПКА--> '||
  '     <td class="my_td"> '||
  '     <p class=MsoNormal align=center><b>Начало</b></p> '||
  '     </td> '||
  '     <td class="my_td"> '||
  '     <p class=MsoNormal align=center><b>Конец</b></p> '||
  '     </td> '||
  '     <td class="my_td"> '||
  '     <p class=MsoNormal align=center><b>Мероприятие</b></p> '||
  '     </td> '||
  '    </tr> ';
  DBMS_LOB.WRITEAPPEND (cC, LENGTH (str), str);
  str:=' <!--ТЕЛО-->';
  FOR p IN cDayPlan LOOP
    str:=str||'   <tr>';
    str:=str||'    <td class="my_td">';
    str:=str||'    <p class=MsoNormal align=center>'||p.FC_TIME1||'</p>';
    str:=str||'    </td>';
    str:=str||'    <td class="my_td">';
    str:=str||'    <p class=MsoNormal align=center>'||p.FC_TIME2||'</p>';
    str:=str||'    </td>';
    str:=str||'    <td class="my_td">';
    str:=str||'    <p class=MsoNormal>'||p.FC_NAME||'</p>';
    str:=str||'    </td>';
    str:=str||'   </tr>';
  END LOOP;
  DBMS_LOB.WRITEAPPEND (cC, LENGTH (str), str);
  str:=
  '   </table> '||
  '   <!--Конец таблицы--> '||
  '   <p class=MsoNormal><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></p> '||
  '   <p class=MsoNormal><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></p> '||
  '  </td> '||
  ' </tr> '||
  ' </table> '||
  ' <!--Конец рамки--> '||
  ' <p class=MsoNormal><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></p> '||
  ' </div> '||
  ' </body></html> ';
  DBMS_LOB.WRITEAPPEND (cC, LENGTH (str), str);
  INSERT INTO TCLOBS
              (FC_CLOB)
       VALUES (cC)
    RETURNING FK_ID
    INTO nC;
  RETURN nC;
END;
FUNCTION GET_FREEROOM (pTAB_NAME IN VARCHAR2, pFD_DATE IN DATE, pFK_VRACHID IN NUMBER) RETURN NUMBER
 IS-- Created by TimurLan (4 'Данные о свободных местах' - rFreeRoom.dpr)
TYPE RefCurType IS REF CURSOR;
 c RefCurType;
 cC CLOB;
 nC NUMBER;
 str VARCHAR2 (4000);
 pFC_FIELD1 VARCHAR2(100);
 pFC_FIELD2 VARCHAR2(100);
 pFC_FIELD3 VARCHAR2(100);
BEGIN
  INSERT INTO TCLOBS (FC_CLOB)
         VALUES (EMPTY_CLOB () )
         RETURNING FK_ID, FC_CLOB
         INTO nC, cC;
  DBMS_LOB.OPEN (cC, DBMS_LOB.LOB_READWRITE);
  str := PKG_HTML.GET_HEAD('word','Данные о свободных местах на '||TO_CHAR(pFD_DATE,'dd.mm.yyyy')||' по санаторию "'||PKG_SMINI.READSTRING('CONFIG','S_NAME','Не известен')||'"',
                           null,'10.0',null,
                           null,null,null,
                           null,null,null,
                           null,null,null,
                           null,null,null,null,
                           null,null,null,null,
                           null,null,null,null,
                           null,null,null);
  DBMS_LOB.WRITEAPPEND (cC, LENGTH (str), str);
  str := '<BODY>'||
         '<div class=user>'||
         '<P ALIGN="CENTER"><B>Данные о свободных местах на ' || TO_CHAR (pFD_DATE, 'dd.mm.yyyy') || '<BR>по санаторию "' || PKG_SMINI.READSTRING ('CONFIG', 'S_NAME', 'Не известен') || '"</B></P>'||
         '<BR>'||
         '<table>'||
         '<TR>'||
         '<TD WIDTH="25%"><B>Этаж:</B></TD>'||
         '<TD WIDTH="50%"><B>Виды свободных мест:</B></TD>'||
         '<TD WIDTH="25%"><B>Кол-во мест:</B></TD>'||
         '</TR>';
  DBMS_LOB.WRITEAPPEND (cC, LENGTH (str), str);
  OPEN c FOR 'SELECT * FROM ' || pTAB_NAME;
  LOOP
    FETCH c INTO  pFC_FIELD1,  pFC_FIELD2,  pFC_FIELD3;
    EXIT WHEN c%NOTFOUND;
    str  := '<TR><TD><P class=user>' || NVL(pFC_FIELD1,'&nbsp') || '</P></TD><TD><P class=user>' || NVL(pFC_FIELD2,'&nbsp') || '</P></TD><TD><P class=user>' || NVL(pFC_FIELD3,'&nbsp') || '</P></TD>';
    str  := str || '</TR>';
    DBMS_LOB.WRITEAPPEND (cC, LENGTH (str), str);
  END LOOP;
  CLOSE c;
  str  := '</TABLE><BR>';
  DBMS_LOB.WRITEAPPEND (cC, LENGTH (str), str);
  str  := '<P><B>Отчет составил: _________________________ ' || DO_VRACHFIO (pFK_VRACHID) || '</B></P>';
  DBMS_LOB.WRITEAPPEND (cC, LENGTH (str), str);
  str  := '</DIV></BODY></HTML>';
  DBMS_LOB.WRITEAPPEND (cC, LENGTH (str), str);
  DBMS_LOB.CLOSE (cC);
  RETURN nC;
END;
FUNCTION GET_SOCSOS (pFD_DATA1 IN DATE,pFD_DATA2 IN DATE,pFK_VRACHID IN NUMBER) RETURN NUMBER IS
  nc NUMBER;
  str VARCHAR2(2000);
  cc CLOB;
  CURSOR cPrizn IS
    SELECT FK_ID,FC_SHORT FROM TPRIZN ORDER BY FN_ORDER;
  CURSOR cCocPol IS
    SELECT FK_ID,FC_NAME FROM TCOC_POl;
  CURSOR c(d1 DATE,d2 DATE,pPrizn NUMBER,pSOS NUMBER) IS
    SELECT /*+rule*/COUNT(FK_PACID)
      FROM TKARTA,TSROKY
     WHERE TSROKY.FK_PACID=TKARTA.FK_ID
       AND FD_DATA1 BETWEEN d1 AND d2
       AND FK_PRYB=3
       AND TKARTA.FK_PRIZN=pPrizn
       AND TKARTA.FK_COC_POLID=pSos;
  CURSOR c2(d1 DATE,d2 DATE,pPrizn NUMBER) IS
    SELECT /*+rule*/COUNT(FK_PACID)
      FROM TKARTA,TSROKY
     WHERE TSROKY.FK_PACID=TKARTA.FK_ID
       AND FD_DATA1 BETWEEN d1 AND d2
       AND FK_PRYB=3
       AND TKARTA.FK_PRIZN=pPrizn;
  CURSOR c3(d1 DATE,d2 DATE) IS
    SELECT /*+rule*/COUNT(FK_PACID)
      FROM TKARTA,TSROKY
     WHERE TSROKY.FK_PACID=TKARTA.FK_ID
       AND FD_DATA1 BETWEEN d1 AND d2
       AND FK_PRYB=3;
  CURSOR c1(d1 DATE,d2 DATE,pSOS NUMBER) IS
    SELECT /*+rule*/COUNT(FK_PACID)
      FROM TKARTA,TSROKY
     WHERE TSROKY.FK_PACID=TKARTA.FK_ID
       AND FD_DATA1 BETWEEN d1 AND d2
       AND FK_PRYB=3
       AND TKARTA.FK_COC_POLID=pSos;
  n NUMBER;
BEGIN
  DBMS_LOB.CREATETEMPORARY (cc, TRUE, DBMS_LOB.SESSION);
  str     :=
       GET_HTML_HEADER ||
      '<BODY><DIV class="Section1"><P ALIGN="CENTER"><B><font size="+1">Сведения о составе лечившихся и отдыхавших по санаторию "' ||
      PKG_SMINI.READSTRING ('CONFIG', 'S_NAME', 'Не известен') ||
      '"</font></B><BR>';
  str     := str || 'за период с ' || TO_CHAR(pFD_DATA1,'dd.mm.yyyy') || ' по ' || TO_CHAR(pFD_DATA2,'dd.mm.yyyy') || ' .';
  DBMS_LOB.WRITEAPPEND (cC, LENGTH (str), str);
  str     := '<table align="center" width="100%" border="1" class = "sm_table" cellpadding="0" cellspacing="0">';
  DBMS_LOB.WRITEAPPEND (cC, LENGTH (str), str);
  str:='<TR ALIGN=CENTER><TD class="sm_td">&nbsp;</TD>';
  FOR p IN cPrizn LOOP
    str:=str||'<TD class="sm_td">'||p.FC_SHORT||'</TD>';
  END LOOP;
  str:=str||'<TD class="sm_td">Всего:</TD></TR>';
  DBMS_LOB.WRITEAPPEND (cC, LENGTH (str), str);
  FOR p IN cCocPol LOOP
    str:='<TR ALIGN="CENTER"><TD class="sm_td">'||p.FC_NAME||'</TD>';
    PROGRESS_BAR.SetStrOut('Рассчет: '||p.FC_NAME);
    PROGRESS_BAR.STEPIT;
    FOR i IN cPrizn LOOP
      OPEN c(pFD_DATA1,pFD_DATA2,i.FK_ID,p.FK_ID);
      FETCH c INTO n;
      CLOSE c;
      str:=str||'<TD class="sm_td">'||n||'</TD>';
    END LOOP;
    OPEN c1(pFD_DATA1,pFD_DATA2,p.FK_ID);
    FETCH c1 INTO n;
    CLOSE c1;
    str:=str||'<TD class="sm_td">'||n||'</TD></TR>';
    DBMS_LOB.WRITEAPPEND (cC, LENGTH (str), str);
  END LOOP;
  str:='<TR ALIGN="CENTER"><TD class="sm_td">Всего:</TD>';
  PROGRESS_BAR.SetStrOut('Рассчет: Всего');
  PROGRESS_BAR.STEPIT;
  FOR i IN cPrizn LOOP
    OPEN c2(pFD_DATA1,pFD_DATA2,i.FK_ID);
    FETCH c2 INTO n;
    CLOSE c2;
    str:=str||'<TD class="sm_td">'||n||'</TD>';
  END LOOP;
  OPEN c3(pFD_DATA1,pFD_DATA2);
  FETCH c3 INTO n;
  CLOSE c3;
  str:=str||'<TD class="sm_td">'||n||'</TD></TR>';
  DBMS_LOB.WRITEAPPEND (cC, LENGTH (str), str);
  str     := '</TABLE></DIV></BODY></HTML>';
  DBMS_LOB.WRITEAPPEND (cC, LENGTH (str), str);
  INSERT INTO TCLOBS
              (FC_CLOB)
       VALUES (cc)
    RETURNING FK_ID
    INTO nC;
  RETURN nC;
END;
  FUNCTION GET_NAKL (pFK_PACID IN NUMBER)RETURN NUMBER IS
    nC NUMBER;
    cC CLOB;
    str VARCHAR2(32767);
    strFam VARCHAR(500);
    nSum NUMBER;
    CURSOR c IS SELECT FC_FAM||' '||FC_IM||' '||FC_OTCH,FN_SUM,GET_PACINCOME(TKARTA.FK_ID) FROM TKARTA WHERE FK_ID=pFK_PACID;
    dDate DATE;
  BEGIN
    INSERT INTO TCLOBS(FC_CLOB) VALUES(EMPTY_CLOB()) RETURNING FK_ID,FC_CLOB INTO nC,cC;
    DBMS_LOB.OPEN(cC,DBMS_LOB.LOB_READWRITE);
--    str:='<html><head><meta http-equiv="Content-Type" content="text/html; charset=windows-1251"></head>';
    str:='<html xmlns:o="urn:schemas-microsoft-com:office:office" '||
         'xmlns:w="urn:schemas-microsoft-com:office:word" '||
         'xmlns="http://www.w3.org/TR/REC-html40"> '||
         '<head> '||
         '<meta http-equiv=Content-Type content="text/html; charset=windows-1251"> '||
         '<meta name=ProgId content=Word.Document> '||
         '<meta name=Generator content="Microsoft Word 9"> '||
         '<meta name=Originator content="Microsoft Word 9"> '||
         '<link rel=File-List href="./nakl.files/filelist.xml"> '||
         '<title>Накладная</title> '||
         '<!--[if gte mso 9]><xml> '||
         ' <o:DocumentProperties> '||
         '  <o:Author>Администратор</o:Author> '||
         '  <o:Template>Normal</o:Template> '||
         '  <o:LastAuthor>Администратор</o:LastAuthor> '||
         '  <o:Revision>3</o:Revision> '||
         '  <o:TotalTime>4</o:TotalTime> '||
         '  <o:Created>2001-06-07T12:02:00Z</o:Created> '||
         '  <o:LastSaved>2001-06-07T12:06:00Z</o:LastSaved> '||
         '  <o:Pages>1</o:Pages> '||
         '  <o:Company>Машук</o:Company> '||
         '  <o:Lines>1</o:Lines> '||
         '  <o:Paragraphs>1</o:Paragraphs> '||
         '  <o:Version>9.2812</o:Version> '||
         ' </o:DocumentProperties> '||
         '</xml><![endif]--> '||
         '<style> '||
         '<!-- '||
         ' /* Style Definitions */ '||
         'p.MsoNormal, li.MsoNormal, div.MsoNormal '||
         '	{mso-style-parent:""; '||
         '	margin:0cm; '||
         '	margin-bottom:.0001pt; '||
         '	mso-pagination:widow-orphan; '||
         '	font-size:12.0pt; '||
         '	font-family:"Times New Roman"; '||
         '	mso-fareast-font-family:"Times New Roman";} '||
         'h1 '||
         '	{mso-style-next:Обычный; '||
         '	margin:0cm; '||
         '	margin-bottom:.0001pt; '||
         '	text-align:center; '||
         '	mso-pagination:widow-orphan; '||
         '	page-break-after:avoid; '||
         '	mso-outline-level:1; '||
         '	font-size:12.0pt; '||
         '	font-family:"Times New Roman"; '||
         '	mso-font-kerning:0pt;} '||
         '@page Section1 '||
         '	{ size:595.3pt 841.9pt;'||
         '	margin:2.0cm 42.5pt 2.0cm 3.0cm; '||
         '	mso-header-margin:35.4pt; '||
         '	mso-footer-margin:35.4pt; '||
         '	mso-paper-source:0;} '||
         'div.Section1 '||
         '	{page:Section1;} '||
         '--> '||
         '</style> '||
         '</head> '||
         '<body lang=RU style=''tab-interval:35.4pt''> '||
         '<div class=Section1> '||
         '<p class=MsoNormal align=right style=''text-align:right''><span lang=EN-US '||
         'style=''mso-ansi-language:EN-US''>DATE</span></p> '||
         '<h1><span lang=EN-US style=''mso-ansi-language:EN-US''><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></h1> '||
         '<h1>Накладная №______</h1> '||
         '<p class=MsoNormal><i><span lang=EN-US style=''mso-ansi-language:EN-US''><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></i></p> '||
         '<p class=MsoNormal><i>Кому </i><span lang=EN-US style=''mso-ansi-language:EN-US''>WHOM</span></p> '||
         '<p class=MsoNormal><i><span lang=EN-US style=''mso-ansi-language:EN-US''><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></i></p> '||
         '<p class=MsoNormal><i>От кого </i> Санаторий "'||PKG_SMINI.READSTRING ('CONFIG', 'S_NAME', 'Не известен')||'"</p> '||
         '<p class=MsoNormal><span lang=EN-US style=''mso-ansi-language:EN-US''><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p> '||
         '<p class=MsoNormal><span lang=EN-US style=''mso-ansi-language:EN-US''><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p> '||
         '<p class=MsoNormal><span lang=EN-US style=''mso-ansi-language:EN-US''><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p> '||
         '<table border=1 cellspacing=0 cellpadding=0 style=''border-collapse:collapse; '||
         ' border:none;mso-border-alt:solid windowtext .5pt;mso-padding-alt:0cm 5.4pt 0cm 5.4pt''> '||
         ' <tr> '||
         '  <td width=105 valign=top style=''width:78.45pt;border:solid windowtext .5pt; '||
         '  padding:0cm 5.4pt 0cm 5.4pt''> '||
         '  <p class=MsoNormal align=center style=''text-align:center''>№ п/п</p> '||
         '  </td> '||
         '  <td width=126 valign=top style=''width:94.45pt;border:solid windowtext .5pt; '||
         '  border-left:none;mso-border-left-alt:solid windowtext .5pt;padding:0cm 5.4pt 0cm 5.4pt''> '||
         '  <p class=MsoNormal align=center style=''text-align:center''>Наименование</p> '||
         '  </td> '||
         '  <td width=125 valign=top style=''width:93.5pt;border:solid windowtext .5pt; '||
         '  border-left:none;mso-border-left-alt:solid windowtext .5pt;padding:0cm 5.4pt 0cm 5.4pt''> '||
         '  <p class=MsoNormal align=center style=''text-align:center''>Количество</p> '||
         '  </td> '||
         '  <td width=108 valign=top style=''width:81.0pt;border:solid windowtext .5pt; '||
         '  border-left:none;mso-border-left-alt:solid windowtext .5pt;padding:0cm 5.4pt 0cm 5.4pt''> '||
         '  <p class=MsoNormal align=center style=''text-align:center''>Цена</p> '||
         '  </td> '||
         '  <td width=175 valign=top style=''width:131.15pt;border:solid windowtext .5pt; '||
         '  border-left:none;mso-border-left-alt:solid windowtext .5pt;padding:0cm 5.4pt 0cm 5.4pt''> '||
         '  <p class=MsoNormal align=center style=''text-align:center''>Сумма</p> '||
         '  </td> '||
         ' </tr> '||
         ' <tr> '||
         '  <td width=105 valign=top style=''width:78.45pt;border:solid windowtext .5pt; '||
         '  border-top:none;mso-border-top-alt:solid windowtext .5pt;padding:0cm 5.4pt 0cm 5.4pt''> '||
         '  <p class=MsoNormal><i>1<o:p></o:p></i></p> '||
         '  </td> '||
         '  <td width=126 valign=top style=''width:94.45pt;border-top:none;border-left: '||
         '  none;border-bottom:solid windowtext .5pt;border-right:solid windowtext .5pt; '||
         '  mso-border-top-alt:solid windowtext .5pt;mso-border-left-alt:solid windowtext .5pt; '||
         '  padding:0cm 5.4pt 0cm 5.4pt''> '||
         '  <p class=MsoNormal><i>путевка<o:p></o:p></i></p> '||
         '  </td> '||
         '  <td width=125 valign=top style=''width:93.5pt;border-top:none;border-left: '||
         '  none;border-bottom:solid windowtext .5pt;border-right:solid windowtext .5pt; '||
         '  mso-border-top-alt:solid windowtext .5pt;mso-border-left-alt:solid windowtext .5pt; '||
         '  padding:0cm 5.4pt 0cm 5.4pt''> '||
         '  <p class=MsoNormal><i>1 шт<o:p></o:p></i></p> '||
         '  </td> '||
         '  <td width=108 valign=top style=''width:81.0pt;border-top:none;border-left: '||
         '  none;border-bottom:solid windowtext .5pt;border-right:solid windowtext .5pt; '||
         '  mso-border-top-alt:solid windowtext .5pt;mso-border-left-alt:solid windowtext .5pt; '||
         '  padding:0cm 5.4pt 0cm 5.4pt''> '||
         '  <p class=MsoNormal><i><span lang=EN-US style=''mso-ansi-language:EN-US''>PRICE</span><o:p></o:p></i></p> '||
         '  </td> '||
         '  <td width=96 valign=top style=''width:72.0pt;border-top:none;border-left: '||
         '  none;border-bottom:solid windowtext .5pt;border-right:solid windowtext .5pt; '||
         '  mso-border-top-alt:solid windowtext .5pt;mso-border-left-alt:solid windowtext .5pt; '||
         '  padding:0cm 5.4pt 0cm 5.4pt''> '||
         '  <p class=MsoNormal><i><span lang=EN-US style=''mso-ansi-language:EN-US''>PRICE</span><o:p></o:p></i></p> '||
         '  </td> '||
/*         '  </td> '||
         '  <td width=79 valign=top style=''width:59.15pt;border-top:none;border-left: '||
         '  none;border-bottom:solid windowtext .5pt;border-right:solid windowtext .5pt; '||
         '  mso-border-top-alt:solid windowtext .5pt;mso-border-left-alt:solid windowtext .5pt; '||
         '  padding:0cm 5.4pt 0cm 5.4pt''> '||
         '  <p class=MsoNormal><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></p> '||
         '  </td> '||
*/         ' </tr> '||
         '</table> '||
         '<p class=MsoNormal><span lang=EN-US style=''mso-ansi-language:EN-US''><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p> '||
         '<p class=MsoNormal><span lang=EN-US style=''mso-ansi-language:EN-US''><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p> '||
         '<p class=MsoNormal>Сдал____________<span style=''mso-tab-count:8''>                                                                                     </span>Принял__________</p> '||
         '</div> '||
         '</body> '||
         '</html> ';
    OPEN c;
    FETCH c INTO strFam,nSum,dDate;
    CLOSE c;
    str:=REPLACE(str,'WHOM',strFam);
    str:=REPLACE(str,'PRICE',nSum);
    str:=REPLACE(str,'DATE',TO_CHAR(dDate,'dd.mm.yyyy'));
    DBMS_LOB.WRITEAPPEND(cC,LENGTH(str),str);
    DBMS_LOB.CLOSE(cC);
    RETURN nC;
  END;
END;-- Package Body PKG_REGIST_REPORTS
/

SHOW ERRORS;


