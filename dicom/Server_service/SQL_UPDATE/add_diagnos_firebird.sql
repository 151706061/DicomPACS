// об€зательно в ibexpert добавить права на созданные таблицы дл€ role users


ALTER TABLE STUDIES
ADD FC_MNDIAGNOS BLOB SUB_TYPE 1 SEGMENT SIZE 1024;
ALTER TABLE STUDIES
ADD FC_ADDDIAGNOS BLOB SUB_TYPE 1 SEGMENT SIZE 1024;

ALTER TABLE STUDIES
ADD FK_IDOSNDIAG INTEGER;
ALTER TABLE STUDIES
ADD FK_IDDOPDIAG INTEGER;

CREATE INDEX STUDIES_IDX2
ON STUDIES (FK_IDDOPDIAG);
CREATE INDEX STUDIES_IDX1
ON STUDIES (FK_IDOSNDIAG);

CREATE TABLE STUDYDOCS (
    STUDYUID  CHAR(80),
    FDATE     DATE,
    FCOMMENT  VARCHAR(50),
    F_FILE    BLOB SUB_TYPE 0 SEGMENT SIZE 80,
    FC_LOGIN  VARCHAR(50),
    F_ID      INTEGER NOT NULL
);

CREATE OR ALTER trigger studies_bd0 for studies
active before delete position 0
AS
begin
  DELETE FROM SERIES WHERE STUDYUID = OLD.STUDYUID;
  DELETE FROM IMAGES WHERE STUDYUID = OLD.STUDYUID;
  DELETE from studydocs WHERE STUDYUID = OLD.STUDYUID;
end;

CREATE INDEX STUDYDOCS_IDX1 ON STUDYDOCS (STUDYUID);
DESCRIBE FIELD STUDYUID TABLE STUDYDOCS
'studyuid - ссылка на исследование';

DESCRIBE FIELD FDATE TABLE STUDYDOCS
'дата добавлени€ записи';

DESCRIBE FIELD FCOMMENT TABLE STUDYDOCS
'описание файла';

DESCRIBE FIELD F_FILE TABLE STUDYDOCS
'файл';

DESCRIBE FIELD FC_LOGIN TABLE STUDYDOCS
'Ћогин пользовател€';


CREATE TABLE DIAGNOZ (
    FK_ID INTEGER NOT NULL,
    FK_PARENTID INTEGER,
    FC_NAME VARCHAR(50));

CREATE SEQUENCE GEN_DIAGNOZ_ID;

ALTER SEQUENCE GEN_DIAGNOZ_ID RESTART WITH 1;

create trigger diagnoz_bi for diagnoz
active before insert position 0
as
begin
  if (new.fk_id is null) then
    new.fk_id = gen_id(gen_diagnoz_id,1);
end;

create procedure sp_gen_diagnoz_id
returns (id integer)
as
begin
  id = gen_id(gen_diagnoz_id, 1);
  suspend;
end;

CREATE UNIQUE INDEX DIAGNOZ_IDX1
ON DIAGNOZ (FK_ID);

CREATE INDEX DIAGNOZ_IDX3
ON DIAGNOZ (FC_NAME);

CREATE INDEX DIAGNOZ_IDX2
ON DIAGNOZ (FK_PARENTID);

CREATE SEQUENCE GEN_NUID_ID;
ALTER SEQUENCE GEN_NUID_ID RESTART WITH 1;