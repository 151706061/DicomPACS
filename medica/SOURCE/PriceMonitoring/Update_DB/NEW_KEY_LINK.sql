ALTER TABLE MED.TPRICE_MONITOR_BASE ADD ( FK_ID NUMBER )
/
COMMENT ON COLUMN MED.TPRICE_MONITOR_BASE.FK_ID IS 'ключ'
/

ALTER TABLE MED.TPRICE_MONITOR_OST ADD (FK_TPRICE_MONITOR_BASE_ID NUMBER)
/
COMMENT ON COLUMN MED.TPRICE_MONITOR_OST.FK_TPRICE_MONITOR_BASE_ID IS 'ссылка на TPRICE_MONITOR_BASE.FK_ID'
/

DROP INDEX med.tprice_monitor_base_packnx
/

CREATE Unique INDEX MED.TPRICE_MONITOR_BASE_FK_ID ON MED.TPRICE_MONITOR_BASE
   (  FK_ID ASC  ) 
 COMPUTE STATISTICS 
/

CREATE INDEX MED.TPRICE_MONITOR_BASE_PACKNX ON MED.TPRICE_MONITOR_BASE
   (  PACKNX ASC  ) 
 COMPUTE STATISTICS 
/

CREATE SEQUENCE MED.SEQ_TPRICE_MONITOR_BASE
/

CREATE TRIGGER MED.TPRICE_MONITOR_BASE_INS
 BEFORE 
 INSERT
 ON MED.TPRICE_MONITOR_BASE
 FOR EACH ROW 
begin
  if :new.fk_id is null then
    select med.SEQ_TPRICE_MONITOR_BASE.NEXTVAL into :new.fk_id from dual;
  end if;
end;
/

CREATE TRIGGER MED.TPRICE_MONITOR_BASE_DEL
 BEFORE 
 DELETE
 ON MED.TPRICE_MONITOR_BASE
 FOR EACH ROW 
begin
  update med.TPRICE_MONITOR_OST set FK_TPRICE_MONITOR_BASE_ID = null
  where FK_TPRICE_MONITOR_BASE_ID = :old.fk_id;
end;
/

CREATE INDEX MED.TPRICE_MONITOR_OST_BASE_ID ON MED.TPRICE_MONITOR_OST
   (  FK_TPRICE_MONITOR_BASE_ID ASC  ) 
 COMPUTE STATISTICS 
/

ALTER TABLE MED.TPRICE_MONITOR_BASE ADD CONSTRAINT UK_TPRICE_MONITOR_BASE_ID
  UNIQUE (
  FK_ID
)
/

ALTER TABLE MED.TPRICE_MONITOR_OST ADD CONSTRAINT FK_TPRICE_MONITOR_BASE_ID
  FOREIGN KEY (
FK_TPRICE_MONITOR_BASE_ID
)
 REFERENCES MED.TPRICE_MONITOR_BASE
 (
FK_ID
) 
/
